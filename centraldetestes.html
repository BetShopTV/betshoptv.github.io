
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Central de Testes BSTV 11</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f0e9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-top: 1rem;
    }
    h2 {
      margin-top: 1rem;
      padding-left: 0.5rem;
    }
    .summary {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin: 0 1rem;
    }
    .piece-card {
      width: 110px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      padding: 0.25rem;
      cursor: pointer;
      text-align: center;
    }
    .piece-card.selected {
      border-color: #4caf50;
    }
    .piece-card img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    .rifa-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.3rem;
      margin: 0 1rem;
      margin-bottom: 1rem;
    }
    .rifa-btn {
      padding: 0.3rem 0.4rem;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      color: #fff;
    }
    .rifa-btn.selected {
      box-shadow: 0 0 0 2px #333 inset;
    }
    .total {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 1rem;
    }
    .fields {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .fields input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .actions {
      text-align: center;
      margin-bottom: 2rem;
    }
    .primary-btn, .secondary-btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .primary-btn {
      background-color: #e35d5b;
      color: white;
    }
    .secondary-btn {
      background-color: #267ba5;
      color: white;
    }
    #pixSection {
      display: none;
      text-align: center;
      margin-top: 1rem;
    }
    #qrCode {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>Central de Testes BSTV 11</h1>
  <div class="summary" id="totais">TOTAL PEÇAS: 0 | TOTAL RIFAS: 0</div>

  <h2>PEÇAS</h2>
  <div class="grid" id="piecesGrid"></div>

  <h2>RIFAS SUGERIDAS</h2>
  <div class="rifa-buttons" id="rifasGrid"></div>

  <div class="total" id="totalCash">TOTAL CASH: R$ 0,00</div>
  <div class="fields">
    <input type="text" id="nomeInput" placeholder="Nome" />
    <input type="email" id="emailInput" placeholder="E-mail" />
    <input type="tel" id="foneInput" placeholder="Telefone (opcional)" />
  </div>
  <div class="actions">
    <button class="primary-btn" id="gerarPixBtn">GERAR PIX</button>
    <button class="secondary-btn" id="copiaPixBtn" style="display:none;">Copiar código PIX</button>
    <div id="pixSection">
      <div id="pixCode" style="margin-top:1rem;"></div>
      <div id="qrCode"></div>
    </div>
  </div>
  <div class="actions">
    <button class="secondary-btn" id="apostaBtn">APOSTA!</button>
  </div>

  <!-- Formulário oculto para envio via FormSubmit -->
  <!-- Esta versão utiliza apenas o endpoint hashado do FormSubmit, assim como em rifas.html. -->
  <form id="hiddenForm" action="https://formsubmit.co/b7c03bfd6671addd4ddd857cb7e53d3d" method="POST" style="display:none;">
    <input type="hidden" name="pecas" />
    <input type="hidden" name="rifas" />
    <input type="hidden" name="favoritas" />
    <input type="hidden" name="total" />
    <input type="hidden" name="nome" />
    <input type="hidden" name="email" />
    <input type="hidden" name="telefone" />
    <!-- Configurações do FormSubmit -->
    <input type="hidden" name="_captcha" value="false" />
    <input type="hidden" name="_subject" value="Nova aposta BSTV" />
    <input type="hidden" name="_template" value="table" />
    <input type="hidden" name="_next" value="https://betshoptv.com/obrigado.html" />
  </form>

  <script>
    // Endpoints dos JSON
    const PECAS_JSON_URL = '/dados/pecas.json';
    const RIFAS_JSON_URL = '/dados/rifas.json';
    const form = document.getElementById('hiddenForm');

    let piecesData = [];
    let rifasData = [];
    let selectedPieces = new Set();
    let selectedRifas = new Set();

    async function loadData() {
      try {
        const pecasResp = await fetch(PECAS_JSON_URL);
        const pecas = await pecasResp.json();
        const rifasResp = await fetch(RIFAS_JSON_URL);
        const rifas = await rifasResp.json();
        piecesData = pecas.filter(p => p.status.toUpperCase() !== 'VENDIDAAA');
        rifasData = rifas.filter(r => !r.status_rifa || String(r.status_rifa).trim() === '');
        document.getElementById('totais').textContent = `TOTAL PEÇAS: ${piecesData.length} | TOTAL RIFAS: ${rifasData.length}`;
        renderPieces();
        renderRifas();
      } catch (err) {
        console.error(err);
      }
    }
    function renderPieces() {
      const grid = document.getElementById('piecesGrid');
      grid.innerHTML = '';
      piecesData.forEach(piece => {
        // Usa o primeiro item da lista de imagens como base para a miniatura
        const firstImg = piece.imagens && piece.imagens.length ? piece.imagens[0] : '';
        const thumbName = firstImg;
        const card = document.createElement('div');
        card.className = 'piece-card';
        card.innerHTML = `
          <img src="img/tmb/${thumbName}.avif" onerror="this.onerror=null;this.src='img/fallback/${thumbName}.jpg';" alt="${piece.titulo}">
          <div style="font-size:0.7rem;margin-top:0.25rem;">${piece.titulo}</div>
          <div style="font-size:0.8rem;font-weight:bold;">R$ ${piece.preco.toFixed(2)}</div>
        `;
        card.addEventListener('click', () => togglePiece(piece.id_peca, card));
        grid.appendChild(card);
      });
    }
    function renderRifas() {
      const grid = document.getElementById('rifasGrid');
      grid.innerHTML = '';
      rifasData.forEach(rifa => {
        const btn = document.createElement('button');
        btn.className = 'rifa-btn';
        btn.textContent = rifa.numero || rifa.id_rifa;
        // Usa hex_rifa (ou hex) como cor de fundo
        btn.style.backgroundColor = rifa.hex_rifa || rifa.hex || '#999';
        btn.addEventListener('click', () => toggleRifa(rifa.id_rifa, btn));
        grid.appendChild(btn);
      });
    }
    function togglePiece(id, element) {
      if (selectedPieces.has(id)) {
        selectedPieces.delete(id);
        element.classList.remove('selected');
      } else {
        selectedPieces.add(id);
        element.classList.add('selected');
      }
      updateTotal();
    }
    function toggleRifa(id, element) {
      if (selectedRifas.has(id)) {
        selectedRifas.delete(id);
        element.classList.remove('selected');
      } else {
        selectedRifas.add(id);
        element.classList.add('selected');
      }
      updateTotal();
    }
    function calculateRifaTotal(count) {
      if (count === 0) return 0;
      // Preço das rifas: par = 25 * n, ímpar = 25 * (n - 1) + 30
      return count % 2 === 0 ? 25 * count : 25 * (count - 1) + 30;
    }
    function updateTotal() {
      const piecesTotal = Array.from(selectedPieces).reduce((sum, id) => {
        const p = piecesData.find(x => x.id_peca === id);
        return sum + (p ? p.preco : 0);
      }, 0);
      const rifasTotal = calculateRifaTotal(selectedRifas.size);
      const total = piecesTotal + rifasTotal;
      document.getElementById('totalCash').textContent = 'TOTAL CASH: R$ ' + total.toFixed(2).replace('.', ',');
    }
    // Função para gerar CRC16-CCITT do BRCode
    function crc16_ccitt(str) {
      let crc = 0xffff;
      for (let i = 0; i < str.length; i++) {
        crc ^= str.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          crc = ((crc << 1) ^ ((crc & 0x8000) ? 0x1021 : 0)) & 0xffff;
        }
      }
      return crc;
    }
    // Gera BR Code/PIX com a chave de e-mail
    function gerarBRCode(valor) {
      const chave = 'betshoptv@gmail.com';
      const payloadFormatIndicator = '000201';
      const merchantAccountInfo = '26';
      const gui = '0014br.gov.bcb.pix';
      const key = String(chave.length).padStart(2, '0') + chave;
      const merchantInfo = merchantAccountInfo + gui + key;
      const transactionAmount = valor.toFixed(2);
      const amount = '540' + String(transactionAmount.length).padStart(2, '0') + transactionAmount;
      const country = '5802BR';
      const merchantCategoryCode = '52040000';
      const transactionCurrency = '5303986';
      const additionalDataField = '62';
      const referenceLabel = '0012NARRATIVA';
      const data = [
        payloadFormatIndicator,
        merchantInfo,
        merchantCategoryCode,
        transactionCurrency,
        country,
        amount,
        additionalDataField + String(referenceLabel.length).padStart(2, '0') + referenceLabel,
        '6304'
      ].join('');
      const crc = crc16_ccitt(data);
      const checksum = crc.toString(16).toUpperCase().padStart(4, '0');
      return data + checksum;
    }
    function showPix() {
      const piecesTotal = Array.from(selectedPieces).reduce((sum, id) => {
        const p = piecesData.find(x => x.id_peca === id);
        return sum + (p ? p.preco : 0);
      }, 0);
      const rifasTotal = calculateRifaTotal(selectedRifas.size);
      const total = piecesTotal + rifasTotal;
      if (total <= 0) {
        alert('Selecione ao menos uma peça ou rifa.');
        return;
      }
      const brCode = gerarBRCode(total);
      document.getElementById('pixCode').textContent = brCode;
      const qrElem = document.getElementById('qrCode');
      qrElem.innerHTML = '';
      new QRCode(qrElem, {
        text: brCode,
        width: 200,
        height: 200
      });
      document.getElementById('pixSection').style.display = 'block';
      document.getElementById('copiaPixBtn').style.display = 'inline-block';
    }
    function copyPix() {
      const pix = document.getElementById('pixCode').textContent;
      navigator.clipboard.writeText(pix).then(() => alert('Código PIX copiado!'));
    }
    function sendCheckout() {
      if (selectedPieces.size === 0 && selectedRifas.size === 0) {
        alert('Selecione ao menos uma peça ou rifa.');
        return;
      }
      const nome = document.getElementById('nomeInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const fone = document.getElementById('foneInput').value.trim();
      const pecasStr = Array.from(selectedPieces).join(',');
      const rifasStr = Array.from(selectedRifas).join(',');
      const totalValor = Array.from(selectedPieces).reduce((sum, id) => {
        const p = piecesData.find(x => x.id_peca === id);
        return sum + (p ? p.preco : 0);
      }, 0) + calculateRifaTotal(selectedRifas.size);
      // Preenche inputs ocultos para FormSubmit
      form.querySelector('input[name="pecas"]').value = pecasStr;
      form.querySelector('input[name="rifas"]').value = rifasStr;
      form.querySelector('input[name="favoritas"]').value = 0;
      form.querySelector('input[name="total"]').value = totalValor.toFixed(2);
      form.querySelector('input[name="nome"]').value = nome;
      form.querySelector('input[name="email"]').value = email;
      form.querySelector('input[name="telefone"]').value = fone;
      // Submete para FormSubmit
      form.submit();
      alert('Aposta enviada! Aguarde nossa confirmação.');
      // Reseta estado local
      selectedPieces.clear();
      selectedRifas.clear();
      renderPieces();
      renderRifas();
      updateTotal();
      document.getElementById('pixSection').style.display = 'none';
      document.getElementById('copiaPixBtn').style.display = 'none';
    }
    document.getElementById('gerarPixBtn').addEventListener('click', showPix);
    document.getElementById('copiaPixBtn').addEventListener('click', copyPix);
    document.getElementById('apostaBtn').addEventListener('click', sendCheckout);
    (function() {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
      script.onload = loadData;
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>
