<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Versão 05 da Central de Testes -->
  <title>Central de Testes BSTV 05</title>
  <!-- Biblioteca de QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f6f2ec;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .stats {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.2rem;
    }
    h2 {
      margin-top: 2rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .item {
      position: relative;
      cursor: pointer;
      border: 1px solid #e1d8c9;
      border-radius: 4px;
      overflow: hidden;
    }
    .item img {
      width: 100%;
      height: auto;
      display: block;
    }
    .item.selected {
      outline: 4px solid #b72b32;
    }
    .rifa-button {
      margin: 0.2rem;
      padding: 0.5rem 0.7rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      transition: transform 0.1s;
    }
    .rifa-button.selected {
      transform: scale(0.92);
      filter: brightness(85%);
    }
    #userFields {
      text-align: center;
      margin-bottom: 1rem;
    }
    #userFields input {
      margin: 0.3rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    #gerarPix, #copiarPix, #apostar {
      margin: 0.5rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    #gerarPix {
      background-color: #b72b32;
      color: #fff;
    }
    #copiarPix {
      background-color: #2e704c;
      color: #fff;
      display: none;
    }
    #apostar {
      background-color: #0c5a7a;
      color: #fff;
    }
    #qrcode {
      margin-top: 1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Central de Testes BSTV 05</h1>
  <div class="stats">
    TOTAL PEÇAS: <span id="totalPecas">0</span> |
    TOTAL RIFAS: <span id="totalRifas">0</span>
  </div>
  <h2>PEÇAS</h2>
  <div id="pecasGrid" class="grid"></div>
  <h2>RIFAS SUGERIDAS</h2>
  <div id="rifasGrid" class="grid"></div>
  <div class="stats">TOTAL CASH: R$ <span id="totalCash">0,00</span></div>
  <div id="userFields">
    <input type="text" id="inputNome" placeholder="Nome">
    <input type="email" id="inputEmail" placeholder="E‑mail">
    <input type="tel" id="inputTelefone" placeholder="Telefone (opcional)">
  </div>
  <div style="text-align: center;">
    <button id="gerarPix">GERAR PIX</button>
    <button id="copiarPix">Copiar código PIX</button>
  </div>
  <div id="qrcode"></div>
  <div style="text-align:center; margin-top:1rem;">
    <button id="apostar">APOSTA!</button>
  </div>
  <script>
    // Dados carregados dos JSONs
    let pecasData = [];
    let rifasData = [];
    // Seleções atuais
    let selectedPieces = [];
    let selectedRifas = [];

    // Carrega dados de peças e rifas
    function fetchData() {
      Promise.all([
        fetch('/dados/pecas.json').then(res => res.json()),
        fetch('/dados/rifas.json').then(res => res.json())
      ]).then(([pecas, rifas]) => {
        pecasData = pecas;
        rifasData = rifas;
        updateStats();
        renderData();
      }).catch(err => {
        console.error('Erro ao carregar JSONs', err);
      });
    }

    // Atualiza contagem de peças e rifas disponíveis
    function updateStats() {
      const availPieces = pecasData.filter(p => {
        const status = p.status ? p.status.toString().trim().toLowerCase() : '';
        return !status || status === 'disponivel';
      });
      const availRifas = rifasData.filter(r => {
        const st = r.status_rifa ? r.status_rifa.toString().trim() : '';
        return st === '';
      });
      document.getElementById('totalPecas').textContent = availPieces.length;
      document.getElementById('totalRifas').textContent = availRifas.length;
    }

    // Renderiza peças e rifas
    function renderData() {
      const gridPecas = document.getElementById('pecasGrid');
      gridPecas.innerHTML = '';
      pecasData.forEach(p => {
        const status = p.status ? p.status.toString().trim().toLowerCase() : '';
        if (!status || status === 'disponivel') {
          // pega primeiro id de imagem
          let thumbId = '';
          if (Array.isArray(p.imagens) && p.imagens.length > 0) {
            thumbId = p.imagens[0].toString().trim();
          } else if (typeof p.imagens === 'string' && p.imagens.trim()) {
            thumbId = p.imagens.split(/[;,]/)[0].trim();
          }
          if (!thumbId) return;
          // sempre usa sufixo 'a' para miniaturas
          const thumbSrc = 'img/tmb/' + thumbId + 'a.avif';
          const fallbackSrc = 'img/fallback/' + thumbId + 'a.jpg';
          const div = document.createElement('div');
          div.className = 'item';
          const img = document.createElement('img');
          img.src = thumbSrc;
          img.alt = p.titulo || p.id_peca;
          img.onerror = function() {
            img.src = fallbackSrc;
          };
          div.appendChild(img);
          div.addEventListener('click', () => { togglePieceSelection(div, p); });
          gridPecas.appendChild(div);
        }
      });
      // Renderiza rifas disponíveis
      const rifaGrid = document.getElementById('rifasGrid');
      rifaGrid.innerHTML = '';
      const available = rifasData.filter(r => {
        const st = r.status_rifa ? r.status_rifa.toString().trim() : '';
        return st === '';
      });
      available.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'rifa-button';
        // cor de fundo a partir do hex
        if (r.hex_rifa) {
          btn.style.backgroundColor = r.hex_rifa.startsWith('#') ? r.hex_rifa : '#' + r.hex_rifa;
        } else if (r.hex) {
          btn.style.backgroundColor = r.hex.startsWith('#') ? r.hex : '#' + r.hex;
        } else {
          btn.style.backgroundColor = '#666';
        }
        // texto do botão: numero ou id
        btn.textContent = r.numero || r.id_rifa;
        btn.addEventListener('click', () => { toggleRifaSelection(btn, r); });
        rifaGrid.appendChild(btn);
      });
    }

    // Seleciona/desseleciona peça
    function togglePieceSelection(elem, piece) {
      const idx = selectedPieces.indexOf(piece);
      if (idx === -1) {
        selectedPieces.push(piece);
        elem.classList.add('selected');
      } else {
        selectedPieces.splice(idx, 1);
        elem.classList.remove('selected');
      }
      updateTotal();
    }

    // Seleciona/desseleciona rifa
    function toggleRifaSelection(btn, rifa) {
      const idx = selectedRifas.indexOf(rifa);
      if (idx === -1) {
        selectedRifas.push(rifa);
        btn.classList.add('selected');
      } else {
        selectedRifas.splice(idx, 1);
        btn.classList.remove('selected');
      }
      updateTotal();
    }

    // Atualiza preço total (peças + rifas)
    function updateTotal() {
      let total = 0;
      // soma preços das peças
      selectedPieces.forEach(p => {
        const valor = parseFloat(String(p.preco).replace('.', '').replace(',', '.'));
        if (!isNaN(valor)) total += valor;
      });
      // soma preço das rifas conforme tabela 30/50/80/100...
      const n = selectedRifas.length;
      if (n > 0) {
        if (n % 2 === 0) {
          total += 25 * n;
        } else {
          total += 25 * (n - 1) + 30;
        }
      }
      document.getElementById('totalCash').textContent = total.toFixed(2).replace('.', ',');
    }

    // Funções para gerar BR Code (mesmo modelo das rifas)
    function crc16_ccitt(buf) {
      let crc = 0xffff;
      for (let b of buf) {
        crc ^= b << 8;
        for (let i = 0; i < 8; i++) {
          if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
          else crc <<= 1;
          crc &= 0xffff;
        }
      }
      return crc.toString(16).padStart(4, '0').toUpperCase();
    }
    function gerarBRCode(valor) {
      // Chave PIX fixa – ajuste conforme sua chave
      const chave = '00020101021126360014BR.GOV.BCB.PIX0114+55119999999940214Pagador BSTV52040000530398654';
      const valorStr = Number(valor).toFixed(2);
      const txtValor = valorStr.replace('.', '');
      const emv = `${chave}${txtValor}5802BR5926BetShopTV – Arte & Rifas6008SAO PAULO62070503***`;
      const crc = crc16_ccitt((emv + '6304').split('').map(ch => ch.charCodeAt(0)));
      return emv + '6304' + crc;
    }

    // Botão GERAR PIX
    document.getElementById('gerarPix').addEventListener('click', () => {
      const totalValor = parseFloat(document.getElementById('totalCash').textContent.replace(',', '.'));
      if (isNaN(totalValor) || totalValor <= 0) {
        alert('Adicione peças ou rifas antes de gerar o PIX.');
        return;
      }
      const brcode = gerarBRCode(totalValor);
      const qrDiv = document.getElementById('qrcode');
      qrDiv.innerHTML = '';
      new QRCode(qrDiv, { text: brcode, width: 200, height: 200 });
      const copiar = document.getElementById('copiarPix');
      copiar.style.display = 'inline-block';
      copiar.onclick = () => {
        navigator.clipboard.writeText(brcode).then(() => {
          copiar.textContent = 'Copiado!';
          setTimeout(() => { copiar.textContent = 'Copiar código PIX'; }, 2000);
        });
      };
    });

    // Botão APOSTA – envia compra ao Apps Script
    document.getElementById('apostar').addEventListener('click', () => {
      const totalValor = parseFloat(document.getElementById('totalCash').textContent.replace(',', '.'));
      if (isNaN(totalValor) || totalValor <= 0) {
        alert('Carrinho vazio. Selecione peças ou rifas antes de apostar.');
        return;
      }
      const nome = document.getElementById('inputNome').value.trim();
      const email = document.getElementById('inputEmail').value.trim();
      const tel = document.getElementById('inputTelefone').value.trim();
      // monta payload com ids das peças e rifas
      const payload = {
        pecas: selectedPieces.map(p => p.id_peca).join(','),
        rifas: selectedRifas.map(r => r.id_rifa).join(','),
        favoritas: 0,
        total: totalValor.toFixed(2),
        nome: nome,
        email: email,
        telefone: tel
      };
      // URL do Apps Script (substitua pelo seu ID)
      const endpoint = 'https://script.google.com/macros/s/AKfycbwOeHsHlwj_-lBpRKOPGq5GSkzslBS23tKhTwGLKwBICPeZGZ2_SVRxVEWqXNzhmcbY/exec';
      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'no-cors'
      }).then(() => {
        alert('Aposta enviada! Aguarde a confirmação na planilha.');
        // limpa seleção
        selectedPieces = [];
        selectedRifas = [];
        document.querySelectorAll('.item.selected').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.rifa-button.selected').forEach(el => el.classList.remove('selected'));
        updateTotal();
      }).catch(err => {
        alert('Falha ao enviar: ' + err);
      });
    });

    // Inicializa carregamento
    fetchData();
  </script>
</body>
</html>
