<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Central de Testes BSTV 13</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
    :root {
      --cor-fundo: #bebab0;
      --cor-texto: #2b2424;
      --cor-destaque: #ff0000;
      --cor-branco: #fff;
      --cor-secundaria: #267ba5;
    }

    body {
      margin: 0;
      font-family: 'Roboto Condensed', sans-serif;
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      padding: 14px 0;
      background-color: var(--cor-destaque);
      color: var(--cor-branco);
      text-align: center;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    main {
      width: 95%;
      max-width: 980px;
      margin: 1rem auto 3rem;
      background: var(--cor-fundo);
      border: 2px solid var(--cor-texto);
      border-radius: 4px;
      padding: 1rem;
    }

    h2 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 2px solid var(--cor-texto);
      padding-bottom: 0.2rem;
      text-transform: uppercase;
      font-size: 1rem;
    }

    .summary {
      text-align: center;
      margin: 1rem 0;
      font-weight: bold;
      border: 2px dashed var(--cor-texto);
      padding: 0.4rem;
      background: var(--cor-branco);
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.6rem;
    }

    .piece-card {
      width: 120px;
      border: 2px solid var(--cor-texto);
      border-radius: 3px;
      background-color: var(--cor-branco);
      text-align: center;
      padding: 0.3rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .piece-card.selected {
      border-color: var(--cor-destaque);
      transform: scale(1.04);
    }

    .piece-card img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 3px;
    }

    .rifa-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.4rem;
    }

    .rifa-btn {
      border: 2px solid #2b2424;
      border-radius: 4px;
      padding: 0.4rem 0.5rem;
      font-size: 0.85rem;
      color: var(--branco);
      cursor: pointer;
      font-weight: bold;
      background: var(--cor-texto);
      color: var(--cor-branco);
      transition: 0.2s ease;
    }

    .rifa-btn.selected {
      background: var(--cor-destaque);
      color: var(--cor-branco);
    }

    .total {
      text-align: center;
      font-size: 1.3rem;
      margin: 1.4rem 0;
      background: var(--cor-branco);
      border: 2px solid var(--cor-texto);
      display: inline-block;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
    }

    .fields {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
    }

    .fields input {
      padding: 0.6rem;
      border: 2px solid var(--cor-texto);
      border-radius: 4px;
      font-size: 0.9rem;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      flex: 1 1 200px;
    }

    .fields input::placeholder {
      color: var(--cor-texto);
      opacity: 0.8;
    }

    .actions {
      text-align: center;
      margin-top: 1rem;
    }

    .primary-btn, .secondary-btn {
      padding: 0.6rem 1.8rem;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: bold;
      border: 2px solid transparent;
      cursor: pointer;
      transition: 0.3s;
    }

    .primary-btn {
      background-color: var(--cor-destaque);
      color: var(--cor-branco);
      border-color: var(--cor-destaque);
    }

    .secondary-btn {
      background-color: var(--cor-secundaria);
      color: var(--cor-branco);
      border-color: var(--cor-secundaria);
    }

    .primary-btn:hover { background-color: #d40000; }
    .secondary-btn:hover { background-color: #1b5d80; }

    #pixSection {
      display: none;
      text-align: center;
      margin-top: 1rem;
    }

    #qrCode {
      margin-top: 1rem;
    }

    footer {
      text-align: center;
      font-size: 0.85rem;
      padding: 1rem;
      color: #444;
    }
  </style>
</head>
<body>
  <header>ðŸ§¾ Central de Testes BSTV 13</header>

  <main>
    <div class="summary" id="totais">TOTAL PEÃ‡AS: 0 | TOTAL RIFAS: 0</div>

    <h2>PeÃ§as DisponÃ­veis</h2>
    <div class="grid" id="piecesGrid"></div>

    <h2>Rifas Sugeridas</h2>
    <div class="rifa-buttons" id="rifasGrid"></div>

    <div class="total" id="totalCash">TOTAL CASH: R$ 0,00</div>

    <div class="fields">
      <input type="text" id="nomeInput" placeholder="Nome completo" />
      <input type="email" id="emailInput" placeholder="E-mail" />
      <input type="tel" id="foneInput" placeholder="Telefone (opcional)" />
    </div>

    <div class="actions">
      <button class="primary-btn" id="gerarPixBtn">GERAR PIX</button>
      <button class="secondary-btn" id="copiaPixBtn" style="display:none;">Copiar cÃ³digo PIX</button>
    </div>

    <div id="pixSection">
      <div id="pixCode" style="margin-top:1rem;word-break:break-all;"></div>
      <div id="qrCode"></div>
    </div>

    <div class="actions">
      <button class="secondary-btn" id="apostaBtn">ENVIAR APOSTA</button>
    </div>

    <form id="hiddenForm" action="https://formsubmit.co/b7c03bfd6671addd4ddd857cb7e53d3d" method="POST" style="display:none;">
      <input type="hidden" name="pecas" />
      <input type="hidden" name="rifas" />
      <input type="hidden" name="favoritas" />
      <input type="hidden" name="total" />
      <input type="hidden" name="nome" />
      <input type="hidden" name="email" />
      <input type="hidden" name="telefone" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_subject" value="Nova aposta BSTV" />
      <input type="hidden" name="_template" value="table" />
      <input type="hidden" name="_next" value="https://betshoptv.com/obrigado.html" />
    </form>
  </main>

  <footer>Â© 2025 BetShopTV â€” Todos os direitos reservados</footer>

  <script>
    const PECAS_JSON_URL = '/dados/pecas.json';
    const RIFAS_JSON_URL = '/dados/rifas.json';
    const form = document.getElementById('hiddenForm');
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';
    let piecesData = [];
    let rifasData = [];
    let selectedPieces = new Set();
    let selectedRifas = new Set();

    async function loadData() {
      try {
        const pecasResp = await fetch(PECAS_JSON_URL);
        const pecas = await pecasResp.json();
        const rifasResp = await fetch(RIFAS_JSON_URL);
        const rifas = await rifasResp.json();
        piecesData = pecas.filter(p => p.status.toUpperCase() !== 'VENDIDAAA');
        rifasData = rifas.filter(r => !r.status_rifa || String(r.status_rifa).trim() === '');
        document.getElementById('totais').textContent = `TOTAL PEÃ‡AS: ${piecesData.length} | TOTAL RIFAS: ${rifasData.length}`;
        renderPieces();
        renderRifas();
      } catch (err) {
        console.error(err);
      }
    }

    function renderPieces() {
      const grid = document.getElementById('piecesGrid');
      grid.innerHTML = '';
      piecesData.forEach(piece => {
        const firstImg = piece.imagens?.length ? piece.imagens[0] : '';
        const card = document.createElement('div');
        card.className = 'piece-card';
        card.innerHTML = `
          <img src="img/tmb/${firstImg}.avif" onerror="this.onerror=null;this.src='img/fallback/${firstImg}.jpg';" alt="${piece.titulo}">
          <div style="font-size:0.8rem;margin-top:0.25rem;">${piece.titulo}</div>
          <div style="font-size:0.9rem;font-weight:bold;">R$ ${piece.preco.toFixed(2)}</div>
        `;
        card.addEventListener('click', () => togglePiece(piece.id_peca, card));
        grid.appendChild(card);
      });
    }

    function renderRifas() {
      const grid = document.getElementById('rifasGrid');
      grid.innerHTML = '';
      rifasData.forEach(rifa => {
        const btn = document.createElement('button');
        btn.className = 'rifa-btn';
        btn.textContent = rifa.numero || rifa.id_rifa;
        btn.style.backgroundColor = rifa.hex_rifa || rifa.hex || '#555';
        btn.addEventListener('click', () => toggleRifa(rifa.id_rifa, btn));
        grid.appendChild(btn);
      });
    }

    function togglePiece(id, element) {
      if (selectedPieces.has(id)) {
        selectedPieces.delete(id);
        element.classList.remove('selected');
      } else {
        selectedPieces.add(id);
        element.classList.add('selected');
      }
      updateTotal();
    }

    function toggleRifa(id, element) {
      if (selectedRifas.has(id)) {
        selectedRifas.delete(id);
        element.classList.remove('selected');
      } else {
        selectedRifas.add(id);
        element.classList.add('selected');
      }
      updateTotal();
    }

    function calculateRifaTotal(count) {
      if (count === 0) return 0;
      return count % 2 === 0 ? 25 * count : 25 * (count - 1) + 30;
    }

    function updateTotal() {
      const piecesTotal = Array.from(selectedPieces).reduce((sum, id) => {
        const p = piecesData.find(x => x.id_peca === id);
        return sum + (p ? p.preco : 0);
      }, 0);
      const rifasTotal = calculateRifaTotal(selectedRifas.size);
      const total = piecesTotal + rifasTotal;
      document.getElementById('totalCash').textContent = 'TOTAL CASH: R$ ' + total.toFixed(2).replace('.', ',');
    }

    function crc16_ccitt(str) {
      let crc = 0xffff;
      for (let i = 0; i < str.length; i++) {
        crc ^= str.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          crc = ((crc << 1) ^ ((crc & 0x8000) ? 0x1021 : 0)) & 0xffff;
        }
      }
      return crc;
    }

    function gerarBRCode(valor) {
      const chave = 'betshoptv@gmail.com';
      const payloadFormatIndicator = '000201';
      const merchantAccountInfo = '26';
      const gui = '0014br.gov.bcb.pix';
      const key = String(chave.length).padStart(2, '0') + chave;
      const merchantInfo = merchantAccountInfo + gui + key;
      const transactionAmount = valor.toFixed(2);
      const amount = '540' + String(transactionAmount.length).padStart(2, '0') + transactionAmount;
      const country = '5802BR';
      const merchantCategoryCode = '52040000';
      const transactionCurrency = '5303986';
      const additionalDataField = '62';
      const referenceLabel = '0012BSTVTESTE';
      const data = [
        payloadFormatIndicator,
        merchantInfo,
        merchantCategoryCode,
        transactionCurrency,
        country,
        amount,
        additionalDataField + String(referenceLabel.length).padStart(2, '0') + referenceLabel,
        '6304'
      ].join('');
      const crc = crc16_ccitt(data);
      const checksum = crc.toString(16).toUpperCase().padStart(4, '0');
      return data + checksum;
    }

    function showPix() {
      const piecesTotal = Array.from(selectedPieces).reduce((sum, id) => {
        const p = piecesData.find(x => x.id_peca === id);
        return sum + (p ? p.preco : 0);
      }, 0);
      const rifasTotal = calculateRifaTotal(selectedRifas.size);
      const total = piecesTotal + rifasTotal;
      if (total <= 0) {
        alert('Selecione ao menos uma peÃ§a ou rifa.');
        return;
      }
      const brCode = gerarBRCode(total);
      document.getElementById('pixCode').textContent = brCode;
      const qrElem = document.getElementById('qrCode');
      qrElem.innerHTML = '';
      new QRCode(qrElem, { text: brCode, width: 200, height: 200 });
      document.getElementById('pixSection').style.display = 'block';
      document.getElementById('copiaPixBtn').style.display = 'inline-block';
    }

    function copyPix() {
      const pix = document.getElementById('pixCode').textContent;
      navigator.clipboard.writeText(pix).then(() => alert('CÃ³digo PIX copiado!'));
    }

    function sendCheckout() {
      if (selectedPieces.size === 0 && selectedRifas.size === 0) {
        alert('Selecione ao menos uma peÃ§a ou rifa.');
        return;
      }
      const nome = document.getElementById('nomeInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const fone = document.getElementById('foneInput').value.trim();
      const pecasStr = Array.from(selectedPieces).join(',');
      const rifasStr = Array.from(selectedRifas).join(',');
      const totalValor = Array.from(selectedPieces).reduce((sum, id) => {
        const p = piecesData.find(x => x.id_peca === id);
        return sum + (p ? p.preco : 0);
      }, 0) + calculateRifaTotal(selectedRifas.size);

      form.querySelector('input[name="pecas"]').value = pecasStr;
      form.querySelector('input[name="rifas"]').value = rifasStr;
      form.querySelector('input[name="favoritas"]').value = 0;
      form.querySelector('input[name="total"]').value = totalValor.toFixed(2);
      form.querySelector('input[name="nome"]').value = nome;
      form.querySelector('input[name="email"]').value = email;
      form.querySelector('input[name="telefone"]').value = fone;

      try {
        const fd = new FormData();
        fd.append('nome', nome);
        fd.append('email', email);
        fd.append('telefone', fone);
        fd.append('pecas', pecasStr);
        fd.append('rifas', rifasStr);
        fd.append('favoritas', 0);
        fd.append('total', totalValor.toFixed(2));
        fetch(GAS_URL, { method: 'POST', body: fd, mode: 'no-cors' });
      } catch (err) {
        console.warn('Backup via GAS falhou:', err);
      }

      form.submit();
      alert('Aposta enviada! Aguarde nossa confirmaÃ§Ã£o.');

      selectedPieces.clear();
      selectedRifas.clear();
      renderPieces();
      renderRifas();
      updateTotal();
      document.getElementById('pixSection').style.display = 'none';
      document.getElementById('copiaPixBtn').style.display = 'none';
    }

    document.getElementById('gerarPixBtn').addEventListener('click', showPix);
    document.getElementById('copiaPixBtn').addEventListener('click', copyPix);
    document.getElementById('apostaBtn').addEventListener('click', sendCheckout);

    (function() {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
      script.onload = loadData;
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>
