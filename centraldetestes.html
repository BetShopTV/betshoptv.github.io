<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central de Testes BSTV 07</title>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f6f2ec;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .stats {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 1.2rem;
    }
    h2 {
      margin-top: 2rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .item {
      position: relative;
      cursor: pointer;
      border: 1px solid #e1d8c9;
      border-radius: 4px;
      overflow: hidden;
    }
    .item img {
      width: 100%;
      height: auto;
      display: block;
    }
    .item.selected {
      outline: 3px solid #b72b32;
    }
    .rifa-button {
      margin: 0.2rem;
      padding: 0.5rem 0.7rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      transition: transform 0.1s;
    }
    .rifa-button.selected {
      transform: scale(0.92);
      filter: brightness(85%);
    }
    #userFields {
      text-align: center;
      margin-bottom: 1rem;
    }
    #userFields input {
      margin: 0.3rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    #gerarPix, #copiarPix, #apostar {
      margin: 0.5rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }
    #gerarPix { background-color: #b72b32; color: #fff; }
    #copiarPix { background-color: #2e704c; color: #fff; display: none; }
    #apostar { background-color: #0c5a7a; color: #fff; }
    #qrcode { margin-top: 1rem; text-align: center; }
  </style>
</head>
<body>
  <h1>Central de Testes BSTV 07</h1>
  <div class="stats">
    TOTAL PEÇAS: <span id="totalPecas">0</span> |
    TOTAL RIFAS: <span id="totalRifas">0</span>
  </div>
  <h2>PEÇAS</h2>
  <div id="pecasGrid" class="grid"></div>
  <h2>RIFAS SUGERIDAS</h2>
  <div id="rifasGrid" class="grid"></div>
  <div class="stats">TOTAL CASH: R$ <span id="totalCash">0,00</span></div>
  <div id="userFields">
    <input type="text" id="inputNome" placeholder="Nome" />
    <input type="email" id="inputEmail" placeholder="E‑mail" />
    <input type="tel" id="inputTelefone" placeholder="Telefone (opcional)" />
  </div>
  <div style="text-align:center;">
    <button id="gerarPix">GERAR PIX</button>
    <button id="copiarPix">Copiar código PIX</button>
  </div>
  <div id="qrcode"></div>
  <div style="text-align:center; margin-top:1rem;">
    <button id="apostar">APOSTA!</button>
  </div>
  <!-- Formulário oculto para envio via FormSubmit -->
  <form id="checkoutForm" action="https://formsubmit.co/bstv.database@gmail.com" method="POST" style="display:none;">
    <input type="hidden" name="pecas" />
    <input type="hidden" name="rifas" />
    <input type="hidden" name="favoritas" />
    <input type="hidden" name="total" />
    <input type="hidden" name="nome" />
    <input type="hidden" name="email" />
    <input type="hidden" name="telefone" />
    <!-- desativa captcha automático -->
    <input type="hidden" name="_captcha" value="false" />
    <!-- define assunto do email -->
    <input type="hidden" name="_subject" value="Nova aposta na Central BSTV" />
    <!-- redireciona para uma página de agradecimento se desejar -->
    <input type="hidden" name="_next" value="https://betshoptv.com/obrigado.html" />
  </form>
  <script>
    let pecasData = [];
    let rifasData = [];
    let selectedPieces = [];
    let selectedRifas = [];

    function fetchData() {
      Promise.all([
        fetch('/dados/pecas.json').then(r => r.ok ? r.json() : []),
        fetch('/dados/rifas.json').then(r => r.ok ? r.json() : [])
      ]).then(([pecas, rifas]) => {
        pecasData = Array.isArray(pecas) ? pecas : [];
        rifasData = Array.isArray(rifas) ? rifas : [];
        updateStats();
        renderData();
      }).catch(err => {
        console.error('Erro ao carregar JSONs', err);
      });
    }
    function updateStats() {
      const availPieces = pecasData.filter(p => {
        const st = p.status ? p.status.toString().trim().toLowerCase() : '';
        return !st || st === 'disponivel';
      });
      const availRifas = rifasData.filter(r => {
        const st = r.status_rifa ? r.status_rifa.toString().trim() : '';
        return st === '';
      });
      document.getElementById('totalPecas').textContent = availPieces.length;
      document.getElementById('totalRifas').textContent = availRifas.length;
    }
    function renderData() {
      const pecasGrid = document.getElementById('pecasGrid');
      pecasGrid.innerHTML = '';
      pecasData.forEach(p => {
        const st = p.status ? p.status.toString().trim().toLowerCase() : '';
        if (!st || st === 'disponivel') {
          let imgId = '';
          if (Array.isArray(p.imagens) && p.imagens.length > 0) {
            imgId = (p.imagens[0] || '').toString().trim();
          } else if (typeof p.imagens === 'string' && p.imagens.trim()) {
            imgId = p.imagens.split(/[;,]/)[0].trim();
          }
          if (!imgId) return;
          // sempre usa a primeira imagem e adiciona .avif
          const thumbSrc = 'img/tmb/' + imgId + '.avif';
          const fallbackSrc = 'img/fallback/' + imgId + '.jpg';
          const div = document.createElement('div');
          div.className = 'item';
          const img = document.createElement('img');
          img.src = thumbSrc;
          img.alt = p.titulo || p.id_peca;
          img.onerror = function() {
            img.src = fallbackSrc;
          };
          div.appendChild(img);
          div.addEventListener('click', () => { togglePiece(div, p); });
          pecasGrid.appendChild(div);
        }
      });
      const rifasGrid = document.getElementById('rifasGrid');
      rifasGrid.innerHTML = '';
      const availRifas = rifasData.filter(r => {
        const st = r.status_rifa ? r.status_rifa.toString().trim() : '';
        return st === '';
      });
      availRifas.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'rifa-button';
        const color = r.hex_rifa || r.hex || '';
        if (color) {
          btn.style.backgroundColor = color.startsWith('#') ? color : '#' + color;
        } else {
          btn.style.backgroundColor = '#666';
        }
        btn.textContent = r.numero || r.id_rifa;
        btn.addEventListener('click', () => { toggleRifa(btn, r); });
        rifasGrid.appendChild(btn);
      });
    }
    function togglePiece(elem, p) {
      const i = selectedPieces.indexOf(p);
      if (i === -1) {
        selectedPieces.push(p);
        elem.classList.add('selected');
      } else {
        selectedPieces.splice(i, 1);
        elem.classList.remove('selected');
      }
      updateTotal();
    }
    function toggleRifa(btn, r) {
      const i = selectedRifas.indexOf(r);
      if (i === -1) {
        selectedRifas.push(r);
        btn.classList.add('selected');
      } else {
        selectedRifas.splice(i, 1);
        btn.classList.remove('selected');
      }
      updateTotal();
    }
    function updateTotal() {
      let total = 0;
      selectedPieces.forEach(p => {
        const val = parseFloat(String(p.preco).replace(/\./g, '').replace(',', '.'));
        if (!isNaN(val)) total += val;
      });
      const n = selectedRifas.length;
      if (n > 0) {
        if (n % 2 === 0) {
          total += 25 * n;
        } else {
          total += 25 * (n - 1) + 30;
        }
      }
      document.getElementById('totalCash').textContent = total.toFixed(2).replace('.', ',');
    }
    function crc16_ccitt(buf) {
      let crc = 0xffff;
      for (let b of buf) {
        crc ^= b << 8;
        for (let i = 0; i < 8; i++) {
          if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
          else crc <<= 1;
          crc &= 0xffff;
        }
      }
      return crc.toString(16).padStart(4, '0').toUpperCase();
    }
    function gerarBRCode(valor) {
      const chavePix = '00020101021126360014BR.GOV.BCB.PIX0114+55119999999940214Pagador BSTV52040000530398654';
      const valorStr = Number(valor).toFixed(2);
      const txtValor = valorStr.replace('.', '');
      const emv = `${chavePix}${txtValor}5802BR5926BetShopTV – Arte & Rifas6008SAO PAULO62070503***`;
      const crc = crc16_ccitt((emv + '6304').split('').map(ch => ch.charCodeAt(0)));
      return emv + '6304' + crc;
    }
    document.getElementById('gerarPix').addEventListener('click', () => {
      const totalStr = document.getElementById('totalCash').textContent;
      const valor = parseFloat(totalStr.replace('.', '').replace(',', '.'));
      if (!valor || valor <= 0) {
        alert('Selecione pelo menos uma peça ou rifa antes de gerar o PIX.');
        return;
      }
      const brcode = gerarBRCode(valor);
      const qrDiv = document.getElementById('qrcode');
      qrDiv.innerHTML = '';
      new QRCode(qrDiv, { text: brcode, width: 200, height: 200 });
      const btnCopy = document.getElementById('copiarPix');
      btnCopy.style.display = 'inline-block';
      btnCopy.onclick = () => {
        navigator.clipboard.writeText(brcode).then(() => {
          btnCopy.textContent = 'Copiado!';
          setTimeout(() => { btnCopy.textContent = 'Copiar código PIX'; }, 2000);
        });
      };
    });
    document.getElementById('apostar').addEventListener('click', () => {
      const totalStr = document.getElementById('totalCash').textContent;
      const valor = parseFloat(totalStr.replace('.', '').replace(',', '.'));
      if (!valor || valor <= 0) {
        alert('Carrinho vazio. Selecione itens antes de apostar.');
        return;
      }
      const nome = document.getElementById('inputNome').value.trim();
      const email = document.getElementById('inputEmail').value.trim();
      const tel = document.getElementById('inputTelefone').value.trim();
      // Preenche os campos do formulário
      const form = document.getElementById('checkoutForm');
      form.elements['pecas'].value = selectedPieces.map(p => p.id_peca).join(',');
      form.elements['rifas'].value = selectedRifas.map(r => r.id_rifa).join(',');
      form.elements['favoritas'].value = '0';
      form.elements['total'].value = valor.toFixed(2);
      form.elements['nome'].value = nome;
      form.elements['email'].value = email;
      form.elements['telefone'].value = tel;
      form.submit();
      // limpa seleção local
      selectedPieces = [];
      selectedRifas = [];
      document.querySelectorAll('.item.selected').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('.rifa-button.selected').forEach(el => el.classList.remove('selected'));
      updateTotal();
    });
    fetchData();
  </script>
</body>
</html>
