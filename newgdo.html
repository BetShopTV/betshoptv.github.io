<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GDO01 • Integração centraldetestes + Checkout PIX</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --radius: 16px; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; --brand:#111827; --rose:#ff0000; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin:0; color:var(--ink); background:var(--bg); }
    header { position:sticky; top:0; z-index:50; backdrop-filter:saturate(180%) blur(10px); background:rgba(248,250,252,0.7); border-bottom:1px solid var(--line); }
    header .bar { display:flex; gap:10px; align-items:center; padding:12px 16px; flex-wrap:wrap; }
    .tag { font-size:12px; background:#e2e8f0; padding:4px 8px; border-radius:999px; }
    main { max-width:1200px; margin:24px auto; padding:0 16px 120px; }
    .actions { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:12px 0 20px; }
    input[type="search"], select { padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:white; min-width:220px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .card { background:#fff; border:1px solid var(--line); border-radius: var(--radius); overflow:hidden; display:flex; flex-direction:column; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .thumb { aspect-ratio: 4/3; background:#f1f5f9; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { width:100%; height:100%; object-fit:cover; }
    .content { padding:14px; display:flex; flex-direction:column; gap:8px; }
    .title { font-weight:600; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .price { display:flex; gap:8px; align-items:baseline; }
    .price .now { font-size:20px; font-weight:700; color:#111827; }
    .price .was { color:#6b7280; text-decoration: line-through; font-size:12px; }
    .meta { color:#475569; font-size:12px; }
    .btnrow { display:flex; gap:8px; margin-top:auto; }
    .btn { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .iconbtns { display:flex; gap:6px; }
    .icon { border:1px solid #cbd5e1; background:#fff; border-radius:10px; padding:8px; cursor:pointer; min-width:40px; min-height:40px; display:grid; place-items:center; }
    .icon.active { background:#111827; color:#fff; border-color:#111827; }
    .icon svg { width:18px; height:18px; }
    .footer { position:fixed; left:0; right:0; bottom:0; border-top:1px solid var(--line); background:#fff; padding:10px 16px; }
    .footer .row { max-width:1200px; margin:0 auto; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .pill { background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-weight:600; }
    .favbar { position:fixed; right:16px; bottom:86px; background:#0f172a; color:#fff; border-radius:14px; padding:10px 12px; box-shadow:0 8px 30px rgba(2,6,23,.3); max-width: 60vw; }
    .favbar h4 { margin:0 0 8px; font-size:13px; font-weight:700; letter-spacing:.02em; text-transform:uppercase; opacity:.9; }
    .favlist { display:flex; gap:8px; overflow:auto; }
    .favchip { background:#111827; border:1px solid #475569; white-space:nowrap; padding:6px 10px; border-radius:999px; font-size:12px; display:flex; align-items:center; gap:6px; }
    .muted { color:#64748b; }
    .hidden { display:none !important; }
    .sr { position:absolute; left:-9999px; }

    /* CHECKOUT */
    dialog.checkout { width:min(860px, 96vw); border:1px solid var(--line); border-radius:16px; padding:0; }
    .co-head { padding:14px 16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
    .co-body { display:grid; grid-template-columns: 1.2fr .8fr; gap:0; min-height: 420px; }
    .co-col { padding:16px; }
    .co-aside { border-left:1px solid var(--line); background:#f9fafb; }
    .row { display:flex; gap:10px; margin:.5rem 0; }
    .row input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:white; }
    .hr { border-top:1px dashed #cbd5e1; margin:12px 0; }
    .qr { background:#fff; border:1px dashed #cbd5e1; border-radius:12px; padding:10px; min-height: 190px; display:flex; align-items:center; justify-content:center; }
    .btn.copy { width:100%; }
    .co-foot { padding:12px 16px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end; }
    .small { font-size:12px; }

    @media (max-width: 860px){ .co-body{ grid-template-columns: 1fr; } .co-aside{ border-left:none; border-top:1px solid var(--line);} }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>Integração</strong>
      <span class="tag">centraldetestes → gdo01</span>
      <span class="tag" id="testeStatus">Checkout com PIX dinâmico</span>
      <span class="muted">Fonte: /dados/pecas.json • /dados/rifas.json</span>
    </div>
  </header>

  <main>
    <div class="actions">
      <input id="search" type="search" placeholder="Buscar peças…" />
      <select id="sort">
        <option value="relevancia">Ordenar por: Relevância</option>
        <option value="preco_asc">Preço: menor → maior</option>
        <option value="preco_desc">Preço: maior → menor</option>
      </select>
      <span id="count" class="muted"></span>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Rodapé geral de compras (gdo01) -->
  <div class="footer" id="rodapeCompras">
    <div class="row">
      <div>
        <strong id="carrinhoQtd">0</strong> itens • <span>Total:</span> <span id="carrinhoTotal" class="pill">R$ 0,00</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="verFavoritos">Ver favoritos</button>
        <button class="btn primary" id="finalizarCompra">Finalizar compra</button>
      </div>
    </div>
  </div>

  <!-- Barra de favoritos/likes -->
  <aside class="favbar hidden" id="favbar">
    <h4>Selecionados</h4>
    <div id="favlist" class="favlist"></div>
  </aside>

  <!-- CHECKOUT MODAL -->
  <dialog class="checkout" id="dlgCheckout">
    <div class="co-head">
      <strong>Fechamento de compra</strong>
      <button class="btn" id="btnFecharCO">Fechar</button>
    </div>
    <div class="co-body">
      <div class="co-col">
        <h3>Seus dados</h3>
        <div class="row"><input id="coNome" placeholder="Nome" required><input id="coEmail" type="email" placeholder="E-mail" required></div>
        <div class="row"><input id="coWhats" placeholder="Telefone / WhatsApp"></div>
        <div class="hr"></div>
        <h3>Itens</h3>
        <div id="coItens" class="small"></div>
      </div>
      <div class="co-col co-aside">
        <h3>Pagamento (PIX)</h3>
        <div class="qr" id="qrArea"><em class="muted">Geraremos o QR ao lado quando houver itens</em></div>
        <div class="row"><button class="btn copy" id="btnCopiarPIX">PIX COPIA e COLA</button></div>
        <div class="small muted">Valor: <strong id="coTotal">R$ 0,00</strong></div>
      </div>
    </div>
    <div class="co-foot">
      <button class="btn" id="btnVoltarCO">Voltar</button>
      <button class="btn primary" id="btnEnviarCO">Enviar pedido</button>
    </div>
  </dialog>

  <template id="tpl-card">
    <article class="card" data-id="">
      <div class="thumb">
        <img alt="" loading="lazy" />
      </div>
      <div class="content">
        <div class="title"></div>
        <div class="price">
          <span class="now"></span>
          <span class="was"></span>
        </div>
        <div class="meta"></div>
        <div class="btnrow">
          <button class="btn add">Adicionar</button>
          <div class="iconbtns">
            <button class="icon like" title="Like" aria-pressed="false" aria-label="Dar like">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-6 0v4"></path><path d="M5 15h8a4 4 0 0 0 4-4 2 2 0 0 0-2-2H7l-2 6z"></path></svg>
            </button>
            <button class="icon fav" title="Favorito" aria-pressed="false" aria-label="Favoritar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 1 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
            </button>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
  /**
   * ⚙️ CONFIG
   */
  const JSON_PECAS_URL = './dados/pecas.json';
  const JSON_RIFAS_URL = './dados/rifas.json';
  const GAS_CHECKOUT_URL = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';

  // Mapeamento: pecas.json
  // Campos reais: id_peca, titulo, preco, status, tecnica, dimensao, imagens (array)
  const FIELD = {
    id: 'id_peca',
    titulo: 'titulo',
    preco: 'preco',
    status: 'status',
    tecnica: 'tecnica',
    dimensao: 'dimensao',
    imagens: 'imagens',
  };

  // Estado ----------------------------------------------------------------------
  const state = {
    items: [],      // itens normalizados
    filtered: [],   // itens após busca/ordenação
    carrinho: new Map(), // id -> qtd
    likes: new Set(JSON.parse(localStorage.getItem('gdo01:likes') || '[]')),
    favs: new Set(JSON.parse(localStorage.getItem('gdo01:favs') || '[]')),
    rifas: [],      // cores / info complementares
    pixPayload: '',
    qrCode: null,
  };

  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const $ = (sel, root=document) => root.querySelector(sel);
  const brl = n => (isFinite(n) ? n : 0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });

  function persistReacoes(){
    localStorage.setItem('gdo01:likes', JSON.stringify([...state.likes]));
    localStorage.setItem('gdo01:favs', JSON.stringify([...state.favs]));
  }

  function normalizeItem(raw){
    const id = raw[FIELD.id];
    const titulo = raw[FIELD.titulo];
    const preco = Number(raw[FIELD.preco]) || 0;
    const status = (raw[FIELD.status]||'').toString().trim().toUpperCase();
    const imagens = Array.isArray(raw[FIELD.imagens]) ? raw[FIELD.imagens] : [];
    return {
      id, titulo, preco, status,
      tecnica: raw[FIELD.tecnica] || '',
      dimensao: raw[FIELD.dimensao] || '',
      imagem: imagens.length ? resolveImagem(imagens[0]) : '',
      imagens: imagens.map(resolveImagem),
      categoria: '', loja: '', url: '#', estoque: status === 'VENDIDAAA' ? false : true,
    };
  }

  function resolveImagem(code){
    // ajuste este padrão se seu repositório tiver outra pasta/extensão
    return `./imagens/${code}.jpg`;
  }

  // Render ----------------------------------------------------------------------
  function renderList(){
    const grid = $('#grid');
    grid.innerHTML = '';
    for (const item of state.filtered){
      const node = $('#tpl-card').content.firstElementChild.cloneNode(true);
      node.dataset.id = item.id;
      const img = $('img', node);
      if (item.imagem) { img.src = item.imagem; img.alt = item.titulo; } else { img.alt = 'Sem imagem'; }
      $('.title', node).textContent = item.titulo;
      $('.now', node).textContent = brl(item.preco);
      const was = $('.was', node); was.remove();
      const meta = $('.meta', node);
      meta.textContent = [item.dimensao, item.tecnica, item.estoque ? 'Em estoque' : 'Vendido'].filter(Boolean).join(' • ');

      const likeBtn = $('.icon.like', node);
      const favBtn  = $('.icon.fav', node);
      if (state.likes.has(item.id)) likeBtn.classList.add('active'), likeBtn.setAttribute('aria-pressed','true');
      if (state.favs.has(item.id))  favBtn.classList.add('active'),  favBtn.setAttribute('aria-pressed','true');

      likeBtn.addEventListener('click', () => toggleLike(item.id, likeBtn));
      favBtn.addEventListener('click',  () => toggleFav(item.id, favBtn));
      $('.btn.add', node).addEventListener('click', () => addToCart(item.id));

      grid.appendChild(node);
    }
    $('#count').textContent = `${state.filtered.length} itens`;
  }

  function renderFavbar(){
    const bar = $('#favbar');
    const list = $('#favlist');
    list.innerHTML = '';
    const selected = state.items.filter(x => state.favs.has(x.id) || state.likes.has(x.id));
    if (!selected.length) { bar.classList.add('hidden'); return; }
    bar.classList.remove('hidden');
    for (const item of selected.slice(0, 30)){
      const chip = document.createElement('button');
      chip.className = 'favchip';
      chip.innerHTML = `❤️ ${item.titulo}`;
      chip.addEventListener('click', () => {
        const el = document.querySelector(`[data-id="${item.id}"]`);
        if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
      });
      list.appendChild(chip);
    }
  }

  function updateFooter(){
    const qtd = [...state.carrinho.values()].reduce((a,b)=>a+b,0);
    const total = [...state.carrinho.entries()].reduce((acc,[id,q])=>{
      const item = state.items.find(i=>i.id===id); return acc + (item ? item.preco*q : 0);
    },0);
    $('#carrinhoQtd').textContent = qtd;
    $('#carrinhoTotal').textContent = brl(total);
  }

  // Interações ------------------------------------------------------------------
  function toggleLike(id, btn){
    if (state.likes.has(id)) { state.likes.delete(id); btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); }
    else { state.likes.add(id); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
    persistReacoes(); renderFavbar();
  }
  function toggleFav(id, btn){
    if (state.favs.has(id)) { state.favs.delete(id); btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); }
    else { state.favs.add(id); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
    persistReacoes(); renderFavbar();
  }
  function addToCart(id){
    const it = state.items.find(x=>x.id===id); if (!it || !it.estoque) { alert('Item indisponível.'); return; }
    const q = state.carrinho.get(id) || 0; state.carrinho.set(id, q+1); updateFooter();
  }

  function applySearchSort(){
    const q = $('#search').value.trim().toLowerCase();
    const how = $('#sort').value;
    state.filtered = state.items.filter(it => !q || it.titulo.toLowerCase().includes(q) || String(it.tecnica).toLowerCase().includes(q) || String(it.dimensao).toLowerCase().includes(q));
    if (how === 'preco_asc') state.filtered.sort((a,b)=>a.preco-b.preco);
    if (how === 'preco_desc') state.filtered.sort((a,b)=>b.preco-a.preco);
    renderList(); renderFavbar();
  }

  // --------- PIX (mesmo algoritmo do central de rifas) ---------
  function crc16_ccitt_ffff(data){
    let crc = 0xFFFF;
    for (let i = 0; i < data.length; i++) {
      let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xff; x ^= x >> 4; crc = (crc << 8) ^ (x << 12) ^ (x << 5) ^ x;
    }
    crc &= 0xFFFF; return crc.toString(16).toUpperCase().padStart(4, '0');
  }
  function gerarBRCode(valor){
    const chavePix = "betshoptv@gmail.com"; // ajuste se necessário
    const nomeBeneficiario = "BET SHOP TV";
    const cidadeBeneficiario = "SAO PAULO";
    const txid = "***";
    const nome = nomeBeneficiario.substring(0,25).toUpperCase().replace(/[^A-Z0-9 ]/g,'');
    const cidade = cidadeBeneficiario.substring(0,15).toUpperCase().replace(/[^A-Z0-9 ]/g,'');
    const valorFormatado = valor.toFixed(2);
    const tlv = (id, v) => `${id}${v.length.toString().padStart(2,'0')}${v}`;
    let payload = '000201';
    payload += tlv('26', `0014BR.GOV.BCB.PIX01${chavePix.length.toString().padStart(2,'0')}${chavePix}`);
    payload += '52040000'; payload += '5303986'; payload += tlv('54', valorFormatado); payload += '5802BR';
    payload += tlv('59', nome); payload += tlv('60', cidade); payload += tlv('62', tlv('05', txid)); payload += '6304';
    const checksum = crc16_ccitt_ffff(payload); return payload + checksum;
  }

  function ensureQRCode(text){
    const el = $('#qrArea');
    if (!text){ el.innerHTML = '<em class="muted">Selecione itens para gerar o QR</em>'; state.pixPayload=''; if(state.qrCode){ try{el.innerHTML='';}catch{} state.qrCode=null; } return; }
    state.pixPayload = text; el.innerHTML = '';
    state.qrCode = new QRCode(el, { text, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M });
  }

  // --------- CHECKOUT ---------
  function abrirCheckout(){
    const dlg = $('#dlgCheckout');
    const total = calcularTotalNumerico();
    $('#coTotal').textContent = brl(total);
    const linhas = [...state.carrinho.entries()].map(([id,q]) => {
      const it = state.items.find(x=>x.id===id); return `• ${it?.titulo || id}  ×${q} — ${brl((it?.preco||0)*q)}`;
    });
    const favs = state.items.filter(x=>state.favs.has(x.id)).map(x=>`❤ ${x.titulo}`);
    const likes = state.items.filter(x=>state.likes.has(x.id)).map(x=>`👍 ${x.titulo}`);
    $('#coItens').innerHTML = `<pre>${linhas.join('
') || '—'}</pre><div class="hr"></div><div class="small">Favoritos: ${favs.join('; ') || '—'}<br>Likes: ${likes.join('; ') || '—'}</div>`;
    ensureQRCode(total>0 ? gerarBRCode(total) : '');
    dlg.showModal();
  }

  function calcularTotalNumerico(){
    return [...state.carrinho.entries()].reduce((acc,[id,q])=>{ const it = state.items.find(x=>x.id===id); return acc + (it ? it.preco*q : 0); },0);
  }

  async function enviarCheckout(){
    const nome = $('#coNome').value.trim();
    const email = $('#coEmail').value.trim();
    if (!nome || !email){ alert('Preencha nome e e-mail.'); return; }
    const whats = $('#coWhats').value.trim();

    const itens = [...state.carrinho.entries()].map(([id,q])=>{
      const it = state.items.find(x=>x.id===id); return { id, titulo: it?.titulo||id, preco: it?.preco||0, qtd:q };
    });
    const total = calcularTotalNumerico();
    const payload = {
      origem: 'gdo01-integracao', timestamp: new Date().toISOString(),
      cliente: { nome, email, whats },
      itens,
      total,
      total_fmt: brl(total),
      pix: { copiaecola: state.pixPayload },
      likes: [...state.likes],
      favs: [...state.favs],
    };

    // Envia como JSON (POST) para CHECKOUT_COMPRAS + fallback GET
    try{
      await fetch(GAS_CHECKOUT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'no-cors' });
      // Fallback GET por imagem (não bloqueia UI)
      const qs = new URLSearchParams({ data: JSON.stringify(payload) }).toString();
      (new Image()).src = GAS_CHECKOUT_URL + '?' + qs + '&t=' + Date.now();
      alert('Pedido enviado! Você receberá a confirmação por e-mail/WhatsApp.');
      $('#dlgCheckout').close();
    }catch(err){
      console.error(err); alert('Falha ao enviar. Tente novamente.');
    }
  }

  // Boot ------------------------------------------------------------------------
  async function boot(){
    try{
      const [pecas, rifas] = await Promise.all([
        fetch(JSON_PECAS_URL, { cache:'no-store' }).then(r=>r.json()),
        fetch(JSON_RIFAS_URL, { cache:'no-store' }).then(r=>r.json()).catch(()=>[]),
      ]);
      state.rifas = Array.isArray(rifas) ? rifas : [];
      const rows = Array.isArray(pecas) ? pecas : [];
      if (!rows.length) throw new Error('JSON de peças sem itens.');
      state.items = rows.map(normalizeItem);
      state.filtered = [...state.items];
      applySearchSort();
    }catch(err){
      console.error(err);
      $('#grid').innerHTML = `<div class="muted">Falha ao carregar dados: ${err.message}.<br>Verifique /dados/pecas.json e /dados/rifas.json.</div>`;
    }

    $('#search').addEventListener('input', applySearchSort);
    $('#sort').addEventListener('change', applySearchSort);
    $('#verFavoritos').addEventListener('click', () => $('#favbar').classList.toggle('hidden'));
    $('#finalizarCompra').addEventListener('click', () => {
      if ([...state.carrinho.values()].reduce((a,b)=>a+b,0) === 0){ alert('Adicione itens ao carrinho.'); return; }
      abrirCheckout();
    });

    $('#btnFecharCO').addEventListener('click', ()=> $('#dlgCheckout').close());
    $('#btnVoltarCO').addEventListener('click', ()=> $('#dlgCheckout').close());
    $('#btnEnviarCO').addEventListener('click', enviarCheckout);
    $('#btnCopiarPIX').addEventListener('click', async () => {
      if (!state.pixPayload) return; const btn = $('#btnCopiarPIX');
      try{ await navigator.clipboard.writeText(state.pixPayload); btn.textContent = 'PIX COPIADO!'; setTimeout(()=>btn.textContent='PIX COPIA e COLA', 2200); }
      catch{ const t = document.createElement('textarea'); t.value=state.pixPayload; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); btn.textContent='PIX COPIADO!'; setTimeout(()=>btn.textContent='PIX COPIA e COLA', 2200); }
    });
  }

  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GDO01 • Integração centraldetestes + Checkout PIX</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --radius: 16px; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; --brand:#111827; --rose:#ff0000; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin:0; color:var(--ink); background:var(--bg); }
    header { position:sticky; top:0; z-index:50; backdrop-filter:saturate(180%) blur(10px); background:rgba(248,250,252,0.7); border-bottom:1px solid var(--line); }
    header .bar { display:flex; gap:10px; align-items:center; padding:12px 16px; flex-wrap:wrap; }
    .tag { font-size:12px; background:#e2e8f0; padding:4px 8px; border-radius:999px; }
    main { max-width:1200px; margin:24px auto; padding:0 16px 120px; }
    .actions { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:12px 0 20px; }
    input[type="search"], select { padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:white; min-width:220px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .card { background:#fff; border:1px solid var(--line); border-radius: var(--radius); overflow:hidden; display:flex; flex-direction:column; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .thumb { aspect-ratio: 4/3; background:#f1f5f9; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { width:100%; height:100%; object-fit:cover; }
    .content { padding:14px; display:flex; flex-direction:column; gap:8px; }
    .title { font-weight:600; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .price { display:flex; gap:8px; align-items:baseline; }
    .price .now { font-size:20px; font-weight:700; color:#111827; }
    .price .was { color:#6b7280; text-decoration: line-through; font-size:12px; }
    .meta { color:#475569; font-size:12px; }
    .btnrow { display:flex; gap:8px; margin-top:auto; }
    .btn { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .iconbtns { display:flex; gap:6px; }
    .icon { border:1px solid #cbd5e1; background:#fff; border-radius:10px; padding:8px; cursor:pointer; min-width:40px; min-height:40px; display:grid; place-items:center; }
    .icon.active { background:#111827; color:#fff; border-color:#111827; }
    .icon svg { width:18px; height:18px; }
    .footer { position:fixed; left:0; right:0; bottom:0; border-top:1px solid var(--line); background:#fff; padding:10px 16px; }
    .footer .row { max-width:1200px; margin:0 auto; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .pill { background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-weight:600; }
    .favbar { position:fixed; right:16px; bottom:86px; background:#0f172a; color:#fff; border-radius:14px; padding:10px 12px; box-shadow:0 8px 30px rgba(2,6,23,.3); max-width: 60vw; }
    .favbar h4 { margin:0 0 8px; font-size:13px; font-weight:700; letter-spacing:.02em; text-transform:uppercase; opacity:.9; }
    .favlist { display:flex; gap:8px; overflow:auto; }
    .favchip { background:#111827; border:1px solid #475569; white-space:nowrap; padding:6px 10px; border-radius:999px; font-size:12px; display:flex; align-items:center; gap:6px; }
    .muted { color:#64748b; }
    .hidden { display:none !important; }
    .sr { position:absolute; left:-9999px; }

    /* CHECKOUT */
    dialog.checkout { width:min(860px, 96vw); border:1px solid var(--line); border-radius:16px; padding:0; }
    .co-head { padding:14px 16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
    .co-body { display:grid; grid-template-columns: 1.2fr .8fr; gap:0; min-height: 420px; }
    .co-col { padding:16px; }
    .co-aside { border-left:1px solid var(--line); background:#f9fafb; }
    .row { display:flex; gap:10px; margin:.5rem 0; }
    .row input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:white; }
    .hr { border-top:1px dashed #cbd5e1; margin:12px 0; }
    .qr { background:#fff; border:1px dashed #cbd5e1; border-radius:12px; padding:10px; min-height: 190px; display:flex; align-items:center; justify-content:center; }
    .btn.copy { width:100%; }
    .co-foot { padding:12px 16px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end; }
    .small { font-size:12px; }

    @media (max-width: 860px){ .co-body{ grid-template-columns: 1fr; } .co-aside{ border-left:none; border-top:1px solid var(--line);} }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>Integração</strong>
      <span class="tag">centraldetestes → gdo01</span>
      <span class="tag" id="testeStatus">Checkout com PIX dinâmico</span>
      <span class="muted">Fonte: /dados/pecas.json • /dados/rifas.json</span>
    </div>
  </header>

  <main>
    <div class="actions">
      <input id="search" type="search" placeholder="Buscar peças…" />
      <select id="sort">
        <option value="relevancia">Ordenar por: Relevância</option>
        <option value="preco_asc">Preço: menor → maior</option>
        <option value="preco_desc">Preço: maior → menor</option>
      </select>
      <span id="count" class="muted"></span>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Rodapé geral de compras (gdo01) -->
  <div class="footer" id="rodapeCompras">
    <div class="row">
      <div>
        <strong id="carrinhoQtd">0</strong> itens • <span>Total:</span> <span id="carrinhoTotal" class="pill">R$ 0,00</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="verFavoritos">Ver favoritos</button>
        <button class="btn primary" id="finalizarCompra">Finalizar compra</button>
      </div>
    </div>
  </div>

  <!-- Barra de favoritos/likes -->
  <aside class="favbar hidden" id="favbar">
    <h4>Selecionados</h4>
    <div id="favlist" class="favlist"></div>
  </aside>

  <!-- CHECKOUT MODAL -->
  <dialog class="checkout" id="dlgCheckout">
    <div class="co-head">
      <strong>Fechamento de compra</strong>
      <button class="btn" id="btnFecharCO">Fechar</button>
    </div>
    <div class="co-body">
      <div class="co-col">
        <h3>Seus dados</h3>
        <div class="row"><input id="coNome" placeholder="Nome" required><input id="coEmail" type="email" placeholder="E-mail" required></div>
        <div class="row"><input id="coWhats" placeholder="Telefone / WhatsApp"></div>
        <div class="hr"></div>
        <h3>Itens</h3>
        <div id="coItens" class="small"></div>
      </div>
      <div class="co-col co-aside">
        <h3>Pagamento (PIX)</h3>
        <div class="qr" id="qrArea"><em class="muted">Geraremos o QR ao lado quando houver itens</em></div>
        <div class="row"><button class="btn copy" id="btnCopiarPIX">PIX COPIA e COLA</button></div>
        <div class="small muted">Valor: <strong id="coTotal">R$ 0,00</strong></div>
      </div>
    </div>
    <div class="co-foot">
      <button class="btn" id="btnVoltarCO">Voltar</button>
      <button class="btn primary" id="btnEnviarCO">Enviar pedido</button>
    </div>
  </dialog>

  <template id="tpl-card">
    <article class="card" data-id="">
      <div class="thumb">
        <img alt="" loading="lazy" />
      </div>
      <div class="content">
        <div class="title"></div>
        <div class="price">
          <span class="now"></span>
          <span class="was"></span>
        </div>
        <div class="meta"></div>
        <div class="btnrow">
          <button class="btn add">Adicionar</button>
          <div class="iconbtns">
            <button class="icon like" title="Like" aria-pressed="false" aria-label="Dar like">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-6 0v4"></path><path d="M5 15h8a4 4 0 0 0 4-4 2 2 0 0 0-2-2H7l-2 6z"></path></svg>
            </button>
            <button class="icon fav" title="Favorito" aria-pressed="false" aria-label="Favoritar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 1 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
            </button>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
  /**
   * ⚙️ CONFIG
   */
  const JSON_PECAS_URL = './dados/pecas.json';
  const JSON_RIFAS_URL = './dados/rifas.json';
  const GAS_CHECKOUT_URL = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';

  // Mapeamento: pecas.json
  // Campos reais: id_peca, titulo, preco, status, tecnica, dimensao, imagens (array)
  const FIELD = {
    id: 'id_peca',
    titulo: 'titulo',
    preco: 'preco',
    status: 'status',
    tecnica: 'tecnica',
    dimensao: 'dimensao',
    imagens: 'imagens',
  };

  // Estado ----------------------------------------------------------------------
  const state = {
    items: [],      // itens normalizados
    filtered: [],   // itens após busca/ordenação
    carrinho: new Map(), // id -> qtd
    likes: new Set(JSON.parse(localStorage.getItem('gdo01:likes') || '[]')),
    favs: new Set(JSON.parse(localStorage.getItem('gdo01:favs') || '[]')),
    rifas: [],      // cores / info complementares
    pixPayload: '',
    qrCode: null,
  };

  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const $ = (sel, root=document) => root.querySelector(sel);
  const brl = n => (isFinite(n) ? n : 0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });

  function persistReacoes(){
    localStorage.setItem('gdo01:likes', JSON.stringify([...state.likes]));
    localStorage.setItem('gdo01:favs', JSON.stringify([...state.favs]));
  }

  function normalizeItem(raw){
    const id = raw[FIELD.id];
    const titulo = raw[FIELD.titulo];
    const preco = Number(raw[FIELD.preco]) || 0;
    const status = (raw[FIELD.status]||'').toString().trim().toUpperCase();
    const imagens = Array.isArray(raw[FIELD.imagens]) ? raw[FIELD.imagens] : [];
    return {
      id, titulo, preco, status,
      tecnica: raw[FIELD.tecnica] || '',
      dimensao: raw[FIELD.dimensao] || '',
      imagem: imagens.length ? resolveImagem(imagens[0]) : '',
      imagens: imagens.map(resolveImagem),
      categoria: '', loja: '', url: '#', estoque: status === 'VENDIDAAA' ? false : true,
    };
  }

  function resolveImagem(code){
    // ajuste este padrão se seu repositório tiver outra pasta/extensão
    return `./imagens/${code}.jpg`;
  }

  // Render ----------------------------------------------------------------------
  function renderList(){
    const grid = $('#grid');
    grid.innerHTML = '';
    for (const item of state.filtered){
      const node = $('#tpl-card').content.firstElementChild.cloneNode(true);
      node.dataset.id = item.id;
      const img = $('img', node);
      if (item.imagem) { img.src = item.imagem; img.alt = item.titulo; } else { img.alt = 'Sem imagem'; }
      $('.title', node).textContent = item.titulo;
      $('.now', node).textContent = brl(item.preco);
      const was = $('.was', node); was.remove();
      const meta = $('.meta', node);
      meta.textContent = [item.dimensao, item.tecnica, item.estoque ? 'Em estoque' : 'Vendido'].filter(Boolean).join(' • ');

      const likeBtn = $('.icon.like', node);
      const favBtn  = $('.icon.fav', node);
      if (state.likes.has(item.id)) likeBtn.classList.add('active'), likeBtn.setAttribute('aria-pressed','true');
      if (state.favs.has(item.id))  favBtn.classList.add('active'),  favBtn.setAttribute('aria-pressed','true');

      likeBtn.addEventListener('click', () => toggleLike(item.id, likeBtn));
      favBtn.addEventListener('click',  () => toggleFav(item.id, favBtn));
      $('.btn.add', node).addEventListener('click', () => addToCart(item.id));

      grid.appendChild(node);
    }
    $('#count').textContent = `${state.filtered.length} itens`;
  }

  function renderFavbar(){
    const bar = $('#favbar');
    const list = $('#favlist');
    list.innerHTML = '';
    const selected = state.items.filter(x => state.favs.has(x.id) || state.likes.has(x.id));
    if (!selected.length) { bar.classList.add('hidden'); return; }
    bar.classList.remove('hidden');
    for (const item of selected.slice(0, 30)){
      const chip = document.createElement('button');
      chip.className = 'favchip';
      chip.innerHTML = `❤️ ${item.titulo}`;
      chip.addEventListener('click', () => {
        const el = document.querySelector(`[data-id="${item.id}"]`);
        if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
      });
      list.appendChild(chip);
    }
  }

  function updateFooter(){
    const qtd = [...state.carrinho.values()].reduce((a,b)=>a+b,0);
    const total = [...state.carrinho.entries()].reduce((acc,[id,q])=>{
      const item = state.items.find(i=>i.id===id); return acc + (item ? item.preco*q : 0);
    },0);
    $('#carrinhoQtd').textContent = qtd;
    $('#carrinhoTotal').textContent = brl(total);
  }

  // Interações ------------------------------------------------------------------
  function toggleLike(id, btn){
    if (state.likes.has(id)) { state.likes.delete(id); btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); }
    else { state.likes.add(id); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
    persistReacoes(); renderFavbar();
  }
  function toggleFav(id, btn){
    if (state.favs.has(id)) { state.favs.delete(id); btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); }
    else { state.favs.add(id); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
    persistReacoes(); renderFavbar();
  }
  function addToCart(id){
    const it = state.items.find(x=>x.id===id); if (!it || !it.estoque) { alert('Item indisponível.'); return; }
    const q = state.carrinho.get(id) || 0; state.carrinho.set(id, q+1); updateFooter();
  }

  function applySearchSort(){
    const q = $('#search').value.trim().toLowerCase();
    const how = $('#sort').value;
    state.filtered = state.items.filter(it => !q || it.titulo.toLowerCase().includes(q) || String(it.tecnica).toLowerCase().includes(q) || String(it.dimensao).toLowerCase().includes(q));
    if (how === 'preco_asc') state.filtered.sort((a,b)=>a.preco-b.preco);
    if (how === 'preco_desc') state.filtered.sort((a,b)=>b.preco-a.preco);
    renderList(); renderFavbar();
  }

  // --------- PIX (mesmo algoritmo do central de rifas) ---------
  function crc16_ccitt_ffff(data){
    let crc = 0xFFFF;
    for (let i = 0; i < data.length; i++) {
      let x = ((crc >> 8) ^ data.charCodeAt(i)) & 0xff; x ^= x >> 4; crc = (crc << 8) ^ (x << 12) ^ (x << 5) ^ x;
    }
    crc &= 0xFFFF; return crc.toString(16).toUpperCase().padStart(4, '0');
  }
  function gerarBRCode(valor){
    const chavePix = "betshoptv@gmail.com"; // ajuste se necessário
    const nomeBeneficiario = "BET SHOP TV";
    const cidadeBeneficiario = "SAO PAULO";
    const txid = "***";
    const nome = nomeBeneficiario.substring(0,25).toUpperCase().replace(/[^A-Z0-9 ]/g,'');
    const cidade = cidadeBeneficiario.substring(0,15).toUpperCase().replace(/[^A-Z0-9 ]/g,'');
    const valorFormatado = valor.toFixed(2);
    const tlv = (id, v) => `${id}${v.length.toString().padStart(2,'0')}${v}`;
    let payload = '000201';
    payload += tlv('26', `0014BR.GOV.BCB.PIX01${chavePix.length.toString().padStart(2,'0')}${chavePix}`);
    payload += '52040000'; payload += '5303986'; payload += tlv('54', valorFormatado); payload += '5802BR';
    payload += tlv('59', nome); payload += tlv('60', cidade); payload += tlv('62', tlv('05', txid)); payload += '6304';
    const checksum = crc16_ccitt_ffff(payload); return payload + checksum;
  }

  function ensureQRCode(text){
    const el = $('#qrArea');
    if (!text){ el.innerHTML = '<em class="muted">Selecione itens para gerar o QR</em>'; state.pixPayload=''; if(state.qrCode){ try{el.innerHTML='';}catch{} state.qrCode=null; } return; }
    state.pixPayload = text; el.innerHTML = '';
    state.qrCode = new QRCode(el, { text, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M });
  }

  // --------- CHECKOUT ---------
  function abrirCheckout(){
    const dlg = $('#dlgCheckout');
    const total = calcularTotalNumerico();
    $('#coTotal').textContent = brl(total);
    const linhas = [...state.carrinho.entries()].map(([id,q]) => {
      const it = state.items.find(x=>x.id===id); return `• ${it?.titulo || id}  ×${q} — ${brl((it?.preco||0)*q)}`;
    });
    const favs = state.items.filter(x=>state.favs.has(x.id)).map(x=>`❤ ${x.titulo}`);
    const likes = state.items.filter(x=>state.likes.has(x.id)).map(x=>`👍 ${x.titulo}`);
    $('#coItens').innerHTML = `<pre>${linhas.join('
') || '—'}</pre><div class="hr"></div><div class="small">Favoritos: ${favs.join('; ') || '—'}<br>Likes: ${likes.join('; ') || '—'}</div>`;
    ensureQRCode(total>0 ? gerarBRCode(total) : '');
    dlg.showModal();
  }

  function calcularTotalNumerico(){
    return [...state.carrinho.entries()].reduce((acc,[id,q])=>{ const it = state.items.find(x=>x.id===id); return acc + (it ? it.preco*q : 0); },0);
  }

  async function enviarCheckout(){
    const nome = $('#coNome').value.trim();
    const email = $('#coEmail').value.trim();
    if (!nome || !email){ alert('Preencha nome e e-mail.'); return; }
    const whats = $('#coWhats').value.trim();

    const itens = [...state.carrinho.entries()].map(([id,q])=>{
      const it = state.items.find(x=>x.id===id); return { id, titulo: it?.titulo||id, preco: it?.preco||0, qtd:q };
    });
    const total = calcularTotalNumerico();
    const payload = {
      origem: 'gdo01-integracao', timestamp: new Date().toISOString(),
      cliente: { nome, email, whats },
      itens,
      total,
      total_fmt: brl(total),
      pix: { copiaecola: state.pixPayload },
      likes: [...state.likes],
      favs: [...state.favs],
    };

    // Envia como JSON (POST) para CHECKOUT_COMPRAS + fallback GET
    try{
      await fetch(GAS_CHECKOUT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'no-cors' });
      // Fallback GET por imagem (não bloqueia UI)
      const qs = new URLSearchParams({ data: JSON.stringify(payload) }).toString();
      (new Image()).src = GAS_CHECKOUT_URL + '?' + qs + '&t=' + Date.now();
      alert('Pedido enviado! Você receberá a confirmação por e-mail/WhatsApp.');
      $('#dlgCheckout').close();
    }catch(err){
      console.error(err); alert('Falha ao enviar. Tente novamente.');
    }
  }

  // Boot ------------------------------------------------------------------------
  async function boot(){
    try{
      const [pecas, rifas] = await Promise.all([
        fetch(JSON_PECAS_URL, { cache:'no-store' }).then(r=>r.json()),
        fetch(JSON_RIFAS_URL, { cache:'no-store' }).then(r=>r.json()).catch(()=>[]),
      ]);
      state.rifas = Array.isArray(rifas) ? rifas : [];
      const rows = Array.isArray(pecas) ? pecas : [];
      if (!rows.length) throw new Error('JSON de peças sem itens.');
      state.items = rows.map(normalizeItem);
      state.filtered = [...state.items];
      applySearchSort();
    }catch(err){
      console.error(err);
      $('#grid').innerHTML = `<div class="muted">Falha ao carregar dados: ${err.message}.<br>Verifique /dados/pecas.json e /dados/rifas.json.</div>`;
    }

    $('#search').addEventListener('input', applySearchSort);
    $('#sort').addEventListener('change', applySearchSort);
    $('#verFavoritos').addEventListener('click', () => $('#favbar').classList.toggle('hidden'));
    $('#finalizarCompra').addEventListener('click', () => {
      if ([...state.carrinho.values()].reduce((a,b)=>a+b,0) === 0){ alert('Adicione itens ao carrinho.'); return; }
      abrirCheckout();
    });

    $('#btnFecharCO').addEventListener('click', ()=> $('#dlgCheckout').close());
    $('#btnVoltarCO').addEventListener('click', ()=> $('#dlgCheckout').close());
    $('#btnEnviarCO').addEventListener('click', enviarCheckout);
    $('#btnCopiarPIX').addEventListener('click', async () => {
      if (!state.pixPayload) return; const btn = $('#btnCopiarPIX');
      try{ await navigator.clipboard.writeText(state.pixPayload); btn.textContent = 'PIX COPIADO!'; setTimeout(()=>btn.textContent='PIX COPIA e COLA', 2200); }
      catch{ const t = document.createElement('textarea'); t.value=state.pixPayload; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); btn.textContent='PIX COPIADO!'; setTimeout(()=>btn.textContent='PIX COPIA e COLA', 2200); }
    });
  }

  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
