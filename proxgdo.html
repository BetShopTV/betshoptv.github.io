<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Galeria de Ofertas — BSTV (masonry)</title>

<style>
  :root{
    --red:#ff0000;
    --ink:#2b2424;
    --muted:#bebab0;
    --bg:#d0cbbf4d;   /* leve, só p/ contraste com as obras */
    --white:#ffffff;
    --maxW:1200px;
    --gap:6px;
    --thumbH:132px;      /* altura dos thumbs no painel */
    --panelMaxH:30vh;    /* altura max do painel branco (expansão) */
  }

  html,body{
    margin:0;
    padding:0;
    background:#c9c4b8;           /* “sitezão atrás” */
    color:var(--ink);
    font-family: "Roboto Condensed", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    letter-spacing:.1px;
  }

  /* ====== WRAPPER LIMITA LARGURA (3 colunas) ====== */
  .page{
    max-width:var(--maxW);
    margin:0 auto;
  }

  /* ====== GALERIA MASONRY (3 colunas SEMPRE) ====== */
  .gallery{
    column-count:3;         /* 3 colunas em todas as larguras (pedido) */
    column-gap:var(--gap);
    padding:var(--gap);
  }
  .gallery-item{
    break-inside:avoid;
    display:inline-block;
    width:100%;
    margin:0 0 var(--gap) 0;
    background:transparent;
    position:relative;
  }
  .gallery-item .card{
    outline:2px solid transparent;
    transition:outline-color .1s linear;
  }
  .gallery-item.selected .card{
    outline:2px solid var(--red);  /* borda vermelha ao selecionar */
  }
  .card img{
    display:block;
    width:100%;
    height:auto;            /* sem corte, sem distorção */
  }

  /* ====== PAINEL BRANCO (EXPANSÃO) ====== */
  .panel-wrap{
    max-width:var(--maxW);
    margin:0 auto;
    position:relative;
  }
  .panel{
    background:var(--white);
    border-top:2px solid var(--white);  /* topo branco */
    max-height:var(--panelMaxH);
    display:none;   /* controlado pelo JS */
    padding:10px 10px 14px;
  }
  .panel.open{ display:block; }

  .thumbs-row{
    display:flex;
    align-items:flex-start;
    gap:8px;
    overflow-x:auto;
    scrollbar-width:thin;
  }
  .thumbs-row::-webkit-scrollbar{
    height:4px;
  }
  .thumbs-row::-webkit-scrollbar-thumb{
    background:var(--red);
  }
  .thumbs-row::-webkit-scrollbar-track{
    background:var(--muted);
  }

  .tmb{
    position:relative;
    flex:0 0 auto;
    height:var(--thumbH);
    aspect-ratio:3/4;
    border:1px solid var(--muted);
    background:#eee;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .tmb img{
    height:100%;
    width:auto;
    display:block;
  }
  .tmb .x{
    position:absolute;
    top:4px;
    right:4px;
    width:18px;
    height:18px;
    background:var(--ink);
    color:var(--white);
    font-size:12px;
    line-height:18px;
    text-align:center;
    cursor:pointer;
    user-select:none;
  }

  .panel-footer{
    margin-top:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .total{
    font-weight:700;
    font-size:18px;
  }
  .btn{
    background:#111;
    color:#fff;
    border:none;
    font-weight:700;
    padding:12px 18px;
    cursor:pointer;
    text-transform:uppercase;
    letter-spacing:.3px;
  }

  /* ====== RODAPÉ (BARRA VERMELHA) ====== */
  .footer{
    position:fixed;
    left:0; right:0; bottom:0;
    background:var(--red);
    color:var(--white);
    z-index:50;
  }
  .footer .bar-inner{
    max-width:var(--maxW);
    margin:0 auto;
    display:flex;
    align-items:center;
    gap:18px;
    padding:12px 12px 10px;
  }
  .brand{
    margin-right:auto;
    font-weight:900;
    text-transform:uppercase;
  }

  .tab{
    display:flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    user-select:none;
    font-weight:700;
    color:var(--muted);  /* off */
  }
  .tab.active{ color:var(--white); }
  .tab .ico{
    position:relative;
    width:28px; height:28px;
    flex:0 0 28px;
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
    filter:brightness(0) invert(1); /* branco */
    opacity:.9;
  }
  .tab.off .ico{
    filter:none;  /* icon “branco” troca pro arquivo -b (branco), mas cor do texto fica off */
    opacity:.5;
  }
  .tab .badge{
    position:absolute;
    right:-8px; top:-8px;
    min-width:18px;
    height:18px;
    padding:0 5px;
    border-radius:9px;
    background:#fff;
    color:var(--red);
    font-size:12px;
    font-weight:900;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* ícones do rodapé (caminho público fornecido) */
  .ico-shop{ background-image:url("elementos/ticon-SHOP-b.avif"); }
  .ico-rifa{ background-image:url("elementos/ticon-RIFA-b.avif"); }
  .tab.off .ico-shop{ background-image:url("elementos/ticon-SHOP-c.avif"); }
  .tab.off .ico-rifa{ background-image:url("elementos/ticon-RIFA-c.avif"); }

  /* ====== INTERATIVO ====== */
  .clickable{ cursor:pointer; }
  .hidden{ display:none !important; }

  /* ====== RESPONSIVO ====== */
  @media (max-width:768px){
    :root{
      --gap:4px;
      --thumbH:108px;
    }
    .footer .bar-inner{ gap:14px; padding:10px; }
    .brand{ font-size:14px; }
    .tab{ font-size:14px; gap:6px; }
    .tab .ico{ width:24px; height:24px; flex-basis:24px; }
    .tab .badge{ right:-7px; top:-7px; min-width:16px; height:16px; font-size:11px; }
    .total{ font-size:16px; }
    .btn{ padding:10px 14px; font-size:14px; }
  }
</style>
</head>
<body>

  <main class="page">
    <!-- Galeria em “masonry” (3 colunas) -->
    <section id="gallery" class="gallery" aria-live="polite">
      <!-- itens via JS -->
    </section>

    <!-- Painel branco (expansão) -->
    <div class="panel-wrap">
      <section id="panel" class="panel" aria-hidden="true">
        <!-- Linha superior: thumbs com rolagem horizontal -->
        <div id="thumbs" class="thumbs-row" tabindex="0" aria-label="Itens selecionados (rolagem horizontal)"></div>

        <!-- Linha inferior: total + finalizar -->
        <div class="panel-footer">
          <div id="total" class="total">TOTAL: R$ 0,00</div>
          <button id="finalizar" class="btn" type="button">FINALIZAR APOSTA</button>
        </div>
      </section>
    </div>
  </main>

  <!-- RODAPÉ — barra fixa -->
  <footer class="footer" role="contentinfo">
    <div class="bar-inner">
      <div class="brand">CENTRAL de APOSTAS</div>

      <div id="tabShop" class="tab off" data-tab="shop" aria-controls="panel">
        <div class="ico ico-shop">
          <span id="badgeShop" class="badge hidden">0</span>
        </div>
        <span>PEÇAS</span>
      </div>

      <div id="tabRifa" class="tab off" data-tab="rifa" aria-controls="panel">
        <div class="ico ico-rifa">
          <span id="badgeRifa" class="badge hidden">0</span>
        </div>
        <span>RIFAS</span>
      </div>
    </div>
  </footer>

<script>
/* =================== Endpoints =================== */
const PECAS_JSON_URL = '/dados/pecas.json';
const RIFAS_JSON_URL = '/dados/rifas.json';

/* =================== Estado =================== */
let piecesData = [];     // pecas.json (somente disponíveis)
let rifasData  = [];     // rifas.json (somente disponíveis)
const selectedPieces = new Set();  // id_peca
const selectedRifas  = new Set();  // id_rifa
let openTab = null;                 // 'shop' | 'rifa' | null

/* =================== Utils =================== */
const money = v => 'R$ ' + Number(v||0).toFixed(2).replace('.', ',');
const idKey  = p => (p.id_peca||p.id_rifa||'');
const firstThumb = p => (p.imagens && p.imagens[0]) || '';
const tmb = name => `img/tmb/${name}.avif`;
const tmbFallback = name => `img/fallback/${name}.jpg`;

function byId(id){ return document.getElementById(id); }
function fmtNumber(n){ return (n>99? '99+' : String(n)); }

/* =================== DOM Refs =================== */
const $gallery  = byId('gallery');
const $panel    = byId('panel');
const $thumbs   = byId('thumbs');
const $total    = byId('total');
const $final    = byId('finalizar');
const $tabShop  = byId('tabShop');
const $tabRifa  = byId('tabRifa');
const $badgeShop= byId('badgeShop');
const $badgeRifa= byId('badgeRifa');

/* =================== Loader de JSON =================== */
async function loadJSON(url){
  const r = await fetch(url, { cache: 'no-store' });
  if(!r.ok) throw new Error('Falha ao carregar '+url);
  return r.json();
}

function sortDescById(arr){
  return [...arr].sort((a,b)=>{
    const ai = parseInt(idKey(a).replace(/\D/g,''),10);
    const bi = parseInt(idKey(b).replace(/\D/g,''),10);
    return bi - ai; // maior primeiro (mais recente)
  });
}

/* =================== Render da Galeria (Masonry) =================== */
function renderGallery(){
  $gallery.innerHTML = '';

  // Apenas peças (galeria principal). Rifas ficam só no rodapé/expansão.
  const items = sortDescById(piecesData);

  for(const p of items){
    const id   = p.id_peca;
    const imgN = firstThumb(p);
    const fig  = document.createElement('figure');
    fig.className = 'gallery-item clickable';
    fig.dataset.id = id;

    const card = document.createElement('div');
    card.className = 'card';

    const img = document.createElement('img');
    img.src = tmb(imgN);
    img.alt = p.titulo || id;
    img.onerror = ()=> img.src = tmbFallback(imgN);

    card.appendChild(img);
    fig.appendChild(card);

    // selected visual
    if(selectedPieces.has(id)) fig.classList.add('selected');

    // toggle seleção (adiciona/retira do carrinho)
    fig.addEventListener('click', e=>{
      togglePiece(id);
    });

    $gallery.appendChild(fig);
  }
}

/* =================== Seleção / Carrinho =================== */
function togglePiece(id){
  if(selectedPieces.has(id)) selectedPieces.delete(id);
  else selectedPieces.add(id);
  refreshUI();
}

function removePiece(id){
  if(selectedPieces.delete(id)) refreshUI();
}

function toggleRifa(id){
  if(selectedRifas.has(id)) selectedRifas.delete(id);
  else selectedRifas.add(id);
  refreshUI();
}
function removeRifa(id){
  if(selectedRifas.delete(id)) refreshUI();
}

/* =================== Painel / Rodapé =================== */
function openPanel(tab){
  openTab = tab; // 'shop' | 'rifa'
  $panel.classList.add('open');
  $panel.setAttribute('aria-hidden','false');
  updateTabsVisual();
  renderPanel();
}
function closePanel(){
  openTab = null;
  $panel.classList.remove('open');
  $panel.setAttribute('aria-hidden','true');
  updateTabsVisual();
}
function togglePanel(tab){
  if(openTab === tab){ closePanel(); return; }
  openPanel(tab);
}

function updateTabsVisual(){
  // SHOP
  const hasShop = selectedPieces.size>0;
  $tabShop.classList.toggle('active', openTab==='shop');
  $tabShop.classList.toggle('off', !hasShop || openTab!=='shop');
  $badgeShop.textContent = fmtNumber(selectedPieces.size);
  $badgeShop.classList.toggle('hidden', selectedPieces.size===0);

  // RIFA
  const hasRifa = selectedRifas.size>0;
  $tabRifa.classList.toggle('active', openTab==='rifa');
  $tabRifa.classList.toggle('off', !hasRifa || openTab!=='rifa');
  $badgeRifa.textContent = fmtNumber(selectedRifas.size);
  $badgeRifa.classList.toggle('hidden', selectedRifas.size===0);
}

function renderPanel(){
  // thumbs
  $thumbs.innerHTML = '';
  let items = [];
  if(openTab==='shop'){
    items = sortDescById(piecesData.filter(p=>selectedPieces.has(p.id_peca)));
  }else if(openTab==='rifa'){
    items = sortDescById(rifasData.filter(r=>selectedRifas.has(r.id_rifa)));
  }else{
    // se o painel abriu por botão sem tab, prioriza o que tiver itens
    if(selectedPieces.size) { openTab='shop'; updateTabsVisual(); return renderPanel(); }
    if(selectedRifas.size)  { openTab='rifa'; updateTabsVisual(); return renderPanel(); }
    // nada selecionado: fecha
    closePanel();
    return;
  }

  for(const it of items){
    const tn = firstThumb(it);
    const box = document.createElement('div');
    box.className = 'tmb';
    const im = document.createElement('img');
    im.src = tmb(tn);
    im.alt = (it.titulo || idKey(it));
    im.onerror = ()=> im.src = tmbFallback(tn);

    const x = document.createElement('div');
    x.className='x';
    x.textContent='×';
    x.title='Remover';
    x.addEventListener('click', e=>{
      e.stopPropagation();
      if(openTab==='shop') removePiece(it.id_peca);
      else removeRifa(it.id_rifa);
    });

    box.appendChild(im);
    box.appendChild(x);
    $thumbs.appendChild(box);
  }

  // total
  const totalPieces = piecesData
    .filter(p=>selectedPieces.has(p.id_peca))
    .reduce((acc,p)=> acc + Number(p.preco||0), 0);
  const totalRifas = rifasData
    .filter(r=>selectedRifas.has(r.id_rifa))
    .reduce((acc,r)=> acc + Number(r.preco||0), 0);

  $total.textContent = 'TOTAL: ' + money(totalPieces + totalRifas);
}

/* ===== Eventos de rodapé ===== */
$tabShop.addEventListener('click', ()=>{
  if(!selectedPieces.size){ return; } // não abre se vazio
  togglePanel('shop');
});
$tabRifa.addEventListener('click', ()=>{
  if(!selectedRifas.size){ return; }
  togglePanel('rifa');
});

/* ===== Fechar painel por ESC ou clique fora ===== */
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') closePanel();
});
document.addEventListener('click', e=>{
  const withinPanel = e.target.closest('#panel');
  const withinFooter = e.target.closest('.footer');
  const withinGallery= e.target.closest('.gallery-item');
  if(!withinPanel && !withinFooter && !withinGallery){
    // clique fora da “central” e fora da galeria => fecha
    closePanel();
  }
});

/* ===== Finalizar (placeholder) ===== */
$final.addEventListener('click', ()=>{
  // Apenas mostra resumo local – sem alert() nativo do browser no futuro
  const pecas = [...selectedPieces].join(',');
  const rifas = [...selectedRifas].join(',');
  const totalPieces = piecesData.filter(p=>selectedPieces.has(p.id_peca)).reduce((a,p)=>a+Number(p.preco||0),0);
  const totalRifas = rifasData.filter(r=>selectedRifas.has(r.id_rifa)).reduce((a,r)=>a+Number(r.preco||0),0);
  const total = totalPieces + totalRifas;

  console.log({
    pecas,
    rifas,
    total
  });
  // Aqui depois conectamos ao Apps Script / formsubmit, mantendo UI.
});

/* =================== Boot =================== */
(async function boot(){
  try{
    // carrega JSON
    const rawPieces = await loadJSON(PECAS_JSON_URL);
    const rawRifas  = await loadJSON(RIFAS_JSON_URL);

    // apenas disponíveis (status diferente de “VENDIDAAA”)
    piecesData = rawPieces.filter(p => String(p.status||'').toUpperCase() !== 'VENDIDAAA');
    rifasData  = rawRifas.filter(r => String(r.status||'').toUpperCase() !== 'VENDIDAAA');

    renderGallery();
    updateTabsVisual();
  }catch(err){
    console.error(err);
  }
})();

function refreshUI(){
  renderGallery();
  updateTabsVisual();
  if(openTab){ renderPanel(); }
}
</script>
</body>
</html>
