<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BetShopTV — Feed (v09)</title>
<style>
  :root{
    --red:#ff0000; --ink:#2b2424; --beige:#bebab0; --white:#ffffff;
    --bd:1px; --gap:12px;
    --font-cta: "Roboto Condensed", Arial, sans-serif;
    --font-body: "Roboto SemiCondensed", Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--beige);color:var(--ink);font-family:var(--font-body);}
  header{position:sticky;top:0;background:var(--red);color:#fff;border-bottom:2px solid var(--ink);z-index:40}
  .hdr-inner{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center}
  .logo{font-family:var(--font-cta);font-weight:700;font-size:20px;text-transform:uppercase}
  .nav{margin-left:auto;display:flex;gap:8px}
  .nav a{color:#fff;text-decoration:none;padding:6px 10px;border:var(--bd) solid #fff;font-weight:700;font-family:var(--font-cta);text-transform:uppercase}
  main{max-width:1200px;margin:18px auto;padding:0 14px}
  /* Grid / gallery for earlier pages (kept minimal) */
  .galeria{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .gal-item{background:#fff;border:var(--bd) solid var(--ink);overflow:hidden}
  .gal-item img{width:100%;height:auto;display:block}

  /* POST card layout */
  .post{border:var(--bd) solid var(--ink);background:#fff;margin-bottom:18px;overflow:hidden;display:flex;flex-direction:column}
  .carousel { position: relative; overflow-x:auto; display:flex; gap:8px; scroll-snap-type:x mandatory; align-items:center; padding:0; }
  .carousel-slide { flex:0 0 100%; display:flex; align-items:center; justify-content:center; scroll-snap-align:center; min-height: 240px; } 
  .carousel-slide img {
    display:block;
    max-width:100%;
    max-height:66vh;     /* <= 66% viewport height */
    min-height:200px;    /* sensible min */
    object-fit:contain;  /* preserve aspect ratio, center letterbox/pillarbox */
    border:var(--bd) solid var(--ink);
    box-sizing:border-box;
  }

  /* progress bar under carousel (small red line) */
  .carousel-bar-wrap{height:8px;background:transparent;padding:6px 10px}
  .carousel-bar{height:6px;background:#ddd;border-radius:4px;overflow:hidden;position:relative}
  .carousel-bar .pos{height:100%;background:var(--red);width:0%;transition:width .18s linear}

  /* arrows - left/right */
  .carousel-arrow { position:absolute; top:50%; transform:translateY(-50%); width:28px; height:28px; background:transparent; border:none; cursor:pointer; z-index:20; }
  .carousel-arrow.left { left:6px; }
  .carousel-arrow.right { right:6px; }
  .carousel-arrow svg{ width:100%; height:100%; fill:var(--red) }

  /* meta area */
  .meta { padding:12px; display:flex; flex-direction:column; gap:8px; }
  .meta .linha1 { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .titulo { font-family:var(--font-cta); font-weight:700; font-size:16px; color:var(--ink); }
  .preco { font-weight:700; font-size:16px; }
  .descricao { color:#222; font-size:14px; line-height:1.4; }
  .dimens { color:#444; font-size:13px; margin-top:6px }
  .meta .meta-footer { display:flex; justify-content:flex-end; align-items:center; padding-top:8px; }
  .add-btn { border:2px solid var(--red); background:transparent; color:var(--red); padding:8px 14px; font-weight:700; cursor:pointer; font-family:var(--font-cta); }

  /* Footer */
  footer{position:sticky;bottom:0;background:var(--ink);color:#fff;padding:10px;border-top:2px solid var(--ink)}
  .ftr-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:10px;justify-content:space-between}
  .pill{background:#fff;color:var(--ink);padding:6px 8px;border:var(--bd) solid var(--ink);font-weight:700}

  /* responsive tweaks */
  @media (max-width:768px){
    .galeria{grid-template-columns:repeat(2,1fr)}
    .carousel-slide img{ min-height:240px; max-height:66vh }
  }
  @media (max-width:480px){
    .galeria{grid-template-columns:repeat(1,1fr)}
    .meta .linha1{flex-direction:column; align-items:flex-start}
    .meta .meta-footer{justify-content:flex-end}
  }
</style>
</head>
<body>
<header>
  <div class="hdr-inner">
    <div class="logo">BSTV_v09</div>
    <nav class="nav">
      <a href="#galeria">Galeria</a>
      <a href="#feed">Feed</a>
      <a href="#rifas">Rifas</a>
    </nav>
  </div>
</header>

<main>
  <!-- Gallery (kept minimal) -->
  <section id="galeria">
    <div class="galeria" id="galeriaGrid"></div>
  </section>

  <!-- Feed -->
  <section id="feed" style="display:none;">
    <div id="feedList" class="feed"></div>
  </section>

  <!-- Rifas (minimal) -->
  <section id="rifas" style="display:none;">
    <div id="rifasGrid" class="rifas"></div>
  </section>
</main>

<footer>
  <div class="ftr-inner">
    <div class="left">
      <button class="pill" id="pillPecas">Peças: 0</button>
      <button class="pill" id="pillRifas">Rifas: 0</button>
      <button class="pill" id="pillFav">Favoritas: 0</button>
    </div>
    <div class="right">
      <span class="total-display">Total: R$ 0,00</span>
    </div>
  </div>
</footer>

<!-- hidden checkout form (keeps existing flow) -->
<form id="hiddenForm" action="https://formsubmit.co/b7c03bfd6671addd4ddd857cb7e53d3d" method="POST" style="display:none;">
  <input type="hidden" name="nome" id="fNome">
  <input type="hidden" name="email" id="fEmail">
  <input type="hidden" name="telefone" id="fTelefone">
  <input type="hidden" name="pecas" id="fPecas">
  <input type="hidden" name="rifas" id="fRifas">
  <input type="hidden" name="favoritas" id="fFav">
  <input type="hidden" name="total" id="fTotal">
  <input type="hidden" name="_captcha" value="false">
  <input type="hidden" name="_subject" value="Nova aposta BSTV">
  <input type="hidden" name="_template" value="table">
  <input type="hidden" name="_next" value="https://betshoptv.com/obrigado.html">
</form>

<script>
/* CONFIG */
const PECAS_JSON_URL = 'https://betshoptv.com/dados/pecas.json';
const RIFAS_JSON_URL = 'https://betshoptv.com/dados/rifas.json';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';

/* STATE */
let pecas = [];
let rifas = [];
const selecionadas = new Set();
const rifasSel = new Set();
const favoritos = new Set(); // start empty as requested
let totalGeral = 0;

/* HELPERS */
const fmt = v => 'R$ ' + Number(v||0).toFixed(2).replace('.',',');
function imgWithFallback(src){
  const img = new Image();
  img.loading = 'lazy';
  img.src = src;
  img.onerror = () => { if(src.endsWith('.avif')) img.src = src.replace('.avif','.jpg'); };
  return img;
}
function updatePills(){
  document.getElementById('pillPecas').textContent = 'Peças: ' + selecionadas.size;
  document.getElementById('pillRifas').textContent = 'Rifas: ' + rifasSel.size;
  document.getElementById('pillFav').textContent  = 'Favoritas: ' + favoritos.size;
  localStorage.setItem('BSTV_FAV', JSON.stringify([...favoritos]));
}
function updateTotalFooter(){ document.querySelector('.total-display').textContent = `Total: ${fmt(totalGeral)}`; }
function calcularTotal(){
  let total = 0;
  selecionadas.forEach(id=>{ const p=pecas.find(x=>x.id_peca===id); if(p && p.preco) total += parseFloat(p.preco); });
  rifasSel.forEach(id=>{ const r=rifas.find(x=>x.id_rifa===id); if(r && r.valor_rifa) total += parseFloat(r.valor_rifa); else total += 30; });
  totalGeral = total; updateTotalFooter();
}

/* ROUTER (simple) */
const routes = ['galeria','feed','rifas'];
function showOnly(r){ routes.forEach(k=>{const el=document.getElementById(k); if(el) el.style.display = (k===r)?'block':'none';}); window.scrollTo(0,0); }
document.querySelectorAll('.nav a').forEach(a=>a.addEventListener('click', e=>{ const h=a.getAttribute('href'); if(h && h.startsWith('#')){ e.preventDefault(); showOnly(h.replace('#','')); }}));

/* RENDER FEED (carrossel per post) */
function renderFeed(){
  const list = document.getElementById('feedList'); list.innerHTML = '';
  pecas.forEach(p=>{
    if(String(p.status).toUpperCase()==='VENDIDAAA') return;
    const post = document.createElement('article'); post.className='post';
    // carousel
    const carousel = document.createElement('div'); carousel.className='carousel';
    carousel.setAttribute('role','region');
    const imgs = Array.isArray(p.imagens) ? p.imagens : [];
    imgs.forEach((nome)=>{
      const slide = document.createElement('div'); slide.className='carousel-slide';
      const src = '/img/otm/' + nome + '.avif';
      const img = imgWithFallback(src);
      slide.appendChild(img);
      carousel.appendChild(slide);
    });

    // progress bar
    const barWrap = document.createElement('div'); barWrap.className='carousel-bar-wrap';
    const bar = document.createElement('div'); bar.className='carousel-bar';
    const pos = document.createElement('div'); pos.className='pos';
    bar.appendChild(pos); barWrap.appendChild(bar);

    // arrows
    const left = document.createElement('button'); left.className='carousel-arrow left'; left.innerHTML = '<svg viewBox="0 0 24 24"><path d="M15 6 L9 12 L15 18"/></svg>';
    const right = document.createElement('button'); right.className='carousel-arrow right'; right.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 6 L15 12 L9 18"/></svg>';
    carousel.appendChild(left); carousel.appendChild(right);

    // meta area
    const meta = document.createElement('div'); meta.className='meta';
    const linha1 = document.createElement('div'); linha1.className='linha1';
    const titulo = document.createElement('div'); titulo.className='titulo'; titulo.textContent = p.titulo || ('Peça '+p.id_peca);
    const preco = document.createElement('div'); preco.className='preco'; preco.textContent = fmt(p.preco);
    linha1.appendChild(titulo); linha1.appendChild(preco);
    const descricao = document.createElement('div'); descricao.className='descricao'; descricao.textContent = p.descricao || p.ficha || '';
    const dimens = document.createElement('div'); dimens.className='dimens'; dimens.textContent = p.dimensao || p.dimencao || p.tamanho || '';
    const footerMeta = document.createElement('div'); footerMeta.className='meta-footer';
    const btn = document.createElement('button'); btn.className='add-btn'; btn.textContent='ADICIONAR';
    footerMeta.appendChild(btn);

    meta.appendChild(linha1); meta.appendChild(descricao); meta.appendChild(dimens); meta.appendChild(footerMeta);

    // append
    post.appendChild(carousel);
    post.appendChild(barWrap);
    post.appendChild(meta);
    list.appendChild(post);

    // --- carousel behaviour ---
    const slides = carousel.querySelectorAll('.carousel-slide');
    const slideCount = slides.length;
    // helper to update pos bar
    function updatePos(){
      const idx = Math.round(carousel.scrollLeft / carousel.clientWidth);
      const pct = ((idx+1)/ Math.max(1, slideCount)) * 100;
      pos.style.width = pct + '%';
    }
    // init pos
    updatePos();

    // arrows click
    left.addEventListener('click', ()=> {
      const cur = Math.round(carousel.scrollLeft / carousel.clientWidth);
      const target = Math.max(0, cur - 1);
      carousel.scrollTo({left: target * carousel.clientWidth, behavior:'smooth'});
    });
    right.addEventListener('click', ()=> {
      const cur = Math.round(carousel.scrollLeft / carousel.clientWidth);
      const target = Math.min(slideCount-1, cur + 1);
      carousel.scrollTo({left: target * carousel.clientWidth, behavior:'smooth'});
    });

    // on scroll update bar
    let scrollTimeout;
    carousel.addEventListener('scroll', ()=> {
      window.clearTimeout(scrollTimeout);
      scrollTimeout = window.setTimeout(()=>{
        updatePos();
      }, 80);
    });

    // allow keyboard navigation when focused
    carousel.tabIndex = 0;
    carousel.addEventListener('keydown', (ev)=>{
      if(ev.key === 'ArrowLeft') left.click();
      if(ev.key === 'ArrowRight') right.click();
    });

    // Add button behaviour: select piece into cart
    btn.addEventListener('click', ()=>{
      if(selecionadas.has(p.id_peca)) { selecionadas.delete(p.id_peca); btn.textContent='ADICIONAR'; }
      else { selecionadas.add(p.id_peca); btn.textContent='REMOVER'; }
      updatePills(); calcularTotal(); renderCart(); 
    });

    // Favorite button creation (optional visual in meta if you want)
    const favBtn = document.createElement('button'); favBtn.className='btn fav'; favBtn.style.marginLeft='8px'; favBtn.textContent='❤';
    favBtn.addEventListener('click', ()=>{
      if(favoritos.has(p.id_peca)) favoritos.delete(p.id_peca); else favoritos.add(p.id_peca);
      favBtn.classList.toggle('active', favoritos.has(p.id_peca)); updatePills(); renderCart();
    });
    linha1.appendChild(favBtn);
  });
}

/* RENDER GALERIA (keeps previous minimal) */
function renderGaleria(){
  const grid = document.getElementById('galeriaGrid'); grid.innerHTML='';
  pecas.forEach(p=>{
    if(String(p.status).toUpperCase()==='VENDIDAAA') return;
    const card=document.createElement('div'); card.className='gal-item';
    const nome=(p.imagens && p.imagens[0])?p.imagens[0]:'';
    const img=imgWithFallback('/img/tmb/'+nome+'.avif'); card.appendChild(img);
    const ttl=document.createElement('div'); ttl.className='ttl'; ttl.textContent=p.titulo||('Peça '+p.id_peca); card.appendChild(ttl);
    card.addEventListener('click', ()=> { showOnly('feed'); openFeedAt(p.id_peca); });
    grid.appendChild(card);
  });
}

/* RIFAS - minimal */
function renderRifas(){
  const g=document.getElementById('rifasGrid'); g.innerHTML='';
  rifas.forEach(r=>{
    if(r.status_rifa && String(r.status_rifa).trim()!=='') return;
    const btn=document.createElement('button'); btn.className='rifa-btn'; btn.textContent=(r.numero||r.id_rifa||'');
    btn.style.backgroundColor = r.hex_rifa || r.hex || '#777';
    g.appendChild(btn);
  });
}

/* CART minimal (renderCart used above) */
function renderCart(tab='pecas'){ /* minimal for compatibility with previous flow */ 
  // implement simple listing in console or keep placeholder
}

/* DEEP LINK helper */
function openFeedAt(id){
  // ensure feed rendered
  renderFeed();
  // find post
  const el = document.getElementById('post-'+id);
  if(el){
    showOnly('feed');
    el.scrollIntoView({behavior:'auto', block:'start'});
  }
}

/* LOAD JSONs */
async function init(){
  try{
    // clear favorites on load as requested
    localStorage.removeItem('BSTV_FAV');
    favoritos.clear();

    const [rp, rr] = await Promise.all([ fetch(PECAS_JSON_URL, {cache:'no-store'}), fetch(RIFAS_JSON_URL, {cache:'no-store'}) ]);
    if(!rp.ok || !rr.ok) throw new Error('JSON load failed');
    pecas = await rp.json(); rifas = await rr.json();
    renderGaleria(); renderFeed(); renderRifas(); updatePills(); calcularTotal();
    showOnly('galeria');
  } catch(e){
    console.error(e);
    alert('Falha ao carregar dados (pecas/rifas). Verifique as URLs e CORS.');
  }
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
