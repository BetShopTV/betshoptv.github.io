<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BSTV (v. 12) — Safe header/footer</title>

<!-- ====== STYLES (preserve visual look of v08) ====== -->
<style>
  /* ====== Tokens ====== */
  :root{
    --red:#ff0000; --ink:#2b2424; --beige:#bebab0; --white:#ffffff;
    --bd-thin:1px; --bd-thick:2px;
    --ff-cta:"Roboto Condensed", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    --ff-body:"Roboto SemiCondensed", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    --fs-h1:clamp(1.4rem,3vw,2rem); --fs-h2:clamp(1.1rem,2vw,1.4rem);
    --fs-p:clamp(.9rem,1.2vw,1rem); --fs-sm:clamp(.78rem,1vw,.9rem);
    --gap-xxs:4px; --gap-xs:6px; --gap-s:8px; --gap-m:12px; --gap-l:16px;
    --app-max-width:1200px;
      
    /* altura base do rodapé para dimensionar a barra (ajuste se necessário) */
  --ftr-h: 52px;
  --sb-maxh: calc(var(--ftr-h) * 3);
  --sb-gap: 8px;
  --sb-pad: 8px;
  }
  /* ===== Selected Bar (faixa acima do rodapé) ===== */

/* Wrapper fixo acima do footer; ocupa largura do app */
.selected-bar{
  position: sticky;          /* “gruda” ao bottom, acima do footer sticky */
  bottom: calc(var(--ftr-h));/* fica colada acima do rodapé */
  z-index: 9;
  background: var(--beige);
  border-top: var(--bd-thin) solid var(--ink);
  border-bottom: var(--bd-thin) solid var(--ink);
  max-height: var(--sb-maxh);
  padding: var(--sb-pad) 0;
}

/* Esconde totalmente quando não usada */
.selected-bar.is-hidden{
  display: none;
}

/* Trilho com rolagem horizontal (scrollbar vermelha como no feed) */
.selected-track{
  display: flex;
  gap: var(--sb-gap);
  align-items: stretch;
  overflow-x: auto;
  overflow-y: hidden;
  padding: 0 12px;
  scroll-snap-type: x proximity;
}

/* Itens-base (cartões mini) para Peças e Favoritas */
.sb-item{
  scroll-snap-align: start;
  border: var(--bd-thin) solid var(--ink);
  background: #fff;
  display: flex;
  flex-direction: column;
  width: 140px;                  /* mini-card */
  min-width: 140px;
  box-sizing: border-box;
  position: relative;
}

/* Thumb */
.sb-item .sb-thumb{
  display: block;
  width: 100%;
  height: 100px;
  object-fit: cover;
  background: #000;
  border-bottom: var(--bd-thin) solid var(--ink);
}

/* Título opcional, pequeno (se quiser mostrar) – por padrão vamos omitir */
.sb-item .sb-title{
  display: none;
  font: 700 var(--fs-sm)/1.2 var(--ff-cta);
  padding: 6px 8px;
}

/* Botão X “REMOVER” no canto superior direito (cores padrão de remover) */
.sb-item .sb-remove{
  position: absolute;
  top: 6px;
  right: 6px;
  border: var(--bd-thin) solid var(--ink);
  background: var(--ink);
  color: var(--beige);
  font: 700 12px/1 var(--ff-cta);
  padding: 4px 6px;
  cursor: pointer;
}

/* Chips das rifas: clonam o visual de .rifa-btn, porém em tamanho compacto */
.sb-rifa{
  display: inline-flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  gap: 2px;
  box-sizing: border-box;
  min-height: 46px;
  padding: 8px 10px;
  border: var(--bd-thin) solid var(--ink);
  cursor: pointer;
  font-family: 'BC-RobotoCondensed-Med', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
  font-weight: 500;
  font-size: 13px;
  line-height: 1.12;
  text-transform: none;      /* nunca uppercase */
  color: inherit;            /* definido por JS (contraste) */
  background: var(--beige);  /* será sobrescrito pela cor da rifa */
  white-space: normal;
  overflow: hidden;
  min-width: 140px;
}

/* spans internos iguais aos das rifas */
.sb-rifa .ln1, .sb-rifa .ln2{
  display: block;
  margin: 0;
  padding: 0;
  font: inherit;
  line-height: inherit;
  color: inherit;
  text-transform: none;
  text-align: left;
}

/* Selected (quando chip é clicado – visual de “selecionado”) */
.sb-rifa.selected{
  background: #ffffff !important;
  color: #ff0000 !important;
  border-color: #ff0000 !important;
}

/* Scrollbar vermelha (webkit) */
.selected-track::-webkit-scrollbar{
  height: 6px;
}
.selected-track::-webkit-scrollbar-track{
  background: #ddd;
}
.selected-track::-webkit-scrollbar-thumb{
  background: var(--red);
}

/* Ajustes mobile */
@media (max-width: 480px){
  .sb-item{ width: 120px; min-width: 120px; }
  .sb-item .sb-thumb{ height: 88px; }
  .sb-rifa{ min-width: 120px; font-size: 12px; }
}

  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--beige);color:var(--ink);font-family:var(--ff-body);-webkit-font-smoothing:antialiased}

  /* ====== Header (mantém visual v08) ====== */
  header{position:sticky;top:0;z-index:10;background:var(--red);color:#fff;border-bottom:var(--bd-thick) solid var(--ink)}
  .hdr-inner{max-width:var(--app-max-width);margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
  .logo{font:700 var(--fs-h2)/1 var(--ff-cta);text-transform:uppercase}
  .nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .nav a{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 10px;border:var(--bd-thin) solid #fff;color:#fff;text-decoration:none;font:700 var(--fs-sm)/1 var(--ff-cta);text-transform:uppercase}
  .nav a:hover{background:#fff;color:var(--ink)}

  /* ====== Área da página ====== */
  main#app{max-width:var(--app-max-width);margin:20px auto;padding:0 16px;min-height:60vh}
  section{margin-bottom:24px}
  h2{font:700 var(--fs-h2)/1.2 var(--ff-cta);margin:0 0 8px}

  /* ====== Galeria (Masonry / Pinterest) ====== */
  .galeria{
    column-gap:4px; -webkit-column-gap:4px;
    column-count:3; -webkit-column-count:3; /* 3 colunas por padrão */
    margin:0; padding:0;
  }
  .gal-item{
    display:inline-block; width:100%;
    margin:0 0 1px;
    break-inside:avoid; -webkit-column-break-inside:avoid;
    border:var(--bd-thin) solid var(--ink);
    background:#fff; overflow:hidden;
  }
  .gal-item img{display:block;width:100%;height:auto;object-fit:cover;vertical-align:middle;background:#000}
  .gal-item .ttl{display:none!important}

  @media (min-width:1300px){
    .galeria{column-count:4; -webkit-column-count:4} /* 4 colunas telas largas */
  }

  /* ====== Feed / Post ====== */
  .feed{display:flex;flex-direction:column;gap:var(--gap-s)}
  .post{border:var(--bd-thin) solid var(--ink);background:#fff;overflow:hidden;display:flex;flex-direction:column}

  /* Carrossel */
  .carousel{
    display:flex;gap:var(--gap-xxs);
    overflow-x:auto;scroll-snap-type:x mandatory;
    padding:0;border-bottom:var(--bd-thin) solid var(--ink);
    /* barra de rolagem inferior sempre visível e vermelha */
    scrollbar-color: var(--red) transparent;
  }
  .carousel::-webkit-scrollbar{height:8px}
  .carousel::-webkit-scrollbar-track{background:transparent}
  .carousel::-webkit-scrollbar-thumb{background:var(--red)}
  .carousel-slide{flex:0 0 100%;display:flex;align-items:center;justify-content:center;scroll-snap-align:center}
  .carousel-slide img{
    width:100%; max-height:66vh; min-height:200px;
    object-fit:contain; background:#000;
    border:var(--bd-thin) solid var(--ink);
  }
  /* remove a barra de progresso antiga */
  .carousel-bar-wrap{display:none!important}

  /* Meta do post */
  .meta{padding:10px;display:flex;flex-direction:column;gap:8px}
  .meta .linha1{display:flex;align-items:flex-start;gap:8px}
  .titulo{flex:1 1 auto;font-family:var(--ff-cta);font-weight:700;min-width:0}
  .preco{flex:0 0 auto;font-weight:700;white-space:nowrap;align-self:flex-start}
  .descricao{font-size:14px;color:#333}
  .tecnica{font-size:13px;color:#333}   /* será exibida acima das dimensões */
  .dimens{font-size:13px;color:#444}

  /* Botões do post */
  .meta .meta-footer{display:flex;justify-content:flex-end;gap:8px}
  .btn{font-family:var(--ff-cta);font-weight:700;padding:8px 12px;cursor:pointer;border-radius:0}
  .add-btn{border:2px solid var(--red);background:transparent;color:var(--red)}
  .add-btn.added{border-color:var(--ink);background:var(--ink);color:var(--beige)}
  .fav-btn{border:2px solid var(--red);background:var(--white);color:var(--red)}
  .fav-btn.active{border-color:var(--ink);background:var(--ink);color:var(--beige)}

  /* ====== Rifas ====== */
  @font-face{
    font-family:'BC-RobotoCondensed-Med';
    src:url('/fonts/Roboto_Condensed-Medium.woff2') format('woff2');
    font-weight:500;font-style:normal;font-display:swap;
  }
  .rifas{
    display:flex;flex-wrap:wrap;gap:8px;
    align-items:flex-start;justify-content:center;align-content:center;
    padding:6px 0;
  }
  .rifa-btn{
    display:inline-flex;flex-direction:column;align-items:flex-start;justify-content:center;gap:2px;
    min-height:56px;padding:10px 12px;border:1px solid var(--ink);
    background:var(--beige);cursor:pointer;
    font-family:'BC-RobotoCondensed-Med',system-ui,-apple-system,'Segoe UI',Arial,sans-serif;
    font-weight:500;font-size:14px;line-height:1.15;text-transform:none;color:inherit;white-space:normal;overflow:hidden;
  }
  .rifa-btn .ln1,.rifa-btn .ln2{
    display:block;margin:0;padding:0;font:inherit;text-transform:none;text-align:left;color:inherit;
  }
  .rifa-btn.selected{background:#fff!important;border-color:var(--red)!important;color:var(--red)!important}
  .rifa-btn.sold{opacity:.45;pointer-events:none;filter:grayscale(1)}

  @media (max-width:768px){
    .rifa-btn{min-height:42px;padding:6px 8px;font-size:12px}
    .rifa-btn .ln1,.rifa-btn .ln2{font-size:12px;line-height:1.12}
  }

  /* ====== Footer (mantém visual v08) ====== */
  footer{position:sticky;bottom:0;background:var(--ink);color:#fff;border-top:var(--bd-thick) solid var(--ink)}
  .ftr-inner{max-width:var(--app-max-width);margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 16px}
  .contadores{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#fff;color:var(--ink);border:var(--bd-thin) solid var(--ink);padding:4px 8px;font:700 var(--fs-sm)/1 var(--ff-cta)}
  .cta-final{background:var(--red);color:#fff;border:var(--bd-thin) solid #fff;padding:8px 12px;font:700 var(--fs-sm)/1 var(--ff-cta);text-transform:uppercase;cursor:pointer}
  .total-display{font-weight:700;margin-left:12px}

/* ===== Barra de selecionados ===== */
#selectedBar{
  position: sticky; bottom: calc(48px + 8px); /* acima do rodapé; ajuste 48px se seu footer for diferente */
  z-index: 9;
  background: #ffffff;
  border: 1px solid var(--ink);
  padding: 8px 10px;
  max-height: calc(3 * 48px); /* no máx. triplo da altura do rodapé */
  overflow: hidden;
}
#selectedBar .sel-wrap{display:flex;flex-direction:column;gap:8px}
#selectedBar .sel-strip{
  display:flex; gap:8px;
  overflow-x:auto;
  padding-bottom:4px;
  scroll-snap-type:x proximity;
  border-bottom: 3px solid var(--red); /* trilho vermelho sempre visível */
}

/* chip de peça/favorita (miniatura + X) */
.sel-chip{
  display:flex; align-items:center; gap:6px;
  border:1px solid var(--ink); background:#fff; color:var(--ink);
  padding:4px 6px; scroll-snap-align:start;
}
.sel-chip img{width:54px;height:54px;object-fit:cover;border:1px solid var(--ink)}
.sel-chip .x{
  border:1px solid var(--red); color:var(--red); background:#fff;
  font:700 var(--fs-sm)/1 var(--ff-cta); padding:2px 6px; cursor:pointer;
}
.sel-chip .x:hover{background:#ffecec}

/* chip de rifa reaproveita visual do botão */
.sel-rifa{
  border:1px solid var(--red); color:var(--red); background:#fff;
  font-family: 'BC-RobotoCondensed-Med', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
  font-weight:500; font-size:14px; line-height:1.15;
  padding:6px 10px; cursor:pointer; white-space:nowrap;
}
.sel-rifa.selected{
  background:#2b2424; color:#bebab0; border-color:#2b2424;
}

  
</style>

</head>
<body>
  <!-- ========== HEADER (kept same as v08) ========== -->
  <header>
    <div class="hdr-inner">
      <div class="logo">torceni</div>
      <nav class="nav">
        <a href="#galeria">Galeria</a>
        <a href="#feed">Feed</a>
        <a href="#rifas">Rifas</a>
        <a href="https://betshoptv.com/como.html">Como Funciona?</a>
      </nav>
    </div>
  </header>

  <!-- ========== MOUNT POINT: only this container is mutated by JS ========== -->
  <main id="app" role="main" aria-live="polite">
    <!-- initial content: will be replaced by renderers -->
    <section id="page-loading" style="padding:24px;text-align:center;">Carregando...</section>
  </main>

  <!-- ========== FOOTER (kept same as v08) ========== -->
  <footer>
    <div class="ftr-inner">
      <div class="contadores">
        <button class="pill" id="pillPecas">Peças: 0</button>
        <button class="pill" id="pillRifas">Rifas: 0</button>
        <button class="pill" id="pillFav">Favoritas: 0</button>
      </div>
      <div>
        <span class="total-display">Total: R$ 0,00</span>
      </div>
      <button class="cta-final" id="btnCheckout">Finalizar</button>
    </div>

<!-- ===== Selected Bar (faixa de consulta dos itens selecionados) ===== -->
<div id="selectedBar" class="selected-bar is-hidden" aria-hidden="true">
  <div id="selectedBarInner" class="selected-track" role="region" aria-live="polite" aria-label="Itens selecionados"></div>
</div>

    
  </footer>
  

  <!-- Hidden Form (kept in footer area but declared here) -->
  <form id="hiddenForm" action="https://formsubmit.co/b7c03bfd6671addd4ddd857cb7e53d3d" method="POST" style="display:none;">
    <input type="hidden" name="nome" id="fNome">
    <input type="hidden" name="email" id="fEmail">
    <input type="hidden" name="telefone" id="fTelefone">
    <input type="hidden" name="pecas" id="fPecas">
    <input type="hidden" name="rifas" id="fRifas">
    <input type="hidden" name="favoritas" id="fFav">
    <input type="hidden" name="total" id="fTotal">
    <input type="hidden" name="_captcha" value="false">
    <input type="hidden" name="_subject" value="Nova aposta BSTV">
    <input type="hidden" name="_template" value="table">
    <input type="hidden" name="_next" value="https://betshoptv.com/obrigado.html">
  </form>

  <!-- ====== SCRIPT: modular renderers, event delegation, footer bindings ====== -->
<script>
/* ======================== CONFIG ======================== */
const PECAS_JSON_URL = 'https://betshoptv.com/dados/pecas.json';
const RIFAS_JSON_URL = 'https://betshoptv.com/dados/rifas.json';
const GAS_URL        = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';

/* ======================== STATE ========================= */
let pecas = [];
let rifas = [];
let rifasById = new Map();

const selecionadas = new Set();  // peças selecionadas
const rifasSel     = new Set();  // ids de rifas selecionadas
const favoritos    = new Set();  // ids de peças favoritas

let totalGeral = 0;

/* ======================== HELPERS ======================= */
const fmt = v => 'R$ ' + Number(v||0).toFixed(2).replace('.',',');

function imgWithFallback(src){
  const img = new Image();
  img.loading = 'lazy';
  img.src = src;
  img.onerror = () => { if(src.endsWith('.avif')) img.src = src.replace('.avif','.jpg'); };
  return img;
}

/* ===== contraste (YIQ) ===== */
const getContrastColor = (hexColor) => {
  try {
    if (!hexColor) return '#2b2424';
    let s = String(hexColor).trim();
    if (s.startsWith('#')) s = s.slice(1);
    if (s.length === 3) s = s.split('').map(ch => ch + ch).join('');
    if (s.length !== 6) return '#2b2424';
    const r = parseInt(s.substring(0, 2), 16);
    const g = parseInt(s.substring(2, 4), 16);
    const b = parseInt(s.substring(4, 6), 16);
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    return (yiq >= 128) ? '#2b2424' : '#ffffff';
  } catch (e) {
    return '#2b2424';
  }
};

/* ===== split inteligente do label das rifas (máx 2 linhas, sem upper) ===== */
function formatRifaLabelDOM(rawText) {
  const t0 = (rawText || '').toString().trim();
  const frag = document.createDocumentFragment();
  if (!t0) { const s=document.createElement('span'); s.className='ln1'; s.textContent=''; frag.appendChild(s); return frag; }

  let tokens = t0.split(/\s+/).filter(Boolean);
  if (tokens.length >= 3 && tokens[1] === '/') { // mantém "NNN / Título" mais coeso
    tokens = [ tokens.slice(0,3).join(' ') ].concat(tokens.slice(3));
  }
  if (tokens.length === 1){
    const s1=document.createElement('span'); s1.className='ln1'; s1.textContent=tokens[0]; frag.appendChild(s1); return frag;
  }

  const n = tokens.length;
  const lens = tokens.map(w=>w.length);
  const totalChars = lens.reduce((a,b)=>a+b,0) + (n-1);
  const pref = new Array(n+1).fill(0);
  for (let i=0;i<n;i++) pref[i+1]=pref[i]+lens[i];
  const leftLen = (i)=> (i<=0?0 : pref[i] + (i-1));

  let bestI=1, best=Infinity;
  const minL=4, minR=3;
  for (let i=1;i<n;i++){
    const L = leftLen(i), R = totalChars-L;
    const diff = Math.abs(L-R) + ((L>=minL && R>=minR)?0:20);
    if (diff<best){ best=diff; bestI=i; }
  }
  let part1 = tokens.slice(0,bestI).join(' ');
  let part2 = tokens.slice(bestI).join(' ');
  if (part2.length < minR && bestI>1){
    bestI--; part1 = tokens.slice(0,bestI).join(' '); part2 = tokens.slice(bestI).join(' ');
  }

  const s1=document.createElement('span'); s1.className='ln1'; s1.textContent=part1; frag.appendChild(s1);
  if (part2){ const s2=document.createElement('span'); s2.className='ln2'; s2.textContent=part2; frag.appendChild(s2); }
  return frag;
}

/* ===== regra do total das rifas (paridade 25/30) ===== */
function calculateRifaTotal(count) {
  count = Number(count||0);
  if (count<=0) return 0;
  if (count%2===0) return 25*count;
  return 25*(count-1) + 30;
}

/* ===== atualiza "pílulas" e total do rodapé ===== */
function updatePills(){
  const pP=document.getElementById('pillPecas');
  const pR=document.getElementById('pillRifas');
  const pF=document.getElementById('pillFav');
  if(pP) pP.textContent = 'Peças: ' + selecionadas.size;
  if(pR) pR.textContent = 'Rifas: ' + rifasSel.size;
  if(pF) pF.textContent = 'Favoritas: ' + favoritos.size;
}
function calcularTotal(){
  let total = 0;
  selecionadas.forEach(id=>{
    const p = pecas.find(x=>x.id_peca===id);
    if (p && p.preco) total += parseFloat(p.preco);
  });
  total += calculateRifaTotal(rifasSel.size||0);

  totalGeral = total;
  const totalEl = document.querySelector('.total-display');
  if (totalEl) totalEl.textContent = 'Total: ' + fmt(totalGeral);

  const fTotal=document.getElementById('fTotal');
  if (fTotal) fTotal.value = totalGeral.toFixed(2);
}

/* ======================== GALERIA ======================= */
function renderGaleria(){
  const app=document.getElementById('app');
  app.innerHTML='';
  const section=document.createElement('section'); section.id='galeria';
  const masonry=document.createElement('div'); masonry.className='galeria'; masonry.id='masonryGallery';

  pecas.forEach(p=>{
    if(String(p.status).toUpperCase()==='VENDIDAAA') return;
    const item=document.createElement('div'); item.className='gal-item'; item.dataset.id=p.id_peca;
    const first=(p.imagens&&p.imagens[0])?p.imagens[0]:'';
    const img=imgWithFallback('/img/tmb/'+first+'.avif'); img.alt=p.titulo||('Peça '+p.id_peca);
    item.appendChild(img);
    masonry.appendChild(item);
  });

  section.appendChild(masonry);
  app.appendChild(section);
}

/* ===== auxiliares do feed ===== */
function setPricePadForPost(postEl){
  try{
    const linha1=postEl.querySelector('.linha1');
    const preco=postEl.querySelector('.preco');
    if(!linha1||!preco) return;
    const w=preco.offsetWidth||preco.getBoundingClientRect().width||80;
    linha1.style.setProperty('--price-pad', (w+12)+'px');
  }catch(_){}
}
function applyFeedButtonBehavior(postEl, p){
  // coração
  const heart=postEl.querySelector('.heart');
  if (heart){
    heart.onclick=()=>{
      const id=p.id_peca;
      if (favoritos.has(id)) { favoritos.delete(id); heart.classList.remove('selected'); }
      else { favoritos.add(id); heart.classList.add('selected'); }
      updatePills(); maybeRefreshSelectedBar();
      try{ localStorage.setItem('BSTV_FAV', JSON.stringify([...favoritos])); }catch(_){}
    };
    if (favoritos.has(p.id_peca)) heart.classList.add('selected');
  }
  // adicionar/remover peça
  const addBtn=postEl.querySelector('.add-btn');
  if (addBtn){
    addBtn.onclick=()=>{
      const id=p.id_peca;
      const on = addBtn.classList.toggle('selected');
      if (on) selecionadas.add(id); else selecionadas.delete(id);
      addBtn.textContent= on?'REMOVER':'ADICIONAR';
      updatePills(); calcularTotal(); maybeRefreshSelectedBar();
    };
    if (selecionadas.has(p.id_peca)){ addBtn.classList.add('selected'); addBtn.textContent='REMOVER'; }
  }
}

/* ========================== FEED ======================== */
function renderFeed(){
  const app=document.getElementById('app'); app.innerHTML='';
  const section=document.createElement('section'); section.id='feed';
  const list=document.createElement('div'); list.id='feedList'; list.className='feed';

  pecas.forEach(p=>{
    if(String(p.status).toUpperCase()==='VENDIDAAA') return;

    const post=document.createElement('article'); post.className='post'; post.id='post-'+p.id_peca;

    // carousel
    const carousel=document.createElement('div'); carousel.className='carousel';
    (Array.isArray(p.imagens)?p.imagens:[]).forEach(name=>{
      const slide=document.createElement('div'); slide.className='carousel-slide';
      const img=imgWithFallback('/img/otm/'+name+'.avif');
      slide.appendChild(img); carousel.appendChild(slide);
    });

    // barra de posição (base fixa, só a vermelha anda)
    const barWrap=document.createElement('div'); barWrap.className='carousel-bar-wrap';
    const bar=document.createElement('div'); bar.className='carousel-bar';
    const pos=document.createElement('div'); pos.className='pos'; bar.appendChild(pos); barWrap.appendChild(bar);

    // meta
    const meta=document.createElement('div'); meta.className='meta';

    const l1=document.createElement('div'); l1.className='linha1';
    const title=document.createElement('div'); title.className='titulo'; title.textContent=p.titulo||('Peça '+p.id_peca);
    const price=document.createElement('div'); price.className='preco';  price.textContent=fmt(p.preco);
    l1.appendChild(title); l1.appendChild(price);

    const tecnica=document.createElement('div'); tecnica.className='tecnica'; tecnica.textContent=(p.tecnica||'');
    const dims=document.createElement('div');    dims.className='dimens';  dims.textContent=(p.dimensao||p.tamanho||'');

    const footerMeta=document.createElement('div'); footerMeta.className='meta-footer';
    const left=document.createElement('div'); left.className='left-actions';
    const right=document.createElement('div'); right.className='right-actions';

    const heartBtn=document.createElement('button'); heartBtn.className='heart'; heartBtn.innerHTML='❤';
    heartBtn.setAttribute('aria-label','Favoritar '+(p.titulo||'')); left.appendChild(heartBtn);

    const addBtn=document.createElement('button'); addBtn.className='add-btn';
    addBtn.textContent= selecionadas.has(p.id_peca)?'REMOVER':'ADICIONAR'; right.appendChild(addBtn);

    footerMeta.appendChild(left); footerMeta.appendChild(right);

    meta.appendChild(l1);
    if (tecnica && tecnica.textContent) meta.appendChild(tecnica);
    meta.appendChild(dims);
    meta.appendChild(footerMeta);

    post.appendChild(carousel);
    post.appendChild(barWrap);
    post.appendChild(meta);
    list.appendChild(post);

    // posição da barrinha vermelha
    (function(car, posEl){
      const slides = car.querySelectorAll('.carousel-slide');
      const total = slides.length||1;
      function updatePos(){
        const idx = Math.round(car.scrollLeft / car.clientWidth);
        posEl.style.width = (((idx+1)/Math.max(1,total))*100)+'%';
      }
      car.addEventListener('scroll', ()=>{ window.clearTimeout(car._t); car._t=setTimeout(updatePos,60); });
      updatePos();
    })(carousel, bar.querySelector('.pos'));

    setTimeout(()=>setPricePadForPost(post),60);
    applyFeedButtonBehavior(post,p);
  });

  section.appendChild(list);
  app.appendChild(section);
}

/* ========================== RIFAS ======================= */
function renderRifas(){
  const app=document.getElementById('app'); app.innerHTML='';
  const section=document.createElement('section'); section.id='rifas';
  const grid=document.createElement('div'); grid.className='rifas';

  rifas.forEach(r=>{
    const disponivel = !r.status_rifa || String(r.status_rifa).trim()==='';

    const btn=document.createElement('button');
    btn.className='rifa-btn'+(disponivel?'':' sold');
    const bg=r.hex_rifa||r.hex||'#777';
    btn.style.backgroundColor=bg;
    btn.style.color=getContrastColor(bg);
    btn.dataset.id=r.id_rifa;

    let label = (r.botao_rifa && String(r.botao_rifa).trim())
                ? String(r.botao_rifa).trim()
                : (r.numero || r.id_rifa || '').toString();
    label = label.replace(/^\s*X\s*/i,'').trim();

    btn.appendChild(formatRifaLabelDOM(label));
    btn.setAttribute('aria-label', label);

    if (disponivel){
      btn.addEventListener('click', ()=>{
        const isSelected = btn.classList.toggle('selected');
        if (isSelected){
          rifasSel.add(r.id_rifa);
          btn.style.backgroundColor='#ffffff';
          btn.style.color='#ff0000';
          btn.style.borderColor='#ff0000';
        } else {
          rifasSel.delete(r.id_rifa);
          btn.style.backgroundColor=bg;
          btn.style.color=getContrastColor(bg);
          btn.style.borderColor='';
        }
        updatePills(); calcularTotal(); maybeRefreshSelectedBar();
      });
    }

    grid.appendChild(btn);
  });

  section.appendChild(grid);
  app.appendChild(section);
}

/* ===================== NAVEGAÇÃO (hash) ================= */
function showPage(page, opts={}){
  const updateHash = (typeof opts.updateHash==='boolean')?opts.updateHash:true;
  const pieceId = opts.pieceId||null;

  if (page==='galeria') renderGaleria();
  else if (page==='feed'){ renderFeed(); if (pieceId) setTimeout(()=>openFeedAt(pieceId),80); }
  else if (page==='rifas') renderRifas();
  else renderGaleria();

  updatePills(); calcularTotal();

  if (updateHash){
    let newHash=page;
    if (pieceId){ const q=new URLSearchParams(); q.set('p',pieceId); newHash=`${page}?${q.toString()}`; }
    if (location.hash!=='#'+newHash) location.hash=newHash;
  }
}
function parseHash(){
  const raw=(location.hash||'').slice(1);
  if (!raw) return {page:'galeria', params:new URLSearchParams()};
  const [pagePart,query]=raw.split('?');
  return { page: (pagePart||'galeria'), params: new URLSearchParams(query||'') };
}
function handleHashChange(){
  const {page,params}=parseHash();
  if (page==='feed'){
    const p=params.get('p');
    if (p) showPage('feed',{updateHash:false,pieceId:p});
    else   showPage('feed',{updateHash:false});
  } else if (page==='rifas'){
    showPage('rifas',{updateHash:false});
  } else {
    showPage('galeria',{updateHash:false});
  }
}
window.addEventListener('hashchange', handleHashChange);

document.querySelectorAll('.nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    const href=a.getAttribute('href')||'';
    if (href.startsWith('#')){
      e.preventDefault();
      const target=href.slice(1);
      location.hash = (target==='feed') ? 'feed' : target;
    }
  });
});

/* =================== Delegação do #app ================== */
function attachAppDelegation(){
  const app=document.getElementById('app');
  app.addEventListener('click', (e)=>{
    // clique na thumb da galeria -> abre feed na peça
    const item=e.target.closest('.gal-item');
    if (item){
      const id=item.dataset.id;
      if (id) location.hash='feed?p='+encodeURIComponent(id);
      return;
    }
  });
}

/* =================== Checkout (footer) ================== */
function attachBindings(){
  const checkoutBtn=document.getElementById('btnCheckout');
  if (!checkoutBtn) return;
  checkoutBtn.onclick=(e)=>{
    e.preventDefault();
    calcularTotal();
    document.getElementById('app').innerHTML = `
      <section id="checkout">
        <div style="max-width:480px;margin:0 auto;background:#fff;border:1px solid #2b2424;padding:20px">
          <h2>Preencha seus dados</h2>
          <label>Nome *</label><input id="nome" type="text" style="width:100%">
          <label>E-mail *</label><input id="email" type="email" style="width:100%">
          <label>Telefone</label><input id="telefone" type="tel" style="width:100%">
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="voltarCheckout" style="flex:1">Voltar</button>
            <button id="prosseguirCheckout" style="flex:1;background:var(--red);color:#fff">Prosseguir</button>
          </div>
        </div>
      </section>`;
    document.getElementById('voltarCheckout').onclick=()=> showPage('galeria');
    document.getElementById('prosseguirCheckout').onclick=()=>{
      const nome=(document.getElementById('nome').value||'').trim();
      const email=(document.getElementById('email').value||'').trim();
      if (!nome||!email){ alert('Preencha nome e e-mail'); return; }
      document.getElementById('fNome').value=nome;
      document.getElementById('fEmail').value=email;
      document.getElementById('fTelefone').value=(document.getElementById('telefone').value||'').trim();
      document.getElementById('fPecas').value=[...selecionadas].join(',');
      document.getElementById('fRifas').value=[...rifasSel].join(',');
      document.getElementById('fFav').value=[...favoritos].join(',');
      document.getElementById('fTotal').value=totalGeral.toFixed(2);
      try{
        const fd=new FormData();
        fd.append('nome',nome); fd.append('email',email);
        fd.append('telefone', (document.getElementById('telefone').value||'').trim());
        fd.append('pecas',[...selecionadas].join(',')); fd.append('rifas',[...rifasSel].join(','));
        fd.append('favoritas',[...favoritos].join(',')); fd.append('total', totalGeral.toFixed(2));
        fetch(GAS_URL,{method:'POST',body:fd,mode:'no-cors'});
      }catch(_){}
      document.getElementById('hiddenForm').submit();
    };
  };
}

/* ========== MONITORA footer (apenas aviso em console) ========== */
(function(){
  const footer=document.querySelector('footer');
  if (!footer) return;
  const mo=new MutationObserver(()=>{
    if(!document.getElementById('btnCheckout')){
      console.warn('Footer alterado: btnCheckout ausente. Verifique alterações acidentais.');
    }
  });
  mo.observe(footer,{childList:true,subtree:true});
})();

/* ============== BARRA DE ITENS SELECIONADOS ============== */
/* DOM mínimo (se não existir, cria) */
function ensureSelectedBarDOM(){
  if (document.getElementById('selectedBar')) return;
  const bar=document.createElement('div');
  bar.id='selectedBar';
  bar.className='selected-bar is-hidden';
  bar.setAttribute('aria-hidden','true');
  bar.innerHTML = `
    <div class="sb-inner">
      <div class="sb-title"></div>
      <div class="sb-wrap"></div>
      <button type="button" class="sb-close" aria-label="Fechar">✕</button>
    </div>`;
  document.body.appendChild(bar);
  bar.querySelector('.sb-close').addEventListener('click', hideSelectedBar);

  // liga as pílulas do rodapé
  const pP=document.getElementById('pillPecas');
  const pR=document.getElementById('pillRifas');
  const pF=document.getElementById('pillFav');
  if (pP) pP.addEventListener('click', ()=> toggleSelectedBar('pecas'));
  if (pR) pR.addEventListener('click', ()=> toggleSelectedBar('rifas'));
  if (pF) pF.addEventListener('click', ()=> toggleSelectedBar('favoritas'));
}
let selectedBarMode=null;

function showSelectedBar(){
  const bar=document.getElementById('selectedBar'); if(!bar) return;
  bar.classList.remove('is-hidden'); bar.setAttribute('aria-hidden','false');
}
function hideSelectedBar(){
  const bar=document.getElementById('selectedBar'); if(!bar) return;
  bar.classList.add('is-hidden'); bar.setAttribute('aria-hidden','true');
  selectedBarMode=null;
}
function maybeRefreshSelectedBar(){ if (selectedBarMode) renderSelectedBar(selectedBarMode); }

function buildSBCardForPiece(pieceId, fromSet){
  const p=pecas.find(x=>x.id_peca===pieceId); if(!p) return null;
  const first=(p.imagens&&p.imagens[0])?p.imagens[0]:'';
  const card=document.createElement('div'); card.className='sb-item'; card.dataset.id=pieceId;

  const img=imgWithFallback('/img/tmb/'+first+'.avif'); img.className='sb-thumb';
  img.alt=p.titulo||('Peça '+pieceId); card.appendChild(img);

  const x=document.createElement('button'); x.className='sb-remove'; x.textContent='X';
  x.setAttribute('aria-label','Remover '+(p.titulo||'peça'));
  x.addEventListener('click', ()=>{
    if (fromSet==='selecionadas') selecionadas.delete(pieceId);
    else favoritos.delete(pieceId);
    updatePills(); calcularTotal(); maybeRefreshSelectedBar();
  });
  card.appendChild(x);
  return card;
}
function buildSBChipForRifa(rifaId){
  const r=rifasById.get(rifaId); if(!r) return null;
  const chip=document.createElement('button'); chip.className='sb-rifa'; chip.dataset.id=rifaId;
  const bg=r.hex_rifa||r.hex||'#777'; chip.style.backgroundColor=bg; chip.style.color=getContrastColor(bg);
  const raw=(r.botao_rifa && String(r.botao_rifa).trim()) ? String(r.botao_rifa).trim() : (r.numero||r.id_rifa||'').toString();
  chip.appendChild(formatRifaLabelDOM(raw));
  chip.addEventListener('click', ()=>{
    rifasSel.delete(rifaId);
    updatePills(); calcularTotal(); maybeRefreshSelectedBar();
  });
  return chip;
}
function renderSelectedBar(mode){
  ensureSelectedBarDOM();
  const bar=document.getElementById('selectedBar'); if(!bar) return;
  selectedBarMode=mode;

  bar.querySelector('.sb-title').textContent =
    mode==='pecas'     ? 'Peças selecionadas'
  : mode==='favoritas' ? 'Favoritas'
  :                      'Rifas selecionadas';

  const wrap=bar.querySelector('.sb-wrap'); wrap.innerHTML='';
  if (mode==='pecas'){    [...selecionadas].forEach(id=>{ const c=buildSBCardForPiece(id,'selecionadas'); if(c) wrap.appendChild(c); }); }
  else if (mode==='favoritas'){ [...favoritos].forEach(id=>{ const c=buildSBCardForPiece(id,'favoritos'); if(c) wrap.appendChild(c); }); }
  else {                  [...rifasSel].forEach(id=>{ const c=buildSBChipForRifa(id); if(c) wrap.appendChild(c); }); }

  showSelectedBar();
}
function toggleSelectedBar(mode){
  if (selectedBarMode===mode) hideSelectedBar();
  else renderSelectedBar(mode);
}

/* =========================== INIT ======================= */
async function init(){
  try{
    // zera favoritos persistidos (conforme pedido em versões anteriores)
    localStorage.removeItem('BSTV_FAV'); favoritos.clear();

    const [rp, rr] = await Promise.all([
      fetch(PECAS_JSON_URL,{cache:'no-store'}),
      fetch(RIFAS_JSON_URL,{cache:'no-store'})
    ]);
    if(!rp.ok||!rr.ok) throw new Error('Falha ao carregar JSONs');

    pecas = await rp.json();
    rifas = await rr.json();
    rifasById = new Map(rifas.map(r=>[r.id_rifa, r]));

    renderGaleria();
    attachAppDelegation();
    attachBindings();
    ensureSelectedBarDOM();

    updatePills(); calcularTotal();
    handleHashChange(); // processa deep-link inicial (#feed?p=ID etc.)
  }catch(e){
    console.error('Init error', e);
    document.getElementById('app').innerHTML =
      '<div style="padding:20px;color:#900;">Erro ao carregar dados. Veja o console.</div>';
  }
}
window.addEventListener('DOMContentLoaded', init);
</script>


</body>
</html>
