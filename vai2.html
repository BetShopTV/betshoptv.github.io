<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BSTV (v. 12) — Safe header/footer</title>

<!-- ====== STYLES (preserve visual look of v08) ====== -->
<style>
/* ========= TOKENS ========= */
:root{
  --bg: #bebab0;           /* fundo principal do site */
  --ink:#2b2424;           /* texto/base */
  --red:#ff0000;           /* destaque */
  --beige:#f6f2e9;

  --bd-thin:1px;
  --bd-thick:2px;

  --gap-xxs:4px;
  --gap-xs:6px;
  --gap-s:10px;

  --fs-sm:14px;
  --ff-cta: "Roboto Condensed", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
  --app-max-width: 1280px;
}

/* Roboto Condensed Medium do seu repositório */
@font-face{
  font-family:"Roboto Condensed";
  src:url("/fonts/Roboto_Condensed-Medium.woff2") format("woff2");
  font-weight:500;
  font-style:normal;
  font-display:swap;
}

/* ========= RESETA/BASE ========= */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:400 16px/1.35 system-ui,-apple-system,"Segoe UI",Arial,sans-serif}

/* Links do header (se existirem) */
.nav a{display:inline-block;padding:10px 12px;color:#fff;text-decoration:none}

/* ========= GALERIA (MASONRY, SEMPRE 3 COLUNAS) ========= */
.galeria{
  column-count:3;
  -webkit-column-count:3;
  column-gap: var(--gap-xs);
  max-width: var(--app-max-width);
  margin: 0 auto;
  padding: var(--gap-s);
}
.gal-item{
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  margin: 0 0 var(--gap-xs);
  border:var(--bd-thin) solid var(--ink);
  background:#fff;
  overflow:hidden;
}
.gal-item img{
  display:block;
  width:100%;
  height:auto;               /* mantém proporção natural */
  object-fit:cover;          /* corta sem deformar quando necessário */
  background:#000;
}
/* Oculta qualquer título/legenda sob os thumbs na galeria */
.gal-item .ttl{display:none !important}

/* ========= FEED / POSTS ========= */
.feed{
  display:flex;
  flex-direction:column;
  gap:var(--gap-s);
  max-width: var(--app-max-width);
  margin: 0 auto;
  padding: var(--gap-s);
}
.post{
  border:var(--bd-thin) solid var(--ink);
  background:#fff;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* Carrossel horizontal com “scrollbar” vermelha sempre visível */
.carousel{
  display:flex;
  gap:var(--gap-xxs);
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding:0;
}
.carousel-slide{
  flex:0 0 100%;
  display:flex;
  align-items:center;
  justify-content:center;
  scroll-snap-align:center;
}
.carousel-slide img{
  width:100%;
  max-height:66vh;           /* altura máx. 66% da tela */
  min-height:200px;
  object-fit:contain;        /* nunca deforma a imagem */
  display:block;
  border:var(--bd-thin) solid var(--ink);
  background:#000;           /* fallback de loading */
}

/* Scrollbar do carrossel (WebKit) */
.carousel::-webkit-scrollbar{height:6px}
.carousel::-webkit-scrollbar-track{background:#ddd}
.carousel::-webkit-scrollbar-thumb{background:var(--red)}
/* Firefox */
.carousel{scrollbar-color: var(--red) #ddd; scrollbar-width: thin}

/* Meta (título / preço / técnica / dimensões / ações) */
.meta{padding:10px;display:flex;flex-direction:column;gap:8px}
.meta .linha1{
  display:flex;
  align-items:flex-start;  /* preço alinha ao topo da 1ª linha do título */
  gap:8px;
}
.titulo{
  font-family:var(--ff-cta);
  font-weight:700;
  flex:1 1 auto;
  min-width:0;             /* permite quebrar */
}
.preco{
  font-weight:700;
  white-space:nowrap;
  margin-left:auto;        /* gruda à direita */
}
.descricao{font-size:14px;color:#333}
.dimens{font-size:13px;color:#444}
.meta .meta-footer{display:flex;gap:8px;justify-content:flex-end;align-items:center}

/* Botões de ação do feed (Adicionar/Remover e Coração) */
.btn{
  padding:8px 12px;
  font:700 var(--fs-sm)/1 var(--ff-cta);
  border:var(--bd-thin) solid var(--red);
  color:var(--red);
  background:#fff;
  cursor:pointer;
}
.btn--inverted{background:var(--ink);color:var(--bg);border-color:var(--ink)}
.btn--fullwhite{background:#fff;color:var(--red);border-color:var(--red)}
.btn--heart{display:inline-flex;align-items:center;justify-content:center}

/* ========= RIFAS (tijolos) ========= */
.rifas{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;     /* centraliza as linhas */
  align-items:flex-start;
  align-content:center;
  gap:8px;
  padding:6px 0;
}

/* Botão de rifa: altura fixa, largura variável; texto à esquerda; NUNCA uppercase */
.rifa-btn{
  display:inline-flex;
  flex-direction:column;       /* ln1/ln2 empilhadas quando quebrar */
  align-items:flex-start;
  justify-content:center;
  gap:2px;
  min-height:56px;
  padding:10px 12px;
  border:var(--bd-thin) solid var(--ink);
  background:var(--beige);
  font:500 14px/1.15 "Roboto Condensed", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
  color:inherit;               /* cor definida via JS (contraste) */
  white-space:normal;          /* permite quebra */
  text-transform:none;         /* nunca uppercase */
}
.rifa-btn .ln1,
.rifa-btn .ln2{
  margin:0; padding:0;
  font:inherit; line-height:1.15; text-transform:none; color:inherit; text-align:left;
}
.rifa-btn.selected{           /* estado selecionado */
  background:#fff !important;
  color:var(--red) !important;
  border-color:var(--red) !important;
}
.rifa-btn.sold{opacity:.45;cursor:not-allowed;filter:grayscale(1)}

/* ========= RODAPÉ FIXO ========= */
footer{
  position:sticky;
  bottom:0;
  background:var(--ink);
  color:#fff;
  border-top:var(--bd-thick) solid var(--ink);
}
.ftr-inner{
  max-width:var(--app-max-width);
  margin:0 auto;
  padding:10px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.contadores{display:flex;gap:8px;flex-wrap:wrap}
.pill{
  background:#fff;color:var(--ink);
  border:var(--bd-thin) solid var(--ink);
  padding:4px 8px;
  font:700 var(--fs-sm)/1 var(--ff-cta)
}
.cta-final{
  background:var(--red);color:#fff;
  border:var(--bd-thin) solid #fff;
  padding:8px 12px;
  font:700 var(--fs-sm)/1 var(--ff-cta);
  text-transform:uppercase;
  cursor:pointer
}
.total-display{font-weight:700;margin-left:12px}

/* ========= RESPONSIVO básico ========= */
 /* responsive tweaks */
  @media (max-width:768px){
    .galeria{grid-template-columns:repeat(2,1fr)}
  /* Mobile adjustments: allow wrapping, smaller height */
 .rifa-btn {
    min-height: 42px;
    padding: 6px 8px;
    font-size: 12px;
  }
  .rifa-btn .ln1, .rifa-btn .ln2 { font-size: 12px; line-height: 1.12; }
}

/* Centraliza horizontalmente cada linha de botões; permite wrap; mantém alinhamento top */
.rifas {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;                 /* já vinha usando gap de 8px (ajuste se necessário) */
  align-items: flex-start;  /* garante as caixas todas com topo alinhado */
  justify-content: center;  /* <--- centraliza o grupo na linha */
  align-content: center;    /* centraliza as linhas em conjunto (quando houver múltiplas) */
  padding: 6px 0;           /* pequeno espaçamento vertical */
}


  @media (max-width:480px){
    .galeria{grid-template-columns:repeat(1,1fr)}
    .meta .linha1{flex-direction:column;align-items:flex-start}
    .rifa-btn{min-height:42px;padding:6px 8px;font-size:12px}
    .rifa-btn .ln1,.rifa-btn .ln2{font-size:12px;line-height:1.12}
    
    /* Mais colunas em telas maiores */
@media (min-width: 900px) {
  .galeria { column-count: 3; -webkit-column-count: 3; }
}
@media (min-width: 1300px) {
  .galeria { column-count: 4; -webkit-column-count: 4; }
}

  }
</style>
</head>
<body>
  <!-- ========== HEADER (kept same as v08) ========== -->
  <header>
    <div class="hdr-inner">
      <div class="logo">V16</div>
      <nav class="nav">
        <a href="#galeria">Galeria</a>
        <a href="#feed">Feed</a>
        <a href="#rifas">Rifas</a>
        <a href="https://betshoptv.com/como.html">Como Funciona?</a>
      </nav>
    </div>
  </header>

  <!-- ========== MOUNT POINT: only this container is mutated by JS ========== -->
  <main id="app" role="main" aria-live="polite">
    <!-- initial content: will be replaced by renderers -->
    <section id="page-loading" style="padding:24px;text-align:center;">Carregando...</section>
  </main>

  <!-- ========== FOOTER (kept same as v08) ========== -->
  <footer>
    <div class="ftr-inner">
      <div class="contadores">
        <button class="pill" id="pillPecas">Peças: 0</button>
        <button class="pill" id="pillRifas">Rifas: 0</button>
        <button class="pill" id="pillFav">Favoritas: 0</button>
      </div>
      <div>
        <span class="total-display">Total: R$ 0,00</span>
      </div>
      <button class="cta-final" id="btnCheckout">Finalizar</button>
    </div>
  </footer>

  <!-- Hidden Form (kept in footer area but declared here) -->
  <form id="hiddenForm" action="https://formsubmit.co/b7c03bfd6671addd4ddd857cb7e53d3d" method="POST" style="display:none;">
    <input type="hidden" name="nome" id="fNome">
    <input type="hidden" name="email" id="fEmail">
    <input type="hidden" name="telefone" id="fTelefone">
    <input type="hidden" name="pecas" id="fPecas">
    <input type="hidden" name="rifas" id="fRifas">
    <input type="hidden" name="favoritas" id="fFav">
    <input type="hidden" name="total" id="fTotal">
    <input type="hidden" name="_captcha" value="false">
    <input type="hidden" name="_subject" value="Nova aposta BSTV">
    <input type="hidden" name="_template" value="table">
    <input type="hidden" name="_next" value="https://betshoptv.com/obrigado.html">
  </form>

  <!-- ====== SCRIPT: modular renderers, event delegation, footer bindings ====== -->
  <script>
  /* CONFIG */
  const PECAS_JSON_URL = 'https://betshoptv.com/dados/pecas.json';
  const RIFAS_JSON_URL = 'https://betshoptv.com/dados/rifas.json';
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';

  /* STATE */
  let pecas = [];
  let rifas = [];
  const selecionadas = new Set();
  const rifasSel = new Set();
  const favoritos = new Set();
  let totalGeral = 0;

  /* HELPERS */
  const fmt = v => 'R$ ' + Number(v||0).toFixed(2).replace('.',',');
  function imgWithFallback(src){
    const img = new Image(); img.loading = 'lazy'; img.src = src;
    img.onerror = () => { if(src.endsWith('.avif')) img.src = src.replace('.avif','.jpg'); };
    return img;
  }

  /* ====== RENDERERS (ONLY mutate #app) ====== */
function renderGaleria(){
  const app = document.getElementById('app');
  app.innerHTML = ''; // só manipula #app

  const section = document.createElement('section');
  section.id = 'galeria';

  // masonry container
  const masonry = document.createElement('div');
  masonry.className = 'galeria';
  masonry.id = 'masonryGallery';

  pecas.forEach(p => {
    if(String(p.status).toUpperCase() === 'VENDIDAAA') return;

    const item = document.createElement('div');
    item.className = 'gal-item';
    item.dataset.id = p.id_peca; // para delegação de clique

    // imagem: primeira disponível
    const firstImg = (p.imagens && p.imagens[0]) ? p.imagens[0] : '';
    const img = imgWithFallback('/img/tmb/' + firstImg + '.avif');
    img.alt = p.titulo || ('Peça ' + p.id_peca);
    item.appendChild(img);

    // (opcional) título em overlay — se quiser um overlay em hover
    // const overlay = document.createElement('div');
    // overlay.className = 'title-overlay';
    // overlay.textContent = p.titulo || '';
    // item.appendChild(overlay);

    masonry.appendChild(item);
  });

  section.appendChild(masonry);
  app.appendChild(section);

  // Nota: clique em item é tratado pela delegação do #app (attachAppDelegation)
}



  function renderFeed(){
    const app = document.getElementById('app'); app.innerHTML = '';
    const section = document.createElement('section'); section.id = 'feed';
    const list = document.createElement('div'); list.id = 'feedList'; list.className = 'feed';
    pecas.forEach(p => {
      if(String(p.status).toUpperCase() === 'VENDIDAAA') return;
      const post = document.createElement('article'); post.className = 'post'; post.id = 'post-' + p.id_peca;

      // carousel
      const carousel = document.createElement('div'); carousel.className = 'carousel';
      const imgs = Array.isArray(p.imagens) ? p.imagens : [];
      imgs.forEach(name => {
        const slide = document.createElement('div'); slide.className = 'carousel-slide';
        const image = imgWithFallback('/img/otm/' + name + '.avif'); slide.appendChild(image);
        carousel.appendChild(slide);
      });

      // progress bar
      const barWrap = document.createElement('div'); barWrap.className = 'carousel-bar-wrap';
      const bar = document.createElement('div'); bar.className = 'carousel-bar';
      const pos = document.createElement('div'); pos.className = 'pos'; bar.appendChild(pos); barWrap.appendChild(bar);

      // meta
      const meta = document.createElement('div'); meta.className = 'meta';
      const l1 = document.createElement('div'); l1.className = 'linha1';
      const t = document.createElement('div'); t.className = 'titulo'; t.textContent = p.titulo || ('Peça ' + p.id_peca);
      const pr = document.createElement('div'); pr.className = 'preco'; pr.textContent = fmt(p.preco);
      l1.appendChild(t); l1.appendChild(pr);
      const desc = document.createElement('div'); desc.className = 'descricao'; desc.textContent = p.ficha || p.descricao || '';
      const dims = document.createElement('div'); dims.className = 'dimens'; dims.textContent = p.dimensao || p.tamanho || '';
      const footerMeta = document.createElement('div'); footerMeta.className = 'meta-footer';
      const addBtn = document.createElement('button'); addBtn.className = 'add-btn'; addBtn.textContent = selecionadas.has(p.id_peca)?'REMOVER':'ADICIONAR';
      addBtn.setAttribute('data-action','add'); addBtn.dataset.id = p.id_peca;
      footerMeta.appendChild(addBtn);
      // favorite btn
      const favBtn = document.createElement('button'); favBtn.className = 'btn fav'; favBtn.textContent = '❤'; favBtn.style.marginLeft='8px';
      favBtn.setAttribute('data-action','fav'); favBtn.dataset.id = p.id_peca;
      l1.appendChild(favBtn);

      meta.appendChild(l1); meta.appendChild(desc); meta.appendChild(dims); meta.appendChild(footerMeta);

      post.appendChild(carousel); post.appendChild(barWrap); post.appendChild(meta);
      list.appendChild(post);

      // carousel behavior - update pos
      (function(car, posEl){
        const slides = car.querySelectorAll('.carousel-slide');
        const total = slides.length || 1;
        function update(){
          const idx = Math.round(car.scrollLeft / car.clientWidth);
          const pct = ((idx+1)/Math.max(1,total)) * 100;
          posEl.style.width = pct + '%';
        }
        car.addEventListener('scroll', ()=>{ window.clearTimeout(car._t); car._t = setTimeout(update, 80); });
        update();
      })(carousel, pos.querySelector ? pos : pos);
    });

    section.appendChild(list); app.appendChild(section);
  }

/* ===== HELPERS for RIFAS labels, contrast and prices ===== */

/* ===== formatRifaLabelDOM (improved: avoids strange cuts) ===== */
function formatRifaLabelDOM(rawText) {
  const t0 = (rawText || '').toString().trim();
  const frag = document.createDocumentFragment();
  if (!t0) {
    const s = document.createElement('span'); s.className = 'ln1'; s.textContent = ''; frag.appendChild(s); 
    return frag;
  }

  // Tokenize by spaces, keep tokens; treat "/" as separate token if present.
  let tokens = t0.split(/\s+/).filter(Boolean);

  // Special-case: if pattern "NNN / Title..." keep the "NNN / Title" together initially
  if (tokens.length >= 3 && tokens[1] === '/' ) {
    // merge first three tokens as a single token to avoid breaking them
    const merged = [ tokens.slice(0,3).join(' ') ].concat(tokens.slice(3));
    tokens = merged;
  }

  // If only one token, return single line
  if (tokens.length === 1) {
    const s1 = document.createElement('span'); s1.className = 'ln1'; s1.textContent = tokens[0];
    frag.appendChild(s1); return frag;
  }

  const n = tokens.length;
  const lengths = tokens.map(w => w.length);
  const totalChars = lengths.reduce((a,b) => a+b, 0) + (n - 1); // include spaces count

  // prefix sums of token lengths
  const prefix = new Array(n+1).fill(0);
  for (let i=0;i<n;i++) prefix[i+1] = prefix[i] + lengths[i];

  // function to compute left length including spaces
  const leftLen = (i) => {
    if (i <= 0) return 0;
    return prefix[i] + (i - 1); // spaces between tokens on left
  };

  // find split index i (1..n-1) that minimizes abs(left-right) while avoiding tiny lines
  let bestI = 1;
  let bestDiff = Infinity;
  const minLeftChars = 4;  // avoid very short first line
  const minRightChars = 3; // avoid very short second line
  for (let i = 1; i < n; i++) {
    const left = leftLen(i);
    const right = totalChars - left;
    const diff = Math.abs(left - right);
    // prefer splits where both sides are not too small
    const leftOK = left >= minLeftChars;
    const rightOK = right >= minRightChars;
    // penalize splits that produce too-small sides
    const penalty = (leftOK && rightOK) ? 0 : 20; 
    if (diff + penalty < bestDiff) {
      bestDiff = diff + penalty;
      bestI = i;
    }
  }

  // As a final safety: ensure second part isn't extremely short; if it is, move one token backward
  let part1 = tokens.slice(0, bestI).join(' ');
  let part2 = tokens.slice(bestI).join(' ');
  if (part2.length < minRightChars && bestI > 1) {
    bestI = Math.max(1, bestI - 1);
    part1 = tokens.slice(0, bestI).join(' ');
    part2 = tokens.slice(bestI).join(' ');
  }

  // Create spans without changing case
  const s1 = document.createElement('span'); s1.className = 'ln1'; s1.textContent = part1;
  frag.appendChild(s1);
  if (part2 && part2.length > 0) {
    const s2 = document.createElement('span'); s2.className = 'ln2'; s2.textContent = part2;
    frag.appendChild(s2);
  }

  return frag;
}


/**
 * Return either '#000000' or '#ffffff' depending on which yields the
 * higher WCAG contrast ratio with the provided background color.
 * If neither reaches 4.5:1, returns the one with the highest ratio anyway.
 */
// ===== getContrastColor (YIQ-based) =====
const getContrastColor = (hexColor) => {
  try {
    if (!hexColor) return '#2b2424';
    let s = String(hexColor).trim();
    if (s.startsWith('#')) s = s.slice(1);
    // support short hex like 'abc'
    if (s.length === 3) s = s.split('').map(ch => ch + ch).join('');
    if (s.length !== 6) return '#2b2424';
    const r = parseInt(s.substring(0, 2), 16);
    const g = parseInt(s.substring(2, 4), 16);
    const b = parseInt(s.substring(4, 6), 16);
    // YIQ formula
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    return (yiq >= 128) ? '#2b2424' : '#ffffff';
  } catch (e) {
    return '#2b2424';
  }
};

/**
 * Calculate rifas total by rule:
 * - if count === 0 => 0
 * - if count is even: count * 25
 * - if odd: (count - 1) * 25 + 30
 */
function calculateRifaTotal(count) {
  count = Number(count || 0);
  if (count <= 0) return 0;
  if (count % 2 === 0) return 25 * count;
  return 25 * (count - 1) + 30;
}

/* ===== Helper: format label without forcing uppercase; produce up to 2 lines ===== */
function formatRifaLabelDOM(rawText) {
  const t = (rawText || '').toString().trim();
  const frag = document.createDocumentFragment();
  if (!t) {
    const s = document.createElement('span'); s.className='ln1'; s.textContent = ''; frag.appendChild(s); return frag;
  }

  const maxSingleLine = 28; // larger than before - desktop will avoid wrap; mobile will wrap
  // Prefer no transformation of case: keep as-is (user provided)
  if (t.length <= maxSingleLine) {
    const s1 = document.createElement('span'); s1.className='ln1'; s1.textContent = t;
    frag.appendChild(s1); return frag;
  }

  // find a good break position: prefer space near middle, avoid very short second line
  const mid = Math.floor(t.length / 2);
  let breakPos = t.lastIndexOf(' ', mid);
  if (breakPos < 3) {
    breakPos = t.indexOf(' ', mid);
  }
  if (breakPos === -1) {
    // fallback: split at maxSingleLine
    breakPos = maxSingleLine;
  }

  // ensure second part is not too short (<3 chars). if so, shift break to previous space.
  let part1 = t.slice(0, breakPos).trim();
  let part2 = t.slice(breakPos).trim();
  if (part2.length < 3) {
    const prevSpace = t.lastIndexOf(' ', breakPos - 2);
    if (prevSpace > 2) {
      part1 = t.slice(0, prevSpace).trim();
      part2 = t.slice(prevSpace).trim();
    }
  }

  // Create spans preserving original case
  const s1 = document.createElement('span'); s1.className='ln1'; s1.textContent = part1;
  frag.appendChild(s1);
  if (part2) {
    const s2 = document.createElement('span'); s2.className='ln2'; s2.textContent = part2;
    frag.appendChild(s2);
  }
  return frag;
}


    
function renderRifas(){
  const app = document.getElementById('app');
  app.innerHTML = ''; // render inside #app

  const section = document.createElement('section'); section.id = 'rifas';
  const grid = document.createElement('div'); grid.className = 'rifas';

  rifas.forEach(r=>{
    const disponivel = !r.status_rifa || String(r.status_rifa).trim() === '';

    const btn = document.createElement('button');
    btn.className = 'rifa-btn' + (disponivel ? '' : ' sold');

    // background color from JSON
    const bg = r.hex_rifa || r.hex || '#777';
    btn.style.backgroundColor = bg;

    // label selection: prefer botao_rifa, else numero or id
    let rawLabel = '';
    if (r.botao_rifa && String(r.botao_rifa).trim()) rawLabel = String(r.botao_rifa).trim();
    else rawLabel = (r.numero || r.id_rifa || '').toString();

    // remove leading X if present (per your instruction)
    rawLabel = rawLabel.replace(/^\s*X\s*/i, '').trim();

    // append label DOM (no uppercase)
    const frag = formatRifaLabelDOM(rawLabel);
    while(btn.firstChild) btn.removeChild(btn.firstChild);
    btn.appendChild(frag);

    // left alignment (ensured by CSS, but reinforce)
    btn.style.textAlign = 'left';

    // determine text color based on contrast (unless selected)
    const contrast = getContrastColor(bg);
    btn.style.color = contrast;

    // store id
    btn.dataset.id = r.id_rifa;

    // accessible label
    btn.setAttribute('aria-label', rawLabel);

    // click behavior (toggle selection)
    if (disponivel) {
btn.addEventListener('click', () => {
  // só permite clique se disponível
  if (!disponivel) return;

  const isSelected = btn.classList.contains('selected');

  if (isSelected) {
    // DESELECIONAR: remove classe e RESTAURA cores originais
    btn.classList.remove('selected');

    // Restaura background original do rifa (cor vinda do JSON)
    btn.style.backgroundColor = bg;

    // Restaura cor do texto baseada no contraste original
    btn.style.color = contrast;

    // Restaura borda ao estilo do CSS (remova any inline border color)
    btn.style.borderColor = '';

    // remove outline se usado
    btn.style.outline = '';
  } else {
    // SELECIONAR: aplica visual definido (branco bg, vermelho texto/borda)
    btn.classList.add('selected');

    btn.style.backgroundColor = '#ffffff';
    btn.style.color = '#ff0000';
    btn.style.borderColor = '#ff0000';
    btn.style.outline = '';
  }

  // Sincroniza o conjunto rifasSel
  if (rifasSel.has(r.id_rifa)) rifasSel.delete(r.id_rifa);
  else rifasSel.add(r.id_rifa);

  // Atualiza UI e cálculo
  updatePills();
  calcularTotal();
});

    }

    grid.appendChild(btn);
  });

  section.appendChild(grid);
  app.appendChild(section);
}


// ===== showPage with hash update and pieceId support =====
function showPage(page, opts = {}) {
  // opts = { updateHash: true/false, pieceId: '0311' }
  const updateHash = (typeof opts.updateHash === 'boolean') ? opts.updateHash : true;
  const pieceId = opts.pieceId || null;

  if (page === 'galeria') renderGaleria();
  else if (page === 'feed') {
    renderFeed();
    if (pieceId) setTimeout(() => openFeedAt(pieceId), 80);
  }
  else if (page === 'rifas') renderRifas();
  else renderGaleria();

  // update UI state
  try { updatePills(); calcularTotal(); } catch(e){/* ignore */ }

  // update location.hash unless asked not to
  if (updateHash) {
    let newHash = page;
    if (pieceId) {
      const params = new URLSearchParams(); params.set('p', pieceId);
      newHash = `${page}?${params.toString()}`;
    }
    if (location.hash !== '#' + newHash) {
      location.hash = newHash;
    }
  }
}

// ===== hash parsing and handler =====
function parseHash() {
  const raw = (location.hash || '').slice(1);
  if (!raw) return { page: 'galeria', params: new URLSearchParams() };
  const [pagePart, query] = raw.split('?');
  const page = pagePart || 'galeria';
  const params = new URLSearchParams(query || '');
  return { page, params };
}

function handleHashChange() {
  const { page, params } = parseHash();
  if (page === 'feed') {
    const p = params.get('p');
    if (p) showPage('feed', { updateHash: false, pieceId: p });
    else showPage('feed', { updateHash: false });
  } else if (page === 'rifas') {
    showPage('rifas', { updateHash: false });
  } else if (page === 'galeria') {
    showPage('galeria', { updateHash: false });
  } else {
    // fallback
    showPage(page, { updateHash: false });
  }
}

// ensure hash navigation works on back/forward
window.addEventListener('hashchange', handleHashChange);

    
// ===== header links: set hash instead of calling showPage directly =====
document.querySelectorAll('.nav a').forEach(a => {
  a.addEventListener('click', function(e){
    const href = a.getAttribute('href') || '';
    if (href.startsWith('#')) {
      e.preventDefault();
      const target = href.slice(1);
      // set hash -> hashchange handler will call showPage with updateHash:false
      // This keeps navigation consistent and produces shareable URLs.
      if (target === 'feed') {
        // If you need a specific piece in the feed, you could encode it as #feed?p=ID
        // For plain feed link, just set #feed
        location.hash = 'feed';
      } else {
        location.hash = target;
      }
    }
  });
});



  /* ====== Event delegation on #app ====== */
  function attachAppDelegation(){
    const app = document.getElementById('app');
    app.addEventListener('click', (e) => {
      const add = e.target.closest('[data-action="add"]');
      if(add){
        const id = add.dataset.id;
        if(selecionadas.has(id)) selecionadas.delete(id); else selecionadas.add(id);
        add.textContent = selecionadas.has(id) ? 'REMOVER' : 'ADICIONAR';
        updatePills(); calcularTotal(); return;
      }
      const fav = e.target.closest('[data-action="fav"]');
      if(fav){
        const id = fav.dataset.id;
        if(favoritos.has(id)) favoritos.delete(id); else favoritos.add(id);
        fav.classList.toggle('active', favoritos.has(id));
        updatePills();
      }
// OPEN gallery item: clicking a gallery thumb navigates to #feed?p=ID
const galleryItem = e.target.closest('.gal-item');
if (galleryItem) {
  const id = galleryItem.dataset.id;
  if (id) {
    // set the proper hash; hashchange handler will render feed and open the piece
    // we encode the piece id as query param p
    location.hash = 'feed?p=' + encodeURIComponent(id);
  }
  return;
}

    });
  }

  /* ====== Footer bindings (only once) ====== */
  function attachBindings(){
    const checkoutBtn = document.getElementById('btnCheckout');
    if(checkoutBtn){
      checkoutBtn.onclick = (e) => {
        e.preventDefault();
        calcularTotal();
        // Render checkout inside #app or navigate - keep old behavior if present
        document.getElementById('app').innerHTML = `
          <section id="checkout">
            <div style="max-width:480px;margin:0 auto;background:#fff;border:1px solid #2b2424;padding:20px">
              <h2>Preencha seus dados</h2>
              <label>Nome *</label><input id="nome" type="text" style="width:100%">
              <label>E-mail *</label><input id="email" type="email" style="width:100%">
              <label>Telefone</label><input id="telefone" type="tel" style="width:100%">
              <div style="display:flex;gap:8px;margin-top:12px">
                <button id="voltarCheckout" style="flex:1">Voltar</button>
                <button id="prosseguirCheckout" style="flex:1;background:var(--red);color:#fff">Prosseguir</button>
              </div>
            </div>
          </section>`;
        // simple event handlers
        document.getElementById('voltarCheckout').onclick = ()=> renderGaleria();
        document.getElementById('prosseguirCheckout').onclick = ()=> {
          // emulate proceeding - quickly fill hiddenForm and submit
          const nome = document.getElementById('nome').value.trim();
          const email = document.getElementById('email').value.trim();
          if(!nome||!email){ alert('Preencha nome e e-mail'); return; }
          document.getElementById('fNome').value = nome;
          document.getElementById('fEmail').value = email;
          document.getElementById('fTelefone').value = document.getElementById('telefone').value.trim();
          document.getElementById('fPecas').value = [...selecionadas].join(',');
          document.getElementById('fRifas').value = [...rifasSel].join(',');
          document.getElementById('fFav').value = [...favoritos].join(',');
          document.getElementById('fTotal').value = totalGeral.toFixed(2);
          // backup GAS
          try{
            const fd = new FormData();
            fd.append('nome', nome);
            fd.append('email', email);
            fd.append('telefone', document.getElementById('telefone').value.trim());
            fd.append('pecas', [...selecionadas].join(','));
            fd.append('rifas', [...rifasSel].join(','));
            fd.append('favoritas', [...favoritos].join(','));
            fd.append('total', totalGeral.toFixed(2));
            fetch(GAS_URL, { method:'POST', body:fd, mode:'no-cors' });
          }catch(e){ console.warn('GAS backup failed', e); }
          // submit form
          document.getElementById('hiddenForm').submit();
        };
      };
    }
  }

  /* ====== Utility: update pills and total ====== */
  function updatePills(){
    const pP = document.getElementById('pillPecas'), pR = document.getElementById('pillRifas'), pF = document.getElementById('pillFav');
    if(pP) pP.textContent = 'Peças: ' + selecionadas.size;
    if(pR) pR.textContent = 'Rifas: ' + rifasSel.size;
    if(pF) pF.textContent = 'Favoritas: ' + favoritos.size;
  }
function calcularTotal(){
  let total = 0;
  // pieces total
  selecionadas.forEach(id => {
    const p = pecas.find(x => x.id_peca === id);
    if (p && p.preco) total += parseFloat(p.preco);
  });
  // rifas total = apply the parity rule, independent of per-rifa price
  const rifasCount = rifasSel.size || 0;
  const rifasTotal = calculateRifaTotal(rifasCount);
  total += rifasTotal;

  totalGeral = total;
  const totalEl = document.querySelector('.total-display');
  if (totalEl) totalEl.textContent = 'Total: ' + fmt(totalGeral);
  const fTotal = document.getElementById('fTotal');
  if (fTotal) fTotal.value = totalGeral.toFixed(2);
}


// ===== openFeedAt: scroll to a post inside the feed (DO NOT change hash) =====
function openFeedAt(id) {
  // Ensure feed is rendered
  // If feed not present, render it and then scroll
  const attemptScroll = () => {
    const el = document.getElementById('post-' + id);
    if (el) {
      // scroll into view smoothly and give focus for accessibility
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // For screen readers, focus the article's title if exists
      try {
        const title = el.querySelector('.titulo') || el.querySelector('h2');
        if (title && title.focus) title.setAttribute('tabindex', '-1'), title.focus();
      } catch (e) { /* ignore */ }
      return true;
    }
    return false;
  };

  // If feed already exists, attempt immediate scroll
  if (document.getElementById('feedList')) {
    if (!attemptScroll()) {
      // fallback: try again after small delay (in case render still finishing)
      setTimeout(attemptScroll, 120);
    }
  } else {
    // If feed not rendered, render it and then scroll
    renderFeed();
    setTimeout(() => { attemptScroll(); }, 80);
  }
}


  /* ====== INIT ====== */
  async function init(){
    try{
      // clear favorites initially to start from zero (as requested)
      localStorage.removeItem('BSTV_FAV'); favoritos.clear();

      const [rp, rr] = await Promise.all([ fetch(PECAS_JSON_URL,{cache:'no-store'}), fetch(RIFAS_JSON_URL,{cache:'no-store'}) ]);
      if(!rp.ok || !rr.ok) throw new Error('Failed loading JSONs');
      pecas = await rp.json(); rifas = await rr.json();

      // initial render: galeria
      renderGaleria();
      // attach delegated listeners for #app actions
      attachAppDelegation();
      // attach footer bindings once
      attachBindings();
      // update UI states
      updatePills(); calcularTotal();
    // ensure initial hash is processed (deep-link on load)
handleHashChange();
}
    
    catch(e){
      console.error('Init error', e);
      document.getElementById('app').innerHTML = '<div style="padding:20px;color:#900;">Erro ao carregar dados. Veja console.</div>';
    }
  }
  window.addEventListener('DOMContentLoaded', init);

  /* ====== Monitor footer modifications (logs only) ====== */
  (function(){
    const footer = document.querySelector('footer');
    if(!footer) return;
    const mo = new MutationObserver((muts)=>{
      muts.forEach(m=>{
        if(!document.getElementById('btnCheckout')){
          console.warn('Footer altered: btnCheckout missing. Please check code that mutates header/footer.');
        }
      });
    });
    mo.observe(footer, { childList:true, subtree:true, attributes:false });
  })();
  </script>
</body>
</html>
