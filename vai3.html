<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BSTV</title>

<style>
/* ============ TOKENS / RESET ============ */
:root{
  --red:#ff0000; --ink:#2b2424; --beige:#bebab0; --white:#fff;
  --bd1:1px; --bd2:2px;
  --ff-cta:"Roboto Condensed", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  --ff-body:"Roboto SemiCondensed", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  --fs-h1:clamp(1.4rem,3vw,2rem);
  --fs-h2:clamp(1.1rem,2vw,1.35rem);
  --fs-p:clamp(.92rem,1.2vw,1rem);
  --fs-sm:clamp(.78rem,1vw,.9rem);
  --gap-xxs:4px; --gap-xs:6px; --gap-s:8px; --gap-m:12px; --gap-l:16px;
  --app-max:1200px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--beige);color:var(--ink);font:16px/1.35 var(--ff-body);-webkit-font-smoothing:antialiased}

/* ============ HEADER (cara v08) ============ */
header{position:sticky;top:0;z-index:100;background:var(--red);color:#fff;border-bottom:var(--bd2) solid var(--ink)}
.hdr-inner{max-width:var(--app-max);margin:0 auto;display:flex;align-items:center;gap:12px;padding:10px 16px}
.logo{font:700 var(--fs-h2)/1 var(--ff-cta);text-transform:uppercase}
.nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.nav a{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 10px;border:var(--bd1) solid #fff;color:#fff;text-decoration:none;font:700 var(--fs-sm)/1 var(--ff-cta);text-transform:uppercase}
.nav a:hover{background:#fff;color:var(--ink)}

/* ============ ÁREA DE CONTEÚDO ============ */
main#app{max-width:var(--app-max);margin:20px auto;padding:0 16px;min-height:60vh}
section{margin-bottom:24px}
h2{font:700 var(--fs-h2)/1.2 var(--ff-cta);margin:0 0 8px}

/* ============ FEED (cards) ============ */
.feed{display:flex;flex-direction:column;gap:var(--gap-s)}
.post{border:var(--bd1) solid var(--ink);background:var(--beige)}
.meta{padding:10px;display:flex;flex-direction:column;gap:8px}
.meta .linha1{display:flex;align-items:flex-start;gap:8px}
.titulo{flex:1 1 auto;font:700 var(--fs-p)/1.2 var(--ff-cta)}
.preco{flex:0 0 auto;font-weight:700;white-space:nowrap}
.descricao{font-size:15px;font-weight:700}
.tecnica{font-size:13px}
.dimens{font-size:13px}

/* Carrossel simples */
.carousel{display:flex;gap:var(--gap-xxs);overflow-x:auto;scroll-snap-type:x mandatory;padding:6px 12px;background:var(--beige);scrollbar-color: var(--red) transparent}
.carousel::-webkit-scrollbar{height:8px}
.carousel::-webkit-scrollbar-thumb{background:var(--red)}
.carousel-slide{flex:0 0 100%;display:flex;align-items:center;justify-content:center;scroll-snap-align:center}
.carousel-slide img{width:100%;max-height:42vh;min-height:200px;object-fit:contain;background:var(--beige)}

/* Botões do post */
.btn{font-size:13px;font-family:var(--ff-cta);font-weight:700;padding:8px 12px;cursor:pointer;border-radius:0}
.add-btn{border:2px solid var(--red);background:transparent;color:var(--red)}
.add-btn.added{border-color:var(--ink);background:var(--ink);color:var(--beige)}
.fav-btn{border:2px solid var(--red);background:var(--beige);color:var(--red)}
.fav-btn.active{background:var(--red);color:var(--beige)}
.meta .meta-footer{display:flex;justify-content:flex-end;gap:8px}

/* ============ RIFAS (chips) ============ */
.rifas{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start;justify-content:center;align-content:center;padding:6px 0}
.rifa-btn{display:inline-flex;flex-direction:column;align-items:flex-start;justify-content:center;gap:2px;min-height:56px;padding:10px 12px;border:1px solid var(--ink);background:var(--beige);cursor:pointer;font-family:var(--ff-cta);font-weight:600;font-size:14px;line-height:1.15;color:inherit;white-space:normal}
.rifa-btn .ln1,.rifa-btn .ln2{display:block}
.rifa-btn.selected{background:#fff!important;border-color:var(--red)!important;color:var(--red)!important}
.rifa-btn.sold{opacity:.24;filter:grayscale(1);pointer-events:none;background:#bebab0;color:#fff;border:0}
@media (max-width:768px){
  .rifa-btn{min-height:42px;padding:5px 7px;font-size:11px}
  .rifa-btn .ln1,.rifa-btn .ln2{font-size:11px}
}

/* ============ FOOTER + CTA ÚNICO ============ */
footer{position:sticky;bottom:0;background:var(--ink);color:#fff;border-top:var(--bd2) solid var(--ink);z-index:90}
.ftr-inner{max-width:var(--app-max);margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 16px}
.pill-compact{background:var(--beige);color:var(--ink);border:var(--bd1) solid var(--beige);padding:4px 6px;font:700 var(--fs-sm)/1 var(--ff-cta)}
#ctaMain{padding:8px 12px;font:700 1rem/1 var(--ff-cta);text-transform:uppercase;border:0;cursor:pointer}
footer.no-total #pillCompact, footer.no-total #ctaMain{background:var(--ink);color:var(--ink);border:0}
footer.has-total #ctaMain{background:var(--red);color:#fff;border:0}

/* ============ CHECKOUT: OVERLAY + CONTAINER (base) ============ */
#checkoutOverlay{position:fixed;inset:0;background:rgba(43,36,36,.75);backdrop-filter:saturate(1.1) blur(2px);display:none;z-index:9990}
#checkoutModal{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;width:min(1100px,94vw);max-height:69vh;overflow:auto;background:var(--beige);border:2px solid var(--red);box-shadow:0 8px 24px rgba(0,0,0,.35);display:none;z-index:9991}
#checkoutOverlay:not([hidden]){display:block}
#checkoutModal:not([hidden]){display:block}
html.ck-open, body.ck-open{overflow:hidden}

.ck-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--ink)}
.ck-close{border:1px solid var(--ink);background:#fff;color:var(--ink);padding:6px 10px;cursor:pointer}
.ck-step{padding:10px 12px}
.ck-step[hidden]{display:none}
.ck-foot{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-top:1px solid var(--ink)}
.ck-actions .ck-btn{border:2px solid var(--ink);background:#fff;padding:8px 12px;cursor:pointer}
.ck-actions .ck-btn.primary{background:var(--red);border-color:var(--red);color:#fff}

/* Cabeçalho “tabela” e linhas (3 colunas: X | item | R$) */
.ck-grid{display:grid;grid-template-columns:52px 1fr minmax(88px,auto);gap:8px;align-items:center}
.ck-grid-head{color:#fff;background:var(--ink);padding:8px;border:1px solid var(--ink)}
.ck-group{margin:10px 0}
.ck-group-title{font:700 var(--fs-sm)/1 var(--ff-cta);text-transform:uppercase;margin:4px 0 6px}
.ck-x{border:1px solid var(--ink);background:#fff;padding:4px 8px;cursor:pointer}
.ck-thumb{width:56px;height:56px;object-fit:cover;border:1px solid var(--ink);margin-right:8px;vertical-align:middle}
.ck-title{vertical-align:middle}

@media (max-width:560px){
  .ck-grid{grid-template-columns:40px 1fr 88px}
  .ck-thumb{width:48px;height:48px}
}

/* Abas e PIX (estrutura base, lógica depois) */
.ck-tabs{display:flex;gap:8px;margin:6px 0}
.ck-tab{flex:1;border:2px solid var(--ink);background:#ddd;padding:8px;cursor:pointer}
.ck-tab[aria-selected="true"]{background:var(--ink);color:#fff}
.ck-pane[aria-hidden="true"]{display:none}
.ck-pix-row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
.ck-pix-qr{width:180px;height:180px;border:1px solid var(--ink);background:#fff;display:flex;align-items:center;justify-content:center}
.ck-pix-side{flex:1;display:flex;flex-direction:column;gap:10px}
#ck-pix-copy{border:2px solid var(--ink);background:#fff;padding:8px 12px;cursor:pointer}

/* CTA invisível quando desabilitado */
#ctaMain:disabled{background:var(--ink)!important;color:var(--ink)!important;border-color:var(--ink)!important;cursor:default;opacity:1}

 /* =========================
   CHECKOUT (PARTE 2/2)
   ========================= */

/* Cabeçalho e rodapé do modal */
.ck-head{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:10px 12px;border-bottom:1px solid var(--ink);background:var(--red);color:#fff;
}
.ck-head h2{margin:0;font:700 var(--fs-h2)/1 var(--ff-cta)}
.ck-close{border:1px solid var(--ink);background:#fff;color:var(--ink);padding:6px 10px;cursor:pointer}

.ck-foot{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:10px 12px;border-top:1px solid var(--ink);background:var(--beige)
}
.ck-foot .ck-total{font:700 var(--fs-p)/1 var(--ff-cta)}
.ck-actions{display:flex;gap:8px}
.ck-btn{border:2px solid var(--ink);background:#fff;color:var(--ink);padding:8px 12px;cursor:pointer}
.ck-btn.primary{background:var(--red);border-color:var(--red);color:#fff}

/* Passos */
.ck-step{padding:12px}
.ck-step[hidden]{display:none}

/* “Tabela”: 3 colunas (X | item | R$) */
.ck-grid{display:grid;grid-template-columns:52px 1fr minmax(88px,auto);gap:8px;align-items:center}
.ck-grid-head{
  color:#fff;background:var(--ink);padding:8px;border:1px solid var(--ink);
  font:700 var(--fs-sm)/1 var(--ff-cta);text-transform:uppercase
}
.ck-group{margin:10px 0}
.ck-group-title{font:700 var(--fs-sm)/1 var(--ff-cta);text-transform:uppercase;margin:6px 0}

.ck-row{display:grid;grid-template-columns:52px 1fr minmax(88px,auto);gap:8px;align-items:center;padding:6px 0}
.ck-row + .ck-row{border-top:1px dashed rgba(43,36,36,.35)}
.col-x{display:flex;align-items:center;justify-content:center}
.ck-x{border:1px solid var(--ink);background:#fff;padding:4px 8px;cursor:pointer}
.col-item{display:flex;align-items:center;gap:8px;min-width:0}
.ck-thumb{width:56px;height:56px;object-fit:cover;border:1px solid var(--ink)}
.ck-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.col-price{text-align:right;font:700 var(--fs-sm)/1 var(--ff-cta)}

/* Chip da rifa (reprodução do botão em mini) */
.rifa-chip{
  display:inline-flex;flex-direction:column;gap:2px;min-height:32px;
  padding:6px 8px;border:1px solid var(--ink);background:var(--beige);color:var(--ink);
  font-family:'BC-RobotoCondensed-Med',system-ui,-apple-system,'Segoe UI',Arial,sans-serif;
  font-size:12px;line-height:1.1;text-transform:none;white-space:normal
}
.rifa-chip .ln1,.rifa-chip .ln2{display:block}

/* Form do passo 2 */
.ck-form{display:grid;grid-template-columns:1fr;gap:8px;margin:6px 0 10px}
.ck-form label{font:700 var(--fs-sm)/1 var(--ff-cta)}
.ck-form input{
  height:40px;border:1px solid var(--ink);background:#fff;color:var(--ink);
  padding:8px 10px;font:400 var(--fs-p)/1 system-ui,-apple-system,Segoe UI,Arial
}

/* Abas de pagamento */
.ck-tabs{display:flex;gap:8px;margin:8px 0}
.ck-tab{flex:1;border:2px solid var(--ink);background:#ddd;padding:8px;cursor:pointer;font:700 var(--fs-sm)/1 var(--ff-cta)}
.ck-tab[aria-selected="true"]{background:var(--ink);color:#fff}
.ck-pane[aria-hidden="true"]{display:none}
.ck-pane[aria-hidden="false"]{display:block}

/* PIX */
.ck-pix-row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
.ck-pix-qr{
  width:180px;height:180px;border:1px solid var(--ink);background:#fff;
  display:flex;align-items:center;justify-content:center
}
.ck-pix-side{flex:1;display:flex;flex-direction:column;gap:10px;min-width:220px}
.ck-pix-total{border:1px solid var(--ink);background:#fff;padding:8px}
#ck-pix-copy{border:2px solid var(--ink);background:#fff;padding:8px 12px;cursor:pointer}

/* PayPal (apenas um botão) */
#ck-pane-pp .ck-btn.primary{align-self:flex-start}

/* Responsivo: colunas mais estreitas no mobile */
@media (max-width:560px){
  .ck-grid,.ck-row{grid-template-columns:40px 1fr 88px}
  .ck-thumb{width:48px;height:48px}
}

/* Overlay/Modal visibilidade (usa atributo [hidden]) */
#checkoutOverlay{display:none;position:fixed;inset:0;background:rgba(43,36,36,.75);backdrop-filter:saturate(1.05) blur(2px);z-index:9990}
#checkoutModal{display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:0;max-width:min(1100px,94vw);max-height:69vh;width:100%;
  border:2px solid var(--red);background:var(--beige);box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:9991;overflow:auto}
#checkoutOverlay:not([hidden]){display:block}
#checkoutModal:not([hidden]){display:block}

/* Desabilita rolagem da página com modal aberto */
html.ck-open, body.ck-open{overflow:hidden}

/* CTA do rodapé “invisível” quando total=0 */
#ctaMain[disabled]{background:var(--ink)!important;color:var(--ink)!important;border-color:var(--ink)!important;opacity:1;cursor:default}
 </style>
</head>
  
  
  
  <body>

<!-- ====== HEADER ====== -->
<header>
  <div class="hdr-inner">
    <div class="logo">ME SINTO CONTENTE, ME SINTO MTO CONTENTE</div>
    <nav class="nav">
      <a href="#galeria">Galeria</a>
      <a href="#feed">Feed</a>
      <a href="#rifas">Rifas</a>
      <a href="https://betshoptv.com/como.html">Como Funciona?</a>
    </nav>
  </div>
</header>

<!-- ====== CONTEÚDO (render dinâmico) ====== -->
<main id="app" role="main" aria-live="polite">
  <section id="page-loading" style="padding:24px;text-align:center;">Carregando...</section>
</main>

<!-- ====== CHECKOUT – OVERLAY + MODAL ====== -->
<div id="checkoutOverlay" hidden></div>

<div id="checkoutModal" role="dialog" aria-modal="true" aria-labelledby="ck-ttl" hidden>
  <header class="ck-head">
    <h2 id="ck-ttl">Checkout</h2>
    <button type="button" id="ck-close" class="ck-close" aria-label="Fechar">Fechar</button>
  </header>

  <!-- === PASSO 1: CONFIRA SUAS APOSTAS === -->
  <section id="ck-step1" class="ck-step" aria-labelledby="ck-s1-ttl">
    <h3 id="ck-s1-ttl">1 | Confira suas apostas</h3>

    <!-- Cabeçalho “tabela” (3 colunas: X | item | R$) -->
    <div class="ck-grid ck-grid-head" aria-hidden="true">
      <div class="col-x"></div>
      <div class="col-item">Itens</div>
      <div class="col-price">R$</div>
    </div>

    <!-- RIFAS -->
    <div class="ck-group">
      <div class="ck-group-title">Rifas</div>
      <div id="ck-rifas" class="ck-list" aria-label="Rifas selecionadas"></div>
    </div>

    <!-- PEÇAS -->
    <div class="ck-group">
      <div class="ck-group-title">Peças</div>
      <div id="ck-pecas" class="ck-list" aria-label="Peças selecionadas"></div>
    </div>

    <!-- FAVORITAS -->
    <div class="ck-group">
      <div class="ck-group-title">Favoritas</div>
      <div id="ck-favs" class="ck-list" aria-label="Favoritas selecionadas"></div>
    </div>

    <footer class="ck-foot">
      <div class="ck-total"><strong>Total:</strong> <span id="ck-total-s1">R$ 0</span></div>
      <div class="ck-actions">
        <button type="button" id="ck-prev-1" class="ck-btn" disabled>Voltar</button>
        <button type="button" id="ck-next-1" class="ck-btn primary">Avançar</button>
      </div>
    </footer>
  </section>

  <!-- === PASSO 2: PREENCHA SEUS DADOS === -->
  <section id="ck-step2" class="ck-step" aria-labelledby="ck-s2-ttl" hidden>
    <h3 id="ck-s2-ttl">2 | Preencha seus dados</h3>

    <div class="ck-form">
      <label for="ck-nome">Nome *</label>
      <input id="ck-nome" type="text" inputmode="text" autocomplete="name" />

      <label for="ck-email">E-mail *</label>
      <input id="ck-email" type="email" inputmode="email" autocomplete="email" />

      <label for="ck-fone">Telefone (opcional)</label>
      <input id="ck-fone" type="tel" inputmode="tel" autocomplete="tel" />
    </div>

    <footer class="ck-foot">
      <div class="ck-total"><strong>Total:</strong> <span id="ck-total-s2">R$ 0</span></div>
      <div class="ck-actions">
        <button type="button" id="ck-prev-2" class="ck-btn">Voltar</button>
        <button type="button" id="ck-next-2" class="ck-btn primary">Avançar</button>
      </div>
    </footer>
  </section>

  <!-- === PASSO 3: PAGAMENTO === -->
  <section id="ck-step3" class="ck-step" aria-labelledby="ck-s3-ttl" hidden>
    <h3 id="ck-s3-ttl">3 | Pagamento</h3>

    <div class="ck-pay">
      <!-- Abas -->
      <div class="ck-tabs" role="tablist">
        <button id="ck-tab-pix" class="ck-tab" role="tab" aria-controls="ck-pane-pix" aria-selected="true">PIX</button>
        <button id="ck-tab-pp" class="ck-tab" role="tab" aria-controls="ck-pane-pp" aria-selected="false">PayPal</button>
      </div>

      <!-- PIX -->
      <div id="ck-pane-pix" class="ck-pane" role="tabpanel" aria-labelledby="ck-tab-pix" aria-hidden="false">
        <div class="ck-pix-row">
          <div class="ck-pix-qr" id="ck-pix-qr"></div>
          <div class="ck-pix-side">
            <div class="ck-pix-total"><strong>Total:</strong> <span id="ck-total-s3">R$ 0</span></div>
            <button type="button" class="ck-btn" id="ck-pix-copy">PIX Copia e Cola</button>
          </div>
        </div>
        <!-- Payload PIX (fica oculto; usado para copiar) -->
        <div id="ck-pix-payload" hidden></div>
      </div>

      <!-- PayPal -->
      <div id="ck-pane-pp" class="ck-pane" role="tabpanel" aria-labelledby="ck-tab-pp" aria-hidden="true">
        <a class="ck-btn primary" target="_blank" rel="noopener"
           href="https://www.paypal.com/donate/?hosted_button_id=369CQUU2V8P5G">Pagar com PayPal</a>
      </div>
    </div>

    <footer class="ck-foot">
      <div class="ck-total"><strong>Total:</strong> <span id="ck-total-s3b">R$ 0</span></div>
      <div class="ck-actions">
        <button type="button" id="ck-prev-3" class="ck-btn">Voltar</button>
        <button type="button" id="ck-finish" class="ck-btn primary">Confirmar</button>
      </div>
    </footer>
  </section>
</div>

<!-- ====== FOOTER (CTA ÚNICO) ====== -->
<footer>
  <div class="ftr-inner">
    <div class="contadores">
      <span id="pillCompact" class="pill-compact" style="display:none;"></span>
    </div>

    <!-- Botão único: muda para “APOSTAR R$ …” quando total > 0 -->
    <button class="cta-main" id="ctaMain" disabled>FAÇAM SUAS APOSTAS!</button>
  </div>
</footer>

<!-- ====== FORMULÁRIO OCULTO (FormSubmit) ====== -->
<form id="hiddenForm"
      action="https://formsubmit.co/b7c03bfd6671addd4ddd857cb7e53d3d"
      method="POST" style="display:none;">
  <input type="hidden" name="nome"      id="fNome">
  <input type="hidden" name="email"     id="fEmail">
  <input type="hidden" name="telefone"  id="fTelefone">
  <input type="hidden" name="pecas"     id="fPecas">
  <input type="hidden" name="rifas"     id="fRifas">
  <input type="hidden" name="favoritas" id="fFav">
  <input type="hidden" name="total"     id="fTotal">
  <input type="hidden" name="_captcha"  value="false">
  <input type="hidden" name="_subject"  value="Nova aposta BSTV">
  <input type="hidden" name="_template" value="table">
  <input type="hidden" name="_next"     value="https://betshoptv.com/obrigado.html">
</form>

<script>
/* ======================= JS – PARTE 1/5 ===========================
   Config/estado/helpers + roteador + total/CTA + bootstrap
   (Interações de seleção, checkout e PIX virão nas Partes 2–5)
=================================================================== */

/* --------- CONFIG --------- */
const PECAS_JSON_URL = 'https://betshoptv.com/dados/pecas.json';
const RIFAS_JSON_URL = 'https://betshoptv.com/dados/rifas.json';
const GAS_URL        = 'https://script.google.com/macros/s/AKfycbwsX8iGOv_mg0bhY8iRGACMGte56FXVo6ursYG_K4cq0Y50jW3g34_GX3uJU3U-Vwo0UQ/exec';

/* --------- ESTADO GLOBAL --------- */
let pecas = [];                 // catálogo de peças (JSON)
let rifas = [];                 // catálogo de rifas (JSON)
const selecionadas = new Set(); // ids de peças no carrinho
const rifasSel     = new Set(); // ids de rifas no carrinho
const favoritos    = new Set(); // ids de peças favoritas
let totalGeral     = 0;         // total inteiro (sem casas)
let appReady       = false;     // já carregou dados?

/* --------- HELPERS VISUAIS/DADOS --------- */
// Formata “R$ 1.500” sem casas decimais
function fmt(v){
  const n = Number(v||0);
  return 'R$ ' + Math.round(n).toLocaleString('pt-BR');
}

// Carrega imagem .avif com fallback .jpg
function imgWithFallback(src){
  const img = new Image();
  img.loading = 'lazy';
  img.src = src;
  img.onerror = () => {
    if (src.endsWith('.avif')) img.src = src.replace('.avif', '.jpg');
  };
  return img;
}

// Cor de texto legível sobre um fundo hex
function getContrastColor(hex){
  try{
    let s = String(hex||'').trim();
    if (!s) return '#2b2424';
    if (s.startsWith('#')) s = s.slice(1);
    if (s.length===3) s = s.split('').map(ch=>ch+ch).join('');
    if (s.length!==6) return '#2b2424';
    const r=parseInt(s.slice(0,2),16), g=parseInt(s.slice(2,4),16), b=parseInt(s.slice(4,6),16);
    const yiq = (r*299 + g*587 + b*114)/1000;
    return yiq >= 128 ? '#2b2424' : '#ffffff';
  }catch(e){ return '#2b2424'; }
}

// Total de rifas: par = n*25; ímpar = (n-1)*25 + 30
function calculateRifaTotal(count){
  const n = Number(count||0);
  if (n<=0) return 0;
  return n%2===0 ? 25*n : 25*(n-1)+30;
}

/* --------- RENDER BÁSICO (placeholders – detalhes na Parte 2) --------- */
function renderGaleria(){
  const app = document.getElementById('app');
  app.innerHTML = '';
  const sec = document.createElement('section');
  sec.id = 'galeria';

  const grid = document.createElement('div');
  grid.className = 'galeria';

  pecas.forEach(p=>{
    if (String(p.status).toUpperCase()==='VENDIDAAA') return;
    const card = document.createElement('div');
    card.className = 'gal-item';
    card.dataset.id = p.id_peca;

    const first = (p.imagens&&p.imagens[0]) ? p.imagens[0] : '';
    const img = imgWithFallback('/img/tmb/'+first+'.avif');
    img.alt = p.titulo||('Peça '+p.id_peca);
    card.appendChild(img);

    grid.appendChild(card);
  });

  sec.appendChild(grid);
  app.appendChild(sec);
}


/* ---------- BEGIN REPLACE: renderFeed (com botões) ---------- */
function renderFeed(){
  const app = document.getElementById('app');
  app.innerHTML = '';

  const section = document.createElement('section');
  section.id = 'feed';

  const list = document.createElement('div');
  list.className = 'feed';

  pecas.forEach(p => {
    if (String(p.status).toUpperCase() === 'VENDIDAAA') return;

    const post = document.createElement('article');
    post.className = 'post';
    post.id = 'post-' + p.id_peca;

    // Carrossel (mínimo: 1ª imagem)
    const car = document.createElement('div');
    car.className = 'carousel';
    const slide = document.createElement('div');
    slide.className = 'carousel-slide';
    const first = (p.imagens && p.imagens[0]) ? p.imagens[0] : '';
    slide.appendChild(imgWithFallback('/img/otm/' + first + '.avif'));
    car.appendChild(slide);

    // Meta
    const meta = document.createElement('div');
    meta.className = 'meta';

    // Título + preço
    const l1 = document.createElement('div');
    l1.className = 'linha1';
    const ttl = document.createElement('div'); ttl.className = 'titulo'; ttl.textContent = p.titulo || ('Peça ' + p.id_peca);
    const prc = document.createElement('div'); prc.className = 'preco';  prc.textContent = fmt(p.preco);
    l1.append(ttl, prc);

    // Técnica (acima) + dimensões
    const tecnica = document.createElement('div'); tecnica.className = 'tecnica'; tecnica.textContent = p.tecnica || '';
    const dim     = document.createElement('div'); dim.className     = 'dimens';  dim.textContent     = p.dimensao || p.tamanho || '';

    // Ações
    const footerMeta  = document.createElement('div'); footerMeta.className  = 'meta-footer';
    const leftActions = document.createElement('div'); leftActions.className = 'left-actions';
    const rightActions= document.createElement('div'); rightActions.className= 'right-actions';

    // ♥ Favoritar
    const fav = document.createElement('button');
    fav.className = 'btn fav-btn';
    fav.type = 'button';
    fav.textContent = '♥';
    if (favoritos.has(p.id_peca)) fav.classList.add('active');

    fav.addEventListener('click', ()=>{
      const id = p.id_peca;
      if (favoritos.has(id)) favoritos.delete(id); else favoritos.add(id);
      fav.classList.toggle('active', favoritos.has(id));
      try { localStorage.setItem('BSTV_FAV', JSON.stringify([...favoritos])); } catch(e){}
      updatePills();
    });

    // ADICIONAR/REMOVER
    const add = document.createElement('button');
    add.className = 'btn add-btn';
    add.type = 'button';
    const isIn = selecionadas.has(p.id_peca);
    if (isIn) add.classList.add('added');
    add.textContent = isIn ? 'REMOVER' : 'ADICIONAR';

    add.addEventListener('click', ()=>{
      const id = p.id_peca;
      const was = add.classList.toggle('added');
      if (was) selecionadas.add(id); else selecionadas.delete(id);
      add.textContent = was ? 'REMOVER' : 'ADICIONAR';
      calcularTotal();  // já atualiza CTA/pills
    });

    leftActions.appendChild(fav);
    rightActions.appendChild(add);
    footerMeta.append(leftActions, rightActions);

    meta.append(l1);
    if (tecnica.textContent) meta.append(tecnica);
    meta.append(dim, footerMeta);

    post.append(car, meta);
    list.appendChild(post);
  });

  section.appendChild(list);
  app.appendChild(section);
}
/* ---------- END REPLACE: renderFeed ---------- */

/* ---------- BEGIN REPLACE: renderRifas (seleção) ---------- */
function renderRifas(){
  const app = document.getElementById('app');
  app.innerHTML = '';

  const sec = document.createElement('section');
  sec.id = 'rifas';

  const grid = document.createElement('div');
  grid.className = 'rifas';

  rifas.forEach(r=>{
    const disponivel = !r.status_rifa || String(r.status_rifa).trim()==='';
    const btn = document.createElement('button');
    btn.className = 'rifa-btn' + (disponivel ? '' : ' sold');
    btn.dataset.id = r.id_rifa;

    const bg = r.hex_rifa || r.hex || '#bebab0';
    btn.style.backgroundColor = bg;
    btn.style.color = getContrastColor(bg);

    // label (sem “X ” no começo)
    const label = (r.botao_rifa?.trim() || r.numero || r.id_rifa || '')
                  .toString().replace(/^\s*X\s*/i,'');
    const ln1 = document.createElement('span'); ln1.className='ln1'; ln1.textContent = label;
    btn.appendChild(ln1);

    if (disponivel){
      // estado visual se já estava selecionada
      if (rifasSel.has(String(r.id_rifa))){
        btn.classList.add('selected');
        btn.style.backgroundColor = '#fff';
        btn.style.color = '#ff0000';
        btn.style.borderColor = '#ff0000';
      }

      btn.addEventListener('click', ()=>{
        const id = String(r.id_rifa);
        const willSelect = !btn.classList.contains('selected');
        if (willSelect){
          rifasSel.add(id);
          btn.classList.add('selected');
          btn.style.backgroundColor = '#fff';
          btn.style.color = '#ff0000';
          btn.style.borderColor = '#ff0000';
        }else{
          rifasSel.delete(id);
          btn.classList.remove('selected');
          btn.style.backgroundColor = bg;
          btn.style.color = getContrastColor(bg);
          btn.style.borderColor = '';
        }
        calcularTotal(); // já reflete no CTA/pills
      });
    }

    grid.appendChild(btn);
  });

  sec.appendChild(grid);
  app.appendChild(sec);
}
/* ---------- END REPLACE: renderRifas ---------- */

/* --------- TOTAL + CTA/PILLS DO RODAPÉ --------- */
function updatePills(){
  const nbsp = '\u00A0';
  const pill = document.getElementById('pillCompact');
  const cta  = document.getElementById('ctaMain');

  const parts = [];
  if (selecionadas.size>0) parts.push(`${selecionadas.size}${nbsp}${selecionadas.size===1?'Peça':'Peças'}`);
  if (rifasSel.size>0)     parts.push(`${rifasSel.size}${nbsp}${rifasSel.size===1?'Rifa':'Rifas'}`);
  if (favoritos.size>0)    parts.push(`${favoritos.size}${nbsp}${favoritos.size===1?'Favorita':'Favoritas'}`);

  if (pill){ pill.textContent = parts.join(' · '); pill.style.display = parts.length?'inline-block':'none'; }

  if (cta){
    if (totalGeral>0){
      cta.textContent = 'APOSTAR ' + fmt(totalGeral);
      cta.disabled = false;
    } else {
      cta.textContent = 'FAÇAM SUAS APOSTAS!';
      cta.disabled = true;
    }
  }

  const footer = document.querySelector('footer');
  if (footer){
    footer.classList.toggle('has-total', totalGeral>0);
    footer.classList.toggle('no-total',  totalGeral===0);
  }
}

function calcularTotal(){
  let total = 0;

  // peças
  selecionadas.forEach(id=>{
    const p = pecas.find(x=>String(x.id_peca)===String(id));
    if (p && p.preco) total += Number(p.preco);
  });

  // rifas
  total += calculateRifaTotal(rifasSel.size);

  totalGeral = Math.floor(total||0);

  // propaga ao form oculto (duas casas p/ backend)
  const fTotal = document.getElementById('fTotal');
  if (fTotal) fTotal.value = Number(totalGeral).toFixed(2);

  updatePills();
}

/* --------- ROTEADOR (hash) --------- */
function parseHash(){
  const raw = (location.hash||'').slice(1);
  if (!raw) return { page:'galeria', params:new URLSearchParams() };
  const [page, q] = raw.split('?');
  return { page: page||'galeria', params: new URLSearchParams(q||'') };
}

function showPage(page, opts={}){
  const updateHash = opts.updateHash!==false;
  const pieceId = opts.pieceId || null;

  if      (page==='feed')   renderFeed();
  else if (page==='rifas')  renderRifas();
  else                      renderGaleria();

  if (updateHash){
    let h = page;
    if (pieceId){
      const par = new URLSearchParams(); par.set('p', pieceId);
      h = `${page}?${par.toString()}`;
    }
    if (location.hash !== '#'+h) location.hash = h;
  }
}

function handleHashChange(){
  if (!appReady) return;
  const { page, params } = parseHash();
  if (page==='feed'){
    const p = params.get('p');
    showPage('feed', { updateHash:false, pieceId:p });
  } else if (page==='rifas'){
    showPage('rifas', { updateHash:false });
  } else {
    showPage('galeria', { updateHash:false });
  }
}

window.addEventListener('hashchange', handleHashChange);

// navegação do header
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.nav a[href^="#"]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      location.hash = a.getAttribute('href').slice(1);
    });
  });
});

/* --------- BOOTSTRAP / INIT --------- */
async function init(){
  try{
    // limpa favoritos antigos (como combinado)
    try { localStorage.removeItem('BSTV_FAV'); } catch(e){}
    favoritos.clear();

    const [rp, rr] = await Promise.all([
      fetch(PECAS_JSON_URL, { cache:'no-store' }),
      fetch(RIFAS_JSON_URL, { cache:'no-store' })
    ]);
    if (!rp.ok || !rr.ok) throw new Error('Falha ao carregar dados');

    pecas = await rp.json();
    rifas = await rr.json();

    appReady = true;
    handleHashChange();   // render inicial conforme hash
    calcularTotal();      // inicializa CTA
  }catch(err){
    console.error(err);
    const app = document.getElementById('app');
    if (app) app.innerHTML = '<div style="padding:20px;color:#900;">Erro ao carregar dados. Veja o console.</div>';
  }
}
window.addEventListener('DOMContentLoaded', init);

  * ---------- Delegation geral (galeria → abrir feed na peça) ---------- */
(function attachCommonDelegation(){
  document.addEventListener('click', (e)=>{
    const it = e.target.closest('.gal-item');
    if (it && it.dataset.id){
      location.hash = 'feed?p=' + encodeURIComponent(it.dataset.id);
    }
  });
})();

/* ---------- CTA do rodapé: abrir checkout (stub já funcional) ---------- */
(function bindFooterCTA(){
  const cta = document.getElementById('ctaMain');
  if (!cta) return;

  cta.addEventListener('click', (e)=>{
    e.preventDefault();
    if ((totalGeral||0) <= 0) return;
    ckOpenModal(); // definido no stub abaixo (mostra overlay/modal e abre Passo 1)
  });
})();

/* ---------- Checkout (stub mínimo para abrir/fechar) ----------
   A lógica completa (render das listas, navegação e PIX) entra nas Partes 3–5.
----------------------------------------------------------------- */
let ckOpen = false;
let ckStep = 1;

function CKq(sel){ return document.querySelector(sel); }

const CK = {
  overlay: ()=> CKq('#checkoutOverlay'),
  modal:   ()=> CKq('#checkoutModal'),
  s1:      ()=> CKq('#ck-step1'),
  s2:      ()=> CKq('#ck-step2'),
  s3:      ()=> CKq('#ck-step3'),
  close:   ()=> CKq('#ck-close')
};

function ckGoStep(step){
  ckStep = step;
  const s1=CK.s1(), s2=CK.s2(), s3=CK.s3();
  if (s1) s1.hidden = (step!==1);
  if (s2) s2.hidden = (step!==2);
  if (s3) s3.hidden = (step!==3);
}

function ckOpenModal(){
  const ov=CK.overlay(), md=CK.modal();
  if (!ov || !md) return;
  ov.removeAttribute('hidden');
  md.removeAttribute('hidden');
  document.documentElement.classList.add('ck-open');
  ckOpen = true;
  ckGoStep(1); // começa no passo 1
}

function ckCloseModal(){
  const ov=CK.overlay(), md=CK.modal();
  if (!ov || !md) return;
  ov.setAttribute('hidden','');
  md.setAttribute('hidden','');
  document.documentElement.classList.remove('ck-open');
  ckOpen = false;
}

(function bindOverlayClose(){
  const ov=CK.overlay(), x=CK.close();
  if (ov) ov.addEventListener('click', ckCloseModal);
  if (x)  x.addEventListener('click', ckCloseModal);
})();


/* ===================== JS — PARTE 3 ===================== */
/* CHECKOUT: Passo 1 (listas de itens) + totais dos passos  */
/* Cole este bloco DEPOIS da Parte 2 do JS                  */
/* ======================================================== */

/* Getters do checkout (caso ainda não tenham sido definidos) */
if (!window.CK) {
  window.CK = {
    modal:      ()=>document.getElementById('checkoutModal'),
    overlay:    ()=>document.getElementById('checkoutOverlay'),
    close:      ()=>document.getElementById('ck-close'),
    // listas do passo 1
    listR:      ()=>document.getElementById('ck-rifas'),
    listP:      ()=>document.getElementById('ck-pecas'),
    listF:      ()=>document.getElementById('ck-favs'),
    // totais dos passos
    t1:         ()=>document.getElementById('ck-total-s1'),
    t2:         ()=>document.getElementById('ck-total-s2'),
    t3:         ()=>document.getElementById('ck-total-s3'),
    t3b:        ()=>document.getElementById('ck-total-s3b'),
    // navegação
    prev1:      ()=>document.getElementById('ck-prev-1'),
    next1:      ()=>document.getElementById('ck-next-1'),
    prev2:      ()=>document.getElementById('ck-prev-2'),
    next2:      ()=>document.getElementById('ck-next-2'),
    prev3:      ()=>document.getElementById('ck-prev-3'),
    finish:     ()=>document.getElementById('ck-finish'),
    // pix
    pixQR:      ()=>document.getElementById('ck-pix-qr'),
    pixCopy:    ()=>document.getElementById('ck-pix-copy'),
    pixPayload: ()=>document.getElementById('ck-pix-payload'),
    tabPix:     ()=>document.getElementById('ck-tab-pix'),
    tabPP:      ()=>document.getElementById('ck-tab-pp'),
    panePix:    ()=>document.getElementById('ck-pane-pix'),
    panePP:     ()=>document.getElementById('ck-pane-pp'),
    // campos passo 2
    fNome:      ()=>document.getElementById('ck-nome'),
    fEmail:     ()=>document.getElementById('ck-email'),
    fFone:      ()=>document.getElementById('ck-fone'),
    // passos
    s1:         ()=>document.getElementById('ck-step1'),
    s2:         ()=>document.getElementById('ck-step2'),
    s3:         ()=>document.getElementById('ck-step3'),
  };
}

/* ==== Linha “tabela”: X | item | preço ==== */
function ckMakeRow({ kind, id, itemNode, priceText }) {
  const row = document.createElement('div');
  row.className = 'ck-row';

  const colX = document.createElement('div'); colX.className = 'col-x';
  const bx = document.createElement('button'); bx.className = 'ck-x'; bx.textContent = 'X';
  bx.dataset.kind = kind; bx.dataset.id = id;
  colX.appendChild(bx);

  const colItem = document.createElement('div'); colItem.className = 'col-item';
  colItem.appendChild(itemNode);

  const colPrice = document.createElement('div'); colPrice.className = 'col-price';
  colPrice.textContent = priceText || '';

  row.append(colX, colItem, colPrice);
  return row;
}

/* ==== “Chip” de rifa com 1–2 linhas (sem forçar uppercase) ==== */
function ckMakeRifaChip(label, bgHex, textColor) {
  const chip = document.createElement('div');
  chip.className = 'rifa-chip';
  chip.style.backgroundColor = bgHex || 'var(--beige)';
  chip.style.color = textColor || 'var(--ink)';

  const t = (label||'').trim();
  if (!t) {
    const s1 = document.createElement('span'); s1.className='ln1'; s1.textContent='';
    chip.appendChild(s1);
  } else if (t.length <= 28) {
    const s1 = document.createElement('span'); s1.className='ln1'; s1.textContent=t;
    chip.appendChild(s1);
  } else {
    const mid = Math.floor(t.length/2);
    let bp = t.lastIndexOf(' ', mid); if (bp < 3) bp = t.indexOf(' ', mid); if (bp === -1) bp = 28;
    const part1 = t.slice(0, bp).trim();
    const part2 = t.slice(bp).trim();
    const s1 = document.createElement('span'); s1.className='ln1'; s1.textContent=part1; chip.appendChild(s1);
    if (part2) { const s2 = document.createElement('span'); s2.className='ln2'; s2.textContent=part2; chip.appendChild(s2); }
  }
  return chip;
}

/* ==== Render do Passo 1: listas de Rifas / Peças / Favoritas ==== */
function ckRenderStep1(){
  const listR = CK.listR(), listP = CK.listP(), listF = CK.listF();
  if (!listR || !listP || !listF) return;
  listR.innerHTML = ''; listP.innerHTML = ''; listF.innerHTML = '';

  // ----- RIFAS -----
  const rSel = [...rifasSel];                       // ordem de inserção
  const last30 = (rSel.length % 2 === 1) ? String(rSel[rSel.length - 1]) : null; // última custa 30 se ímpar

  rSel.forEach(rid => {
    const r = rifas.find(x => String(x.id_rifa) === String(rid));
    if (!r) return;
    const label = (r.botao_rifa?.trim() || r.numero || r.id_rifa || '')
                  .toString().replace(/^\s*X\s*/i,'');
    const bg = r.hex_rifa || r.hex || '#bebab0';
    const txt = (typeof getContrastColor === 'function') ? getContrastColor(bg) : '#2b2424';
    const chip = ckMakeRifaChip(label, bg, txt);
    const price = (last30 && String(rid) === last30) ? 30 : 25;
    listR.appendChild( ckMakeRow({ kind:'rifa', id:rid, itemNode:chip, priceText:'R$ ' + Math.floor(price) }) );
  });

  // ----- PEÇAS -----
  [...selecionadas].forEach(pid => {
    const p = pecas.find(x => String(x.id_peca) === String(pid));
    if (!p) return;
    const wrap = document.createElement('div');
    const img  = imgWithFallback('/img/tmb/' + (p.imagens?.[0]||'') + '.avif'); img.className = 'ck-thumb';
    const ttl  = document.createElement('span'); ttl.className = 'ck-title'; ttl.textContent = p.titulo || ('Peça ' + pid);
    wrap.append(img, ttl);
    listP.appendChild( ckMakeRow({ kind:'peca', id:pid, itemNode:wrap, priceText:'R$ ' + Math.floor(Number(p.preco||0)) }) );
  });

  // ----- FAVORITAS (sem preço) -----
  [...favoritos].forEach(fid => {
    const p = pecas.find(x => String(x.id_peca) === String(fid));
    if (!p) return;
    const wrap = document.createElement('div');
    const img  = imgWithFallback('/img/tmb/' + (p.imagens?.[0]||'') + '.avif'); img.className = 'ck-thumb';
    const ttl  = document.createElement('span'); ttl.className = 'ck-title'; ttl.textContent = p.titulo || ('Peça ' + fid);
    wrap.append(img, ttl);
    listF.appendChild( ckMakeRow({ kind:'fav', id:fid, itemNode:wrap, priceText:'' }) );
  });

  // Remover pelo X (delegação simples)
  CK.modal().querySelectorAll('.ck-x').forEach(btn => {
    btn.onclick = () => {
      const kind = btn.dataset.kind, id = btn.dataset.id;
      if (!kind || !id) return;
      if (kind === 'rifa') rifasSel.delete(id);
      else if (kind === 'peca') selecionadas.delete(id);
      else if (kind === 'fav') favoritos.delete(id);
      calcularTotal();     // recalcula e atualiza CTA/pills
      ckRenderStep1();     // repinta as listas
    };
  });
}

/* ==== TOTAIS sincronizados nos 3 passos ==== */
function ckSyncTotalsOnSteps(){
  const v = Math.floor(totalGeral || 0);
  if (CK.t1())  CK.t1().textContent  = 'R$ ' + v;
  if (CK.t2())  CK.t2().textContent  = 'R$ ' + v;
  if (CK.t3())  CK.t3().textContent  = 'R$ ' + v;
  if (CK.t3b()) CK.t3b().textContent = 'R$ ' + v;
}

/* ==== Navegação dos passos (voltar/avançar) ==== */
/* Requer que suas funções globais ckGoStep(step) e ckEnsurePixReady()
   já existam (foram definidas nas partes anteriores). */
(function bindStepNav(){
  if (CK.prev1()) CK.prev1().onclick = ()=>{};          // nada no 1
  if (CK.next1()) CK.next1().onclick = ()=>{ ckRenderStep1(); ckGoStep(2); };

  if (CK.prev2()) CK.prev2().onclick = ()=>{ ckGoStep(1); };
  if (CK.next2()) CK.next2().onclick = ()=>{ ckGoStep(3); ckSyncTotalsOnSteps(); };

  if (CK.prev3()) CK.prev3().onclick = ()=>{ ckGoStep(2); };
})();

/* ==== Hook: sempre que calcularTotal rodar, manter passo 1/3 coerentes ==== */
if (typeof calcularTotal === 'function') {
  const _orig = calcularTotal;
  calcularTotal = function(){
    _orig();
    ckSyncTotalsOnSteps();
    // se o checkout estiver aberto, atualiza tela
    if (window.ckOpen) {
      if (window.ckStep === 1) ckRenderStep1();
      if (window.ckStep === 3) { if (typeof ckEnsurePixReady === 'function') ckEnsurePixReady(true); }
    }
  };
}

/* ==== Inicializa render do passo 1 quando o modal abrir ==== */
/* Se você já chama ckOpenModal() em outro ponto, garanta que ele
   faça: ckRenderStep1(); ckSyncTotalsOnSteps(); */
if (CK.modal()) {
  // fallback: se a página já tiver itens selecionados e o modal estiver visível
  if (!CK.modal().hasAttribute('hidden')) {
    ckRenderStep1();
    ckSyncTotalsOnSteps();
  }
}
/* =================== FIM JS — PARTE 3 =================== */


  
/* ===================== JS — PARTE 4 ===================== */
/* PIX (payload BR Code + QR + copiar + abas)               */
/* + validação do Passo 2 e envio (FormSubmit + GAS)        */
/* Cole este bloco DEPOIS da Parte 3 do JS                  */
/* ======================================================== */

/* ---------- Utilitários PIX (definidos se não existirem) ---------- */
if (typeof window.ck_crc16_ccitt_ffff !== 'function') {
  window.ck_crc16_ccitt_ffff = function(data){
    let crc=0xFFFF;
    for(let i=0;i<data.length;i++){
      let x=((crc>>8)^data.charCodeAt(i))&0xff;
      x^=x>>4;
      crc=(crc<<8)^(x<<12)^(x<<5)^x;
    }
    crc&=0xFFFF;
    return crc.toString(16).toUpperCase().padStart(4,'0');
  };
}

if (typeof window.ck_gerarBRCode !== 'function') {
  window.ck_gerarBRCode = function(valor){
    const chavePix="betshoptv@gmail.com";               // sua chave
    const nome="BET SHOP TV".substring(0,25).toUpperCase();
    const cidade="SAO PAULO".substring(0,15).toUpperCase();
    const txid="***";
    const f=(id,val)=> id + String(val.length).padStart(2,'0') + val;

    let pl="000201";
    pl+=f('26',`0014BR.GOV.BCB.PIX01${String(chavePix.length).padStart(2,'0')}${chavePix}`);
    pl+='52040000';
    pl+='5303986';
    pl+=f('54', Number(Math.floor(valor||0)).toFixed(2)); // campo 54 precisa de 2 casas
    pl+='5802BR';
    pl+=f('59',nome);
    pl+=f('60',cidade);
    pl+=f('62', f('05',txid));
    pl+='6304';
    return pl + ck_crc16_ccitt_ffff(pl);
  };
}

/* ---------- Render/atualização do PIX no Passo 3 ---------- */
if (typeof window.ckEnsurePixReady !== 'function') {
  window.ckEnsurePixReady = function(force=false){
    const totalInt = Math.floor((window.totalGeral||0));
    // espelha total nos elementos do passo 3 (se existirem)
    if (CK.t3())  CK.t3().textContent  = 'R$ ' + totalInt;
    if (CK.t3b()) CK.t3b().textContent = 'R$ ' + totalInt;

    // payload
    const payload = ck_gerarBRCode(totalInt);
    const holder  = CK.pixPayload();
    if (holder) holder.textContent = payload;

    // QRCode (usa a lib qrcodejs que você carrega no final da página)
    const qrBox = CK.pixQR();
    if (qrBox) {
      if (force) qrBox.innerHTML = '';
      if (qrBox.childElementCount === 0 && window.QRCode) {
        new QRCode(qrBox, {
          text: payload,
          width: 160, height: 160,
          correctLevel: QRCode.CorrectLevel.M
        });
      }
    }

    // Botão “PIX Copia e Cola”
    const btnCopy = CK.pixCopy();
    if (btnCopy && !btnCopy._ckBound) {
      btnCopy._ckBound = true;
      btnCopy.addEventListener('click', ()=>{
        const text = holder ? holder.textContent : payload;
        const done = (ok)=>{
          const old = btnCopy.textContent;
          btnCopy.textContent = ok ? 'PIX copiado!' : 'Erro ao copiar';
          setTimeout(()=> btnCopy.textContent = old, 1600);
        };
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(text).then(()=>done(true)).catch(()=>done(false));
        } else {
          const ta=document.createElement('textarea');
          ta.value=text; ta.style.position='fixed'; ta.style.top='-9999px';
          document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); done(true); } catch(e){ done(false); }
          document.body.removeChild(ta);
        }
      });
    }

    // Abas (PIX / PayPal)
    const tabPix  = CK.tabPix(), tabPP = CK.tabPP();
    const panePix = CK.panePix(), panePP = CK.panePP();
    if (tabPix && !tabPix._ckBound) {
      tabPix._ckBound = true;
      tabPix.onclick = ()=>{
        tabPix.setAttribute('aria-selected','true');
        tabPP?.setAttribute('aria-selected','false');
        panePix?.setAttribute('aria-hidden','false');
        panePP?.setAttribute('aria-hidden','true');
      };
    }
    if (tabPP && !tabPP._ckBound) {
      tabPP._ckBound = true;
      tabPP.onclick = ()=>{
        tabPP.setAttribute('aria-selected','true');
        tabPix?.setAttribute('aria-selected','false');
        panePP?.setAttribute('aria-hidden','false');
        panePix?.setAttribute('aria-hidden','true');
      };
    }
  };
}

/* ---------- Validação do Passo 2 ---------- */
if (typeof window.ckValidateStep2 !== 'function') {
  window.ckValidateStep2 = function(){
    const nome  = (CK.fNome()?.value || '').trim();
    const email = (CK.fEmail()?.value || '').trim();
    if (!nome || !email) {
      alert('Preencha nome e e-mail.');
      return null;
    }
    return { nome, email, fone: (CK.fFone()?.value || '').trim() };
  };
}

/* ---------- Preencher hidden form antes de enviar ---------- */
if (typeof window.ckFillHiddenForm !== 'function') {
  window.ckFillHiddenForm = function(nome, email, fone){
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
    set('fNome',     String(nome||'').trim());
    set('fEmail',    String(email||'').trim());
    set('fTelefone', String(fone||'').trim());
    set('fPecas',    [...(window.selecionadas||new Set())].join(','));
    set('fRifas',    [...(window.rifasSel||new Set())].join(','));
    set('fFav',      [...(window.favoritos||new Set())].join(','));
    set('fTotal',    Number(Math.floor(window.totalGeral||0)).toFixed(2)); // 2 casas para GAS/FormSubmit
  };
}

/* ---------- Botão “Avançar” do passo 2 deve validar ---------- */
(function ensureNext2Valid(){
  const nxt = CK.next2();
  if (!nxt || nxt._ckBound) return;
  nxt._ckBound = true;

  const original = nxt.onclick;
  nxt.onclick = ()=>{
    const ok = ckValidateStep2();
    if (!ok) return;                       // fica no passo 2
    if (typeof original === 'function') original();
    else { ckGoStep(3); ckEnsurePixReady(true); }
  };
})();

/* ---------- Botão “Confirmar” (passo 3) envia GAS + FormSubmit ---------- */
(function bindFinish(){
  const btn = CK.finish();
  if (!btn || btn._ckBound) return;
  btn._ckBound = true;

  btn.onclick = async ()=>{
    const v = ckValidateStep2();
    if (!v) { ckGoStep(2); return; }

    // preenche form oculto (FormSubmit)
    ckFillHiddenForm(v.nome, v.email, v.fone);

    // backup GAS (best-effort; não bloqueia fluxo)
    try {
      if (typeof GAS_URL === 'string' && GAS_URL) {
        const fd = new FormData();
        fd.append('nome', v.nome);
        fd.append('email', v.email);
        fd.append('telefone', v.fone);
        fd.append('pecas', [...(window.selecionadas||new Set())].join(','));
        fd.append('rifas', [...(window.rifasSel||new Set())].join(','));
        fd.append('favoritas', [...(window.favoritos||new Set())].join(','));
        fd.append('total', Number(Math.floor(window.totalGeral||0)).toFixed(2));
        fetch(GAS_URL, { method:'POST', body:fd, mode:'no-cors' }).catch(()=>{});
      }
    } catch(e) {
      console.warn('Falha no backup GAS (seguindo com FormSubmit):', e);
    }

    // envia FormSubmit (redireciona para _next)
    const form = document.getElementById('hiddenForm');
    if (form) form.submit();
  };
})();

/* ---------- Quando abrir o passo 3, garantir PIX pronto ---------- */
(function onEnterStep3EnsurePix(){
  // se você chama ckGoStep(3) em outro lugar, cuide de chamar ckEnsurePixReady();
  if (CK.s3() && CK.s3().hidden === false) {
    ckEnsurePixReady(true);
  }
})();

/* =================== FIM JS — PARTE 4 =================== */

/* ===================== JS — PARTE 5 ===================== */
/* Cola DEPOIS da Parte 4. É o “glue final” do checkout.   */
/* - Integra calcularTotal() com o modal aberto             */
/* - Garante CTA abre/fecha corretamente                    */
/* - Fechamento por overlay e tecla ESC                     */
/* - Proteções contra dupla ligação de eventos              */
/* ======================================================== */

(function CK_GLUE_FINAL(){
  if (window.__ckGlueApplied) return;
  window.__ckGlueApplied = true;

  /* --- 1) Garantir que o CTA do rodapé reflita o estado e abra o modal --- */
  function ckUpdateFooterCTA(){
    try {
      const btn  = document.getElementById('ctaMain');
      const pill = document.getElementById('pillCompact');
      const footer = document.querySelector('footer');
      const hasTotal = (window.totalGeral||0) > 0;

      if (btn){
        if (hasTotal){
          btn.disabled = false;
          // fmt() já remove decimais
          btn.textContent = 'APOSTAR ' + (typeof fmt==='function' ? fmt(window.totalGeral) : ('R$ '+Math.floor(window.totalGeral)));
        } else {
          btn.disabled = true;
          btn.textContent = 'FAÇAM SUAS APOSTAS!';
        }
      }
      if (footer){
        footer.classList.toggle('has-total',  hasTotal);
        footer.classList.toggle('no-total',  !hasTotal);
      }
      if (pill){
        const parts = [];
        if (window.selecionadas?.size) parts.push(window.selecionadas.size + ' ' + (window.selecionadas.size===1?'Peça':'Peças'));
        if (window.rifasSel?.size)     parts.push(window.rifasSel.size     + ' ' + (window.rifasSel.size===1?'Rifa':'Rifas'));
        if (window.favoritos?.size)    parts.push(window.favoritos.size    + ' ' + (window.favoritos.size===1?'Favorita':'Favoritas'));
        pill.textContent = parts.join(' · ');
        pill.style.display = parts.length ? 'inline-block' : 'none';
      }
    } catch(e){}
  }

  // Liga o CTA uma única vez
  (function bindFooterCTA(){
    const btn = document.getElementById('ctaMain');
    const overlay = (typeof CK!=='undefined' && CK.overlay) ? CK.overlay() : document.getElementById('checkoutOverlay');
    const modal   = (typeof CK!=='undefined' && CK.modal)   ? CK.modal()   : document.getElementById('checkoutModal');
    if (!btn || !overlay || !modal) return;

    if (!btn.__ckBound){
      btn.__ckBound = true;
      btn.addEventListener('click', (e)=>{
        if ((window.totalGeral||0) <= 0) return;
        if (typeof ckOpenModal==='function') ckOpenModal();
      });
    }

    // Fechar clicando no overlay
    if (!overlay.__ckBound){
      overlay.__ckBound = true;
      overlay.addEventListener('click', ()=>{
        if (typeof ckCloseModal==='function') ckCloseModal();
      });
    }

    // Botão "Fechar" do modal
    if (typeof CK==='object' && CK.close && CK.close() && !CK.close().__ckBound){
      CK.close().__ckBound = true;
      CK.close().addEventListener('click', ()=>{
        if (typeof ckCloseModal==='function') ckCloseModal();
      });
    }
  })();

  /* --- 2) ESC para fechar quando aberto --- */
  (function bindEscClose(){
    if (window.__ckEscBound) return;
    window.__ckEscBound = true;
    document.addEventListener('keydown', (ev)=>{
      if (ev.key === 'Escape' && window.ckOpen && typeof ckCloseModal==='function'){
        ev.preventDefault();
        ckCloseModal();
      }
    });
  })();

  /* --- 3) Hook em calcularTotal(): atualiza CTA e, se modal aberto, sincronia dos passos --- */
  if (typeof window.calcularTotal === 'function' && !window.__ckTotalHooked){
    window.__ckTotalHooked = true;
    const __oldCalc = window.calcularTotal;
    window.calcularTotal = function(){
      __oldCalc();
      // CTA/pills sempre coerentes
      ckUpdateFooterCTA();

      // Se modal estiver aberto, atualizar totais e, se necessário, redesenhar Passo 1/PIX
      try{
        if (window.ckOpen){
          if (typeof ckSyncTotalsOnSteps==='function') ckSyncTotalsOnSteps();
          if (typeof CK==='object' && CK.s1 && CK.s3){
            if (CK.s1() && CK.s1().hidden === false && typeof ckRenderStep1==='function'){
              ckRenderStep1();
            }
            if (CK.s3() && CK.s3().hidden === false && typeof ckEnsurePixReady==='function'){
              ckEnsurePixReady(true);
            }
          }
        }
      }catch(e){}
    };
  } else {
    // Se calcularTotal ainda não existir (caso raro), tenta atualizar CTA periodicamente até existir.
    if (!window.__ckWatchTotal){
      window.__ckWatchTotal = true;
      const t = setInterval(()=>{
        if (typeof window.calcularTotal === 'function'){
          clearInterval(t);
          // força UMA atualização de CTA
          ckUpdateFooterCTA();
        }
      }, 300);
    }
  }

  /* --- 4) Força 1ª atualização do CTA depois que a página monta --- */
  (function afterFirstPaint(){
    // tenta depois de um pequeno atraso (após init carregar JSONs)
    setTimeout(ckUpdateFooterCTA, 600);
  })();

  /* --- 5) Se por algum motivo modal abrir sem travar o scroll, corrige --- */
  (function ensureScrollLock(){
    const ov = (typeof CK==='object' && CK.overlay) ? CK.overlay() : document.getElementById('checkoutOverlay');
    const md = (typeof CK==='object' && CK.modal)   ? CK.modal()   : document.getElementById('checkoutModal');
    const apply = ()=>{
      const open = ov && !ov.hasAttribute('hidden') && md && !md.hasAttribute('hidden');
      document.documentElement.classList.toggle('ck-open', open);
      document.body.classList.toggle('ck-open', open);
    };
    if (ov && !ov.__ckObs){
      ov.__ckObs = true;
      const obs = new MutationObserver(apply);
      obs.observe(ov, { attributes:true, attributeFilter:['hidden'] });
    }
    if (md && !md.__ckObs){
      md.__ckObs = true;
      const obs = new MutationObserver(apply);
      obs.observe(md, { attributes:true, attributeFilter:['hidden'] });
    }
  })();

  // Exponho opcionalmente para debug simples no console
  window.ckDebug = Object.assign(window.ckDebug||{}, {
    ping:'ok', open:()=>typeof ckOpenModal==='function'&&ckOpenModal(),
    close:()=>typeof ckCloseModal==='function'&&ckCloseModal()
  });
})();

  
</script>

    


    
</body>
</html>
